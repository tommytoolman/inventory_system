# Handover Document — 14 February 2026

## Session Summary

Two back-to-back sessions focused on fixing the **REFRESH flow** for stale listings (products >3 months old) and all the cascading bugs it exposed. The refresh ends old listings on Reverb/eBay/VR, creates new ones with new IDs, and updates local DB records. Shopify is excluded from refresh for SEO preservation.

---

## What Was Fixed

### 1. `scalar_one_or_none()` Crashes (MultipleResultsFound)

**Root cause:** After refresh, each `platform_common` entry has TWO `_listings` rows (old=ended + new=active). Any query using `scalar_one_or_none()` without a state filter crashes.

**Fix pattern:** Add state filter to every query that joins to listing tables:
- Reverb: `AND rl.reverb_state = 'live'`
- eBay: `AND el.listing_status = 'ACTIVE'`
- VR: `AND vl.vr_state = 'active'`

**Files fixed (all queries now filtered):**

| File | Locations Fixed |
|------|----------------|
| `app/routes/inventory.py` | `_fetch_current_platform_prices` (line ~244), `edit_product_form` (lines ~5654-5686), eBay category lookup (line ~3270), rollback code (lines ~4372, ~4389) |
| `app/services/sync_services.py` | `_get_local_platform_data` Reverb/eBay/VR JOINs (lines ~2407-2442), price update writes (lines ~2008, 2020, 2069), inventory qty sync (line ~1625) |
| `app/services/ebay_service.py` | `apply_product_update` (line ~2502), `_fetch_existing_ebay_data` (line ~2580) |
| `app/services/reverb_service.py` | `apply_product_update` (line ~1553), `_fetch_local_live_reverb_ids` (line ~2921) |
| `app/services/event_processor.py` | 5 fixes at lines ~498, 673, 848, 1199, 1677 |
| `app/services/order_sale_processor.py` | 2 fixes at lines ~268, 280 |
| `app/services/vintageandrare/client.py` | 1 fix at line ~1952 |
| `app/services/vr_service.py` | `_fetch_existing_vr_data` (line ~1213) |

### 2. Reverb `end_listing()` Using Wrong API Endpoint

**Root cause:** `reverb_service.end_listing()` used `client.update_listing(id, {"state": "ended"})` which is a generic PUT that ignores state changes.

**Fix:** Changed to use `client.end_listing(id)` which calls the correct `PUT /my/listings/{id}/state/end` endpoint.

**File:** `app/services/reverb_service.py` — `end_listing()` method (line ~1650)

### 3. Phantom Sync Events After Refresh

**Three separate bugs in the nightly sync were generating false events:**

#### 3a. `_get_local_platform_data` Reverb JOIN was broken
- **Was:** `LEFT JOIN reverb_listings rl ON CONCAT('REV-', pc.external_id) = rl.reverb_listing_id` (never matched)
- **Now:** `LEFT JOIN reverb_listings rl ON rl.platform_id = pc.id AND rl.reverb_state = 'live'`
- **File:** `app/services/sync_services.py` (line ~2418)

#### 3b. `_detect_new_listings` flagged old listing IDs as new
- **Fix:** Added `_is_known_old_listing()` method that checks listing tables before flagging
- **File:** `app/services/sync_services.py`

#### 3c. `_detect_status_changes` comparing wrong types
- Reverb API returns `state` as dict `{'slug': 'live', 'description': 'Live'}` — code was comparing dict to string
- Local status used `pc.status` ('active') instead of platform-specific field (`reverb_state`, `listing_status`, `vr_state`)
- **File:** `app/services/sync_services.py` — `_detect_status_changes()` (lines ~2470-2491)

### 4. `_fetch_local_live_reverb_ids()` Unfiltered JOIN (TODAY's main fix)

**Root cause:** The Reverb sync import (`run_import_process`) used `_fetch_local_live_reverb_ids()` which had an unfiltered LEFT JOIN to `reverb_listings`. After refresh, two rows returned per platform_common, and the dict comprehension kept the last one — which could be the `ended` row. This made the sync think the listing was locally "ended" while the API showed "live", generating phantom `status_change` events every sync cycle.

**Fix:** Added `AND rl.reverb_state = 'live'` to the JOIN.

**File:** `app/services/reverb_service.py` line ~2921

### 5. eBay `listing_status` Case Mismatch

**Root cause:** Original eBay import wrote lowercase (`active`, `ended`, `sold`). All state filter queries used uppercase (`ACTIVE`, `ENDED`). Result: 566 of 579 eBay listings were invisible to filtered queries.

**Fixes applied:**
1. **DB normalized:** `UPDATE ebay_listings SET listing_status = UPPER(listing_status)` — 851 rows updated
2. **Write locations fixed to uppercase:**
   - `ebay_service.py:2159` — `'ended'` → `'ENDED'`
   - `ebay_service.py:2624-2628` — `status_mapping` values → `'ACTIVE'`, `'SOLD'`, `'ENDED'`
3. **Safety net:** `_fetch_existing_ebay_data` JOIN uses `UPPER(el.listing_status) = 'ACTIVE'`

### 6. VR Pricing Not Applied During Refresh

Added `calculate_platform_price("vr", ...)` to the VR create call in the refresh flow.

**File:** `app/routes/inventory.py` (line ~2831)

### 7. Shopify Listing Status Mismatch (Product 49)

**Product 49** (Celestion 12" Speaker ex Noel Gallagher, `REV-90953070`) was refreshed before full fixes were applied. `platform_common.status = 'active'` but `shopify_listings.status = 'ended'`.

**Fix:** Updated `shopify_listings` id=48 status to `'active'`.

---

## Current Platform Counts (Verified)

| Platform | platform_common (active) | listings (active) |
|----------|--------------------------|-------------------|
| Reverb   | 579                      | 579               |
| Shopify  | 580                      | 580               |
| eBay     | 579                      | 579               |
| VR       | 535                      | 535               |

---

## Known Issues / Not Yet Fixed

### 1. Shopify Refresh Flow — `shopify_listings.status` Not Updated Back to Active

The root cause of the Product 49 issue. When the Shopify refresh flow creates a new listing, it marks the old `shopify_listings` row as `'ended'` but does not create/update the row back to `'active'` for the new listing. The `platform_common` gets updated by the service's upsert, but the specialist table doesn't.

**Needs investigation in:** `app/routes/inventory.py` — the Shopify section of the refresh flow and `app/services/shopify/` service methods.

### 2. Product 1049 (Vox AC30 Extension Cabinet)

Has two ENDED eBay listings (257358865932, 257358832834). Both are dead so no active conflict, but indicates a double-listing occurred at some point. Low priority.

### 3. Remaining Audit: Are There More Unfiltered JOINs?

We've fixed every instance found so far, but any new code touching listing tables should always include the state filter. Grep for:
```
LEFT JOIN reverb_listings.*ON.*platform_id
LEFT JOIN ebay_listings.*ON.*platform_id
LEFT JOIN vr_listings.*ON.*platform_id
```
And verify each has the appropriate state filter.

---

## Key Domain Knowledge

### Reverb Relist vs eBay Relist
- **Reverb:** Relisting keeps the SAME item ID. The listing goes `ended → live` on the same ID.
- **eBay:** Relisting creates a NEW item ID. Old listing gets a new ID, old one stays ended.

### Refresh Flow (inventory.py ~line 2571)
1. Ends old listings on Reverb/eBay/VR
2. Updates product SKU with `-R1` suffix (Reverb requires unique SKUs): `REV-91729014` → `REV-91729014-R1`
3. Marks eBay/VR `platform_common.status = 'ended'`
4. Creates new listings — service upserts `platform_common` back to `active` with new `external_id`
5. Old `_listings` rows remain with `ended` state; new rows created with `active`/`live` state
6. Shopify is EXCLUDED (SEO preservation)

### State Values by Platform
| Platform | Active State | Ended State |
|----------|-------------|-------------|
| Reverb   | `live`      | `ended`     |
| eBay     | `ACTIVE`    | `ENDED`     |
| VR       | `active`    | varies      |
| Shopify  | `active`    | `ended`     |
| platform_common | `active` | `ended` |

### Pricing Markups
- `app/services/pricing.py:calculate_platform_price()`
- Reverb: 5%, eBay: 10%, VR: 5%, Shopify: 0%

### Sync Architecture
The nightly sync has TWO separate code paths:
1. **`ChangeDetector` class** (`sync_services.py:2340`) — generic change detection using `_get_local_platform_data` + `_detect_status_changes` etc. Used by the `SyncOrchestrator`.
2. **Platform-specific `run_import_process`** methods — e.g., `reverb_service.run_import_process()` (line ~2523) has its own comparison logic using `_fetch_local_live_reverb_ids()`. This is what the scheduler actually calls.

Both paths needed the state filter fixes.

---

## Files Modified This Session

- `app/services/reverb_service.py` — end_listing fix, _fetch_local_live_reverb_ids state filter, apply_product_update filter
- `app/services/ebay_service.py` — apply_product_update filter, _fetch_existing_ebay_data filter, listing_status case fixes
- `app/services/vr_service.py` — _fetch_existing_vr_data state filter
- `app/services/sync_services.py` — _get_local_platform_data JOINs, _detect_status_changes fixes, _detect_new_listings guard, price update filters, inventory qty filter
- `app/services/event_processor.py` — 5 state filter fixes
- `app/services/order_sale_processor.py` — 2 state filter fixes
- `app/services/vintageandrare/client.py` — 1 state filter fix
- `app/routes/inventory.py` — _fetch_current_platform_prices, edit_product_form, category lookup, rollback code, VR pricing in refresh

## Recommended Next Steps

### Make Status Mismatches More Visible
The `/reports/status-mismatches` report exists but is passive — it caught a rogue eBay listing (Product 812, Vox AC2 Fawn 1962) that stayed ACTIVE after Reverb ended. Three options to make these unmissable:

1. **Dashboard badge** — red counter on nav showing mismatch count, visible on every page load
2. **Post-sync WebSocket alert** — when nightly sync completes, check mismatch count and surface in the notification
3. **Cross-platform mismatch sync_events (recommended)** — when a listing ends on one platform, immediately check sibling platforms and create a `change_type = 'cross_platform_mismatch'` sync_event so it appears in the actionable queue

### Shopify Refresh Flow — Specialist Table Not Updated
Product 49 (Celestion Speaker) showed `shopify_listings.status = 'ended'` while `platform_common.status = 'active'` after a pre-fix refresh. The Shopify path in the refresh flow needs the same treatment as Reverb/eBay/VR — ensure the specialist table row is updated back to active after the new listing is created.

## Successfully Tested Refreshes

- Product 37 (Fender Precision Bass 1975)
- Product 386 (Gibson B25 12 String 1960s)
- Product 7 (Gibson Chet Atkins SST)
