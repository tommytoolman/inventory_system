{% extends "base.html" %}

{% block title %}Add Product - Realtime Inventory Forms Flow{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-white rounded-lg shadow-lg overflow-hidden max-w-5xl mx-auto">
        <div class="px-6 py-4 bg-gray-50 border-b">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-900">Add New Product</h1>
                <a href="/inventory" class="text-blue-600 hover:text-blue-800">Back to List</a>
            </div>
        </div>

        <!-- Copy from Existing Product -->
        <div class="px-6 py-4 bg-blue-50 border-b">
            <div class="flex items-center space-x-4">
                <label class="text-sm font-medium text-gray-700 whitespace-nowrap">Copy from Existing:</label>
                <select id="existingProduct" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="">-- Select a product --</option>
                    {% for product in existing_products|sort(attribute='brand') %}
                    <option value="{{ product.id }}">
                        {{ product.brand or "Unknown Brand" }} 
                        {{ (product.model or "")|truncate(55) }}
                    </option>
                    {% endfor %}
                </select>
                <button type="button" id="copyButton" 
                    class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Copy Details
                </button>
                <div class="ml-4 text-sm text-gray-600">
                    <span id="copyStatus"></span>
                </div>
            </div>
        </div>

        <!-- Error Messages (if any) -->
        {% if error %}
        <div class="p-4">
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                <span class="block sm:inline">{{ error }}</span>
            </div>
        </div>
        {% endif %}

        <form
            method="POST" 
            action="/inventory/add"
            enctype="multipart/form-data" 
            class="p-6 space-y-6"
            id="addProductForm"
            >

            <!-- Form Sections -->
            <div class="space-y-6">

                <!-- Basic Info Section -->
                <div class="form-section">
                    <button type="button" 
                        class="form-section-header flex justify-between items-center w-full py-2 px-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                        <span class="text-lg font-medium">Basic Information</span>
                        <svg class="form-section-icon w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div class="form-section-content p-4 border rounded-lg mt-2">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Brand</label>
                                <input type="text" name="brand" id="brand" required
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                    value="{{ form_data.brand if form_data else '' }}">
                                <datalist id="brandsList">
                                    {% for brand in existing_brands %}
                                    <option value="{{ brand }}">
                                    {% endfor %}
                                </datalist>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Model</label>
                                <input type="text" name="model" id="model" required
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                    value="{{ form_data.model if form_data else '' }}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">SKU</label>
                                <div class="flex">
                                    <input type="text" name="sku" id="sku" required
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                        value="{{ form_data.sku if form_data else '' }}">
                                    <button type="button" id="generateSku"
                                        class="ml-2 px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300"
                                        title="Generate SKU">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Year</label>
                                <input type="number" name="year" id="year"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                    value="{{ form_data.year if form_data else '' }}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Decade</label>
                                <select name="decade" id="decade"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="">-- Select Decade --</option>
                                    {% for decade in range(1920, 2030, 10) %}
                                    <option value="{{ decade }}">{{ decade }}s</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Category</label>
                                <input type="text" name="category" id="category" required list="categoriesList"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                    value="{{ form_data.category if form_data else '' }}">
                                <datalist id="categoriesList">
                                    {% for category in categories %}
                                    <option value="{{ category }}">
                                    {% endfor %}
                                </datalist>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Finish</label>
                                <input type="text" name="finish" id="finish"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                    value="{{ form_data.finish if form_data else '' }}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Description & Condition Section -->
                <div class="form-section">
                    <button type="button" 
                        class="form-section-header flex justify-between items-center w-full py-2 px-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                        <span class="text-lg font-medium">Description & Condition</span>
                        <svg class="form-section-icon w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div class="form-section-content p-4 border rounded-lg mt-2">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Description</label>
                                <textarea name="description" id="description" rows="6"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">{{ form_data.description if form_data else '' }}</textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Condition</label>
                                    <select name="condition" id="condition" required
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="NEW" {% if form_data and form_data.condition == 'NEW' %}selected{% endif %}>NEW</option>
                                        <option value="EXCELLENT" {% if form_data and form_data.condition == 'EXCELLENT' %}selected{% endif %}>EXCELLENT</option>
                                        <option value="VERY_GOOD" {% if form_data and form_data.condition == 'VERY_GOOD' %}selected{% endif %}>VERY GOOD</option>
                                        <option value="GOOD" {% if form_data and form_data.condition == 'GOOD' %}selected{% endif %}>GOOD</option>
                                        <option value="FAIR" {% if form_data and form_data.condition == 'FAIR' %}selected{% endif %}>FAIR</option>
                                        <option value="POOR" {% if form_data and form_data.condition == 'POOR' %}selected{% endif %}>POOR</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Status</label>
                                    <select name="status" id="status" required
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="DRAFT" {% if form_data and form_data.status == 'DRAFT' %}selected{% endif %}>Draft</option>
                                        <option value="ACTIVE" {% if form_data and form_data.status == 'ACTIVE' %}selected{% endif %}>Active</option>
                                        <option value="ARCHIVED" {% if form_data and form_data.status == 'ARCHIVED' %}selected{% endif %}>Archived</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pricing & Inventory Section -->
                <div class="form-section">
                    <button type="button" 
                        class="form-section-header flex justify-between items-center w-full py-2 px-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                        <span class="text-lg font-medium">Pricing & Inventory</span>
                        <svg class="form-section-icon w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div class="form-section-content p-4 border rounded-lg mt-2">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Base Price</label>
                                <div class="mt-1 relative rounded-md shadow-sm">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <span class="text-gray-500 sm:text-sm">£</span>
                                    </div>
                                    <input type="text" name="base_price_display" id="base_price_display" 
                                        class="pl-7 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                        value="{{ form_data.base_price if form_data else '' }}">
                                    <!-- Hidden field to store the actual numeric value -->
                                    <input type="hidden" name="base_price" id="base_price" value="{{ form_data.base_price if form_data else '' }}">
                                </div>
                            </div>
                            <!-- Hidden fields to keep backend compatibility -->
                            <input type="hidden" name="cost_price" id="cost_price" value="{{ form_data.cost_price if form_data else '' }}">
                            <input type="hidden" name="processing_time" id="processing_time" value="{{ form_data.processing_time if form_data else '3' }}">
                            <input type="hidden" name="collective_discount" id="collective_discount" value="{{ form_data.collective_discount if form_data else '0' }}">
                            <input type="hidden" name="offer_discount" id="offer_discount" value="{{ form_data.offer_discount if form_data else '0' }}">
                        </div>
                        
                        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="flex items-center">
                                <input type="checkbox" name="in_collective" id="in_collective"
                                    class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                    {% if form_data and form_data.in_collective %}checked{% endif %}>
                                <label for="in_collective" class="ml-2 block text-sm text-gray-700">In Collective</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" name="in_inventory" id="in_inventory"
                                    class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                    {% if form_data and form_data.in_inventory %}checked{% endif %} checked>
                                <label for="in_inventory" class="ml-2 block text-sm text-gray-700">In Inventory</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" name="free_shipping" id="free_shipping"
                                    class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                    {% if form_data and form_data.free_shipping %}checked{% endif %}>
                                <label for="free_shipping" class="ml-2 block text-sm text-gray-700">Free Shipping</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" name="buy_now" id="buy_now"
                                    class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                    {% if form_data and form_data.buy_now %}checked{% endif %} checked>
                                <label for="buy_now" class="ml-2 block text-sm text-gray-700">Buy Now</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" name="show_vat" id="show_vat"
                                    class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                    {% if form_data and form_data.show_vat %}checked{% endif %} checked>
                                <label for="show_vat" class="ml-2 block text-sm text-gray-700">Show VAT</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" name="local_pickup" id="local_pickup"
                                    class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                    {% if form_data and form_data.local_pickup %}checked{% endif %}>
                                <label for="local_pickup" class="ml-2 block text-sm text-gray-700">Local Pickup</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" name="available_for_shipment" id="available_for_shipment"
                                    class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                    {% if form_data and form_data.available_for_shipment %}checked{% endif %} checked>
                                <label for="available_for_shipment" class="ml-2 block text-sm text-gray-700">Available for Shipment</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Images & Media Section -->
                <div class="form-section">
                    <button type="button" 
                        class="form-section-header flex justify-between items-center w-full py-2 px-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                        <span class="text-lg font-medium">Images & Media</span>
                        <svg class="form-section-icon w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                <div class="form-section-content p-4 border rounded-lg mt-2">
                    <div class="accordion-content bg-white p-4 border-t border-gray-200">
                        <div class="grid grid-cols-1 gap-6">
                            <div class="col-span-1">
                                <div class="mt-2">
                                    <div class="flex space-x-4 mb-4">
                                        <button type="button" id="tab-dropbox" class="tab-button px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md active-tab">
                                             Dropbox 
                                        </button>
                                        <button type="button" id="tab-upload" class="tab-button px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md">
                                            Upload Files
                                        </button>
                                        <button type="button" id="tab-url" class="tab-button px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md">
                                            Image URLs
                                        </button>
                                    </div>
                                    
                                    <!-- Upload Files Tab -->
                                    <div id="content-upload" class="mt-4">
                                        <div class="mb-4">
                                            <label class="block text-sm font-medium text-gray-700">Upload Images</label>
                                            <input type="file" name="image_files" accept="image/*" multiple class="mt-1 block w-full" id="imageFiles">
                                            <p class="mt-1 text-sm text-gray-500">You can select multiple files. The first image will be used as the main product image.</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Image URLs Tab -->
                                    <div id="content-url" class="mt-4 hidden">
                                        <div class="mb-4">
                                            <label class="block text-sm font-medium text-gray-700">Image URLs</label>
                                            <textarea name="image_urls" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Enter one URL per line. The first URL will be the main product image." id="imageUrls"></textarea>
                                        </div>
                                    </div>
                                    
                                    <!-- Dropbox Tab -->
                                    <div id="content-dropbox" class="mt-4 hidden">
                                        <div class="mb-4">
                                            
                                            <label class="block text-sm font-medium text-gray-700">Select Images from Dropbox</label>
                                            
                                            <!-- Dropbox folder navigation -->
                                            <div class="flex space-x-2 mb-2 items-center">
                                                <button type="button" id="dropbox-back" class="px-2 py-1 text-sm border rounded disabled:opacity-50" disabled>
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                        <path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                                                    </svg>
                                                </button>
                                                <span id="dropbox-current-path" class="px-2 py-1 text-sm text-gray-600 border rounded flex-grow">/</span>
                                                <button type="button" id="dropbox-refresh" class="px-2 py-1 text-sm border rounded">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                                                    </svg>
                                                </button>
                                            </div>
                                            
                                            <!-- Add this right above the dropbox-browser div -->
                                            <div class="flex justify-between items-center mb-2">
                                                <label class="block text-sm font-medium text-gray-700">Browse Images</label>
                                            </div>

                                            <!-- Dropbox folder & file browser -->
                                            <div class="border rounded-md p-2 mt-2 max-h-96 overflow-y-auto w-full" id="dropbox-browser">
                                                <div class="text-center py-8 text-gray-500" id="dropbox-loading">
                                                    <svg class="animate-spin h-6 w-6 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                    </svg>
                                                    Loading Dropbox folders...
                                                </div>
                                                <div id="dropbox-items" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 hidden"></div>
                                                <div class="text-center py-8 text-gray-500 hidden" id="dropbox-empty">
                                                    No folders or images found in this location
                                                </div>
                                                <div class="text-center py-8 text-gray-500 hidden" id="dropbox-error">
                                                    Error loading Dropbox content
                                                </div>
                                            </div>
                                            
                                            <!-- Select All button with proper spacing -->
                                            <div class="flex justify-end mt-3">
                                                <button type="button" 
                                                        id="select-all-images" 
                                                        class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 hidden">
                                                    Select All Images
                                                </button>
                                            </div>
                                            


                                            <!-- Dropbox image selection -->
                                            <!-- <div class="mt-4">
                                                <h4 class="text-sm font-medium text-gray-700 mb-2">Selected Images</h4>
                                                <p class="text-xs text-gray-500 mb-2">Drag to reorder. The first image will be the main product image.</p>
                                                <div id="dropbox-selected-images" class="grid grid-cols-2 md:grid-cols-4 gap-2"> -->
                                                    <!-- Selected images will be displayed here -->
                                                    <!-- <div class="text-center py-4 text-gray-500 col-span-full" id="dropbox-no-selection">
                                                        No images selected yet
                                                    </div>
                                                </div>
                                                
                                                <!-- Hidden inputs to store selected Dropbox images -->
                                                <!-- <input type="hidden" id="primary-image-input" name="primary_image_url">
                                                <input type="hidden" id="additional-images-input" name="additional_images_urls"> -->
                                            <!-- </div> -->
                                        </div>
                                    </div>

                                    <!-- Image Preview with drag and drop -->
                                    <div class="mt-6">
                                        <h3 class="text-md font-medium text-gray-700">Images</h3>
                                        <p class="text-xs text-gray-500 mb-2">Drag to reorder. The first image will be used as the main product image.</p>
                                        <div id="imagePreview" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mt-2 sortable-container">
                                            <!-- Preview images will be inserted here by JavaScript -->
                                        </div>
                                    </div>

                                    <!-- Video URL -->
                                    <div class="mb-4 mt-6">
                                        <label for="video_url" class="block text-sm font-medium text-gray-700">YouTube Video URL</label>
                                        <input type="text" name="video_url" id="video_url" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    
                                    <!-- External Link -->
                                    <div class="mb-4">
                                        <label for="external_link" class="block text-sm font-medium text-gray-700">External Link</label>
                                        <input type="text" name="external_link" id="external_link" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="h-6"></div>

                <!-- Platform-Specific Section -->
                <div class="form-section">
                    <button type="button" 
                        class="form-section-header flex justify-between items-center w-full py-2 px-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                        <span class="text-lg font-medium">Platform Settings</span>
                        <svg class="form-section-icon w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div class="form-section-content p-4 border rounded-lg mt-2">
                        <!-- Platform Tabs -->
                        <div class="mb-4 border-b">
                            <ul class="flex flex-wrap -mb-px" id="platformTabs" role="tablist">
                                <li class="mr-2" role="presentation">
                                    <button class="inline-block py-2 px-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 platform-tab active" 
                                        id="ebay-tab" 
                                        data-target="ebayTabContent" 
                                        type="button" 
                                        role="tab" 
                                        aria-selected="true">
                                        eBay
                                    </button>
                                </li>
                                <li class="mr-2" role="presentation">
                                    <button class="inline-block py-2 px-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 platform-tab" 
                                        id="reverb-tab" 
                                        data-target="reverbTabContent" 
                                        type="button" 
                                        role="tab" 
                                        aria-selected="false">
                                        Reverb
                                    </button>
                                </li>
                                <li class="mr-2" role="presentation">
                                    <button class="inline-block py-2 px-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 platform-tab" 
                                        id="vr-tab" 
                                        data-target="vrTabContent" 
                                        type="button" 
                                        role="tab" 
                                        aria-selected="false">
                                        Vintage & Rare
                                    </button>
                                </li>
                                <li role="presentation">
                                    <button class="inline-block py-2 px-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 platform-tab" 
                                        id="website-tab" 
                                        data-target="websiteTabContent" 
                                        type="button" 
                                        role="tab" 
                                        aria-selected="false">
                                        Website
                                    </button>
                                </li>
                            </ul>
                        </div>

                        <!-- Tab Content -->
                        <div class="tab-content">
                            <!-- eBay Tab Content -->
                            <div id="ebayTabContent" class="tab-pane active">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">eBay Category ID</label>
                                        <input type="text" name="platform_data__ebay__category_id" id="ebay_category_id"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">eBay Format</label>
                                        <select name="platform_data__ebay__format" id="ebay_format"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <option value="FixedPrice">Buy It Now</option>
                                            <option value="Auction">Auction</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">eBay Price</label>
                                        <div class="mt-1 relative rounded-md shadow-sm">
                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <span class="text-gray-500 sm:text-sm">£</span>
                                            </div>
                                            <input type="text" name="platform_data__ebay__price_display" id="ebay_price_display" 
                                                class="pl-7 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <input type="hidden" name="platform_data__ebay__price" id="ebay_price">
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">5% higher than base price</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">eBay Duration</label>
                                        <select name="platform_data__ebay__duration" id="ebay_duration"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <option value="GTC">Good 'Til Cancelled</option>
                                            <option value="Days_30">30 Days</option>
                                            <option value="Days_10">10 Days</option>
                                            <option value="Days_7">7 Days</option>
                                            <option value="Days_5">5 Days</option>
                                            <option value="Days_3">3 Days</option>
                                            <option value="Days_1">1 Day</option>
                                        </select>
                                    </div>
                                    <div class="flex items-center h-full pt-6">
                                        <input type="checkbox" name="platform_data__ebay__sync_inventory" id="ebay_sync_inventory"
                                            class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                        <label for="ebay_sync_inventory" class="ml-2 block text-sm text-gray-700">
                                            Sync inventory with eBay
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Reverb Tab Content -->
                            <div id="reverbTabContent" class="tab-pane hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Reverb Product Type</label>
                                        <select name="platform_data__reverb__product_type" id="reverb_product_type"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <option value="electric">Electric Guitar</option>
                                            <option value="acoustic">Acoustic Guitar</option>
                                            <option value="bass">Bass Guitar</option>
                                            <option value="amp">Amplifier</option>
                                            <option value="effect">Effect Pedal</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Reverb Primary Category</label>
                                        <input type="text" name="platform_data__reverb__primary_category" id="reverb_primary_category"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Reverb Price</label>
                                        <div class="mt-1 relative rounded-md shadow-sm">
                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <span class="text-gray-500 sm:text-sm">£</span>
                                            </div>
                                            <input type="text" name="platform_data__reverb__price_display" id="reverb_price_display" 
                                                class="pl-7 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <input type="hidden" name="platform_data__reverb__price" id="reverb_price">
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">Banner price (£xx9)</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Reverb Shipping Profile</label>
                                        <select name="platform_data__reverb__shipping_profile" id="reverb_shipping_profile"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <option value="default">Default Profile</option>
                                            <option value="free">Free Shipping</option>
                                            <option value="custom">Custom</option>
                                        </select>
                                    </div>
                                    <div class="flex items-center h-full">
                                        <input type="checkbox" name="platform_data__reverb__offers_enabled" id="reverb_offers_enabled"
                                            class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                        <label for="reverb_offers_enabled" class="ml-2 block text-sm text-gray-700">
                                            Enable offers
                                        </label>
                                    </div>
                                    <div class="flex items-center h-full">
                                        <input type="checkbox" name="platform_data__reverb__draft_mode" id="reverb_draft_mode"
                                            class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                        <label for="reverb_draft_mode" class="ml-2 block text-sm text-gray-700">
                                            Create as draft (not live)
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Vintage & Rare Tab Content -->
                            <div id="vrTabContent" class="tab-pane hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">V&R Category</label>
                                        <select name="platform_data__vr__category" id="vr_category"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <option value="electric-guitars">Electric Guitars</option>
                                            <option value="acoustic-guitars">Acoustic Guitars</option>
                                            <option value="bass-guitars">Bass Guitars</option>
                                            <option value="amplifiers">Amplifiers</option>
                                            <option value="effects">Effects</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">V&R Featured Option</label>
                                        <select name="platform_data__vr__featured" id="vr_featured"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <option value="none">None</option>
                                            <option value="featured">Featured</option>
                                            <option value="premium">Premium Featured</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">V&R Price</label>
                                        <div class="mt-1 relative rounded-md shadow-sm">
                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <span class="text-gray-500 sm:text-sm">£</span>
                                            </div>
                                            <input type="text" name="platform_data__vr__price_display" id="vr_price_display" 
                                                class="pl-7 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <input type="hidden" name="platform_data__vr__price" id="vr_price">
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">5% higher than base price</p>
                                    </div>
                                    <div class="col-span-2">
                                        <label class="block text-sm font-medium text-gray-700">V&R Special Notes</label>
                                        <textarea name="platform_data__vr__notes" id="vr_notes" rows="3"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Website Tab Content -->
                            <div id="websiteTabContent" class="tab-pane hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Website Category</label>
                                        <select name="platform_data__website__category" id="website_category"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <option value="guitars">Guitars</option>
                                            <option value="basses">Basses</option>
                                            <option value="amps">Amplifiers</option>
                                            <option value="effects">Effects</option>
                                            <option value="accessories">Accessories</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Website Display Priority</label>
                                        <select name="platform_data__website__priority" id="website_priority"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <option value="0">Normal</option>
                                            <option value="1">Featured</option>
                                            <option value="2">Homepage Featured</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Website Price</label>
                                        <div class="mt-1 relative rounded-md shadow-sm">
                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <span class="text-gray-500 sm:text-sm">£</span>
                                            </div>
                                            <input type="text" name="platform_data__website__price_display" id="website_price_display" 
                                                class="pl-7 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <input type="hidden" name="platform_data__website__price" id="website_price">
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">Same as base price</p>
                                    </div>
                                    <div class="col-span-2">
                                        <label class="block text-sm font-medium text-gray-700">
                                            SEO Keywords (comma separated)
                                            <button type="button" id="generate-seo" class="ml-2 px-2 py-1 text-xs bg-gray-200 rounded-md hover:bg-gray-300">
                                                Generate
                                            </button>
                                        </label>
                                        <input type="text" name="platform_data__website__seo_keywords" id="website_seo_keywords"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                            placeholder="vintage, guitar, instrument">
                                    </div>
                                    <div class="col-span-2">
                                        <label class="block text-sm font-medium text-gray-700">Short Description (for listings)</label>
                                        <textarea name="platform_data__website__short_description" id="website_short_description" rows="2"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                </div>

                <!-- Shipping Section -->
                <div class="form-section">
                    <button type="button" 
                        class="form-section-header flex justify-between items-center w-full py-2 px-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                        <span class="text-lg font-medium">Shipping</span>
                        <svg class="form-section-icon w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div class="form-section-content p-4 border rounded-lg mt-2">
                        <!-- Shipping Profile Selector - Full Width -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Shipping Profile</label>
                            <div class="flex items-center space-x-2">
                                <select id="shipping_profile" name="shipping_profile" 
                                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="">-- Select a profile --</option>
                                    <!-- Profiles loaded from API -->
                                </select>
                                <!-- Removing the Manage button as per your request -->
                            </div>
                            <p class="mt-2 text-sm text-gray-500">Select a predefined shipping profile or customize below</p>
                        </div>

                        <!-- Dimensions and Weight in a single row -->
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                            <div class="md:col-span-1">
                                <label for="weight" class="block text-sm font-medium text-gray-700 mb-2">Weight</label>
                                <div class="relative rounded-md shadow-sm">
                                    <input type="text" name="weight" id="weight" 
                                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                        <span class="text-gray-500 sm:text-sm">kg</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="md:col-span-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Dimensions</label>
                                <div class="grid grid-cols-3 gap-3">
                                    <div>
                                        <div class="relative rounded-md shadow-sm">
                                            <input type="text" name="length" id="length" placeholder="Length" 
                                                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                                <span class="text-gray-500 sm:text-xs">cm</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="relative rounded-md shadow-sm">
                                            <input type="text" name="width" id="width" placeholder="Width"
                                                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                                <span class="text-gray-500 sm:text-xs">cm</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="relative rounded-md shadow-sm">
                                            <input type="text" name="height" id="height" placeholder="Height" 
                                                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                                <span class="text-gray-500 sm:text-xs">cm</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Carrier Selection - Using Radio Buttons -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Preferred Carrier</label>
                            <div class="bg-gray-50 p-4 rounded-lg grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="flex items-center">
                                    <input id="carrier_dhl" name="carrier" type="radio" value="dhl" 
                                        class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="carrier_dhl" class="ml-3 block text-sm text-gray-700">DHL</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="carrier_fedex" name="carrier" type="radio" value="fedex" 
                                        class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="carrier_fedex" class="ml-3 block text-sm text-gray-700">FedEx</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="carrier_tnt" name="carrier" type="radio" value="tnt" 
                                        class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="carrier_tnt" class="ml-3 block text-sm text-gray-700">TNT</label>
                                </div>
                            </div>
                        </div>

                        <!-- Shipping Options -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Options</label>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-gray-50 p-4 rounded-lg">
                                <div class="flex items-center">
                                    <input id="require_signature" name="require_signature" type="checkbox" 
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="require_signature" class="ml-3 block text-sm text-gray-700">Require Signature</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="insurance" name="insurance" type="checkbox" 
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="insurance" class="ml-3 block text-sm text-gray-700">Add Insurance</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="fragile" name="fragile" type="checkbox"
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="fragile" class="ml-3 block text-sm text-gray-700">Mark as Fragile</label>
                                </div>
                            </div>
                        </div>

                        <!-- Regional Rates -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Regional Shipping Rates</label>
                            <div class="overflow-x-auto bg-white border border-gray-200 rounded-lg">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Region</th>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rate (£)</th>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Processing Time</th>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Enabled</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">United Kingdom</td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <input type="text" name="uk_rate" class="w-24 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <select name="uk_processing" class="w-32 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                                    <option value="1-2">1-2 days</option>
                                                    <option value="3-5" selected>3-5 days</option>
                                                    <option value="5-7">5-7 days</option>
                                                </select>
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <input type="checkbox" name="uk_enabled" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                            </td>
                                        </tr>
                                        <!-- Additional rows for Europe, USA, and Rest of World follow the same pattern -->
                                        <tr>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">Europe</td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <input type="text" name="europe_rate" class="w-24 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <select name="europe_processing" class="w-32 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                                    <option value="3-5">3-5 days</option>
                                                    <option value="5-7" selected>5-7 days</option>
                                                    <option value="7-10">7-10 days</option>
                                                </select>
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <input type="checkbox" name="europe_enabled" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">USA</td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <input type="text" name="usa_rate" class="w-24 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <select name="usa_processing" class="w-32 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                                    <option value="5-7">5-7 days</option>
                                                    <option value="7-10" selected>7-10 days</option>
                                                    <option value="10-14">10-14 days</option>
                                                </select>
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <input type="checkbox" name="usa_enabled" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">Rest of World</td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <input type="text" name="row_rate" class="w-24 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <select name="row_processing" class="w-32 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                                    <option value="7-10">7-10 days</option>
                                                    <option value="10-14" selected>10-14 days</option>
                                                    <option value="14-21">14-21 days</option>
                                                </select>
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <input type="checkbox" name="row_enabled" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Platform Sync Controls -->
                <div class="form-section">
                    <button type="button" 
                        class="form-section-header flex justify-between items-center w-full py-2 px-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                        <span class="text-lg font-medium">Sync Settings</span>
                        <svg class="form-section-icon w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div class="form-section-content p-4 border rounded-lg mt-2">
                        <div class="mb-4">
                            <p class="text-sm text-gray-700 mb-3">Choose which platforms to sync this product with:</p>
                            
                            <div class="flex items-center space-x-4 mb-4">
                                <div class="flex items-center">
                                    <input type="radio" name="sync_all" id="sync_all_yes" value="true" checked
                                        class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="sync_all_yes" class="ml-2 block text-sm text-gray-700">Sync All Platforms</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" name="sync_all" id="sync_all_no" value="false"
                                        class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="sync_all_no" class="ml-2 block text-sm text-gray-700">Select Platforms</label>
                                </div>
                            </div>
                            
                            <!-- Platform selection (shown when "Select Platforms" is chosen) -->
                            <div id="platform-selection" class="mb-4 grid grid-cols-2 md:grid-cols-4 gap-4 hidden">
                                <div class="flex items-center">
                                    <input type="checkbox" name="sync_platforms" value="ebay" id="sync_ebay"
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="sync_ebay" class="ml-2 block text-sm text-gray-700">eBay</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="sync_platforms" value="reverb" id="sync_reverb"
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="sync_reverb" class="ml-2 block text-sm text-gray-700">Reverb</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="sync_platforms" value="vr" id="sync_vr"
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="sync_vr" class="ml-2 block text-sm text-gray-700">Vintage & Rare</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="sync_platforms" value="website" id="sync_website"
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="sync_website" class="ml-2 block text-sm text-gray-700">Website</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end mt-6">
                    <button type="submit"
                            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 font-medium">
                        Add Product
                    </button>
                </div>

            <div>
        </form>

        <!-- Platform Status Section -->
        <div class="px-6 pb-6">
            <!-- Platform status indicators here -->
            <h3 class="text-lg font-semibold mb-4">Platform Status</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <!-- eBay Status -->
                <div class="border rounded p-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full {% if ebay_status == 'success' %}bg-green-500{% elif ebay_status == 'pending' %}bg-yellow-500{% else %}bg-red-500{% endif %}"></div>
                        <span>eBay</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">{{ ebay_message or 'Waiting for sync' }}</p>
                </div>

                <!-- Reverb Status -->
                <div class="border rounded p-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full {% if reverb_status == 'success' %}bg-green-500{% elif reverb_status == 'pending' %}bg-yellow-500{% else %}bg-red-500{% endif %}"></div>
                        <span>Reverb</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">{{ reverb_message or 'Waiting for sync' }}</p>
                </div>

                <!-- V&R Status -->
                <div class="border rounded p-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full {% if vr_status == 'success' %}bg-green-500{% elif vr_status == 'pending' %}bg-yellow-500{% else %}bg-red-500{% endif %}"></div>
                        <span>Vintage & Rare</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">{{ vr_message or 'Waiting for sync' }}</p>
                </div>

                <!-- Website Status -->
                <div class="border rounded p-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full {% if website_status == 'success' %}bg-green-500{% elif website_status == 'pending' %}bg-yellow-500{% else %}bg-red-500{% endif %}"></div>
                        <span>Website</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">{{ website_message or 'Waiting for sync' }}</p>
                </div>
            </div>
        </div> 
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>

document.addEventListener('DOMContentLoaded', function() {
    
    let currentPath = ''; // Global variable to track current folder path
    
    // Find the button after DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        const regenerateButton = document.getElementById('regenerate-links-button');
        if (regenerateButton) {
            regenerateButton.addEventListener('click', function() {
                console.log("Regenerate button clicked, current path:", currentPath);
                if (currentPath) {
                    generateFolderLinks(currentPath);
                } else {
                    console.error("No current path defined");
                    alert("Please navigate to a folder first");
                }
            });
        }
    });

    // =========== SECTION TOGGLING ===========
    // Handle collapsible sections
    document.querySelectorAll('.form-section-header').forEach(header => {
        header.addEventListener('click', function() {
            const content = this.closest('.form-section').querySelector('.form-section-content');
            const icon = this.querySelector('.form-section-icon');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        });
    });

    // Initialize TinyMCE - ADD THIS HERE
    tinymce.init({
        selector: '#description',
        plugins: 'anchor autolink charmap codesample emoticons image link lists media searchreplace table visualblocks wordcount',
        toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link image media table | align lineheight | numlist bullist indent outdent | emoticons charmap | removeformat',
        height: 300,
        menubar: false
    });

    // Open the first section by default
    const firstSection = document.querySelector('.form-section-header');
    if (firstSection) {
        firstSection.click();
    }

    // Open only the Basic Information section by default
    const basicInfoSection = document.querySelector('.form-section:first-child .form-section-header');
    if (basicInfoSection) {
        basicInfoSection.click();
    }

    // Make sure all other sections are collapsed
    document.querySelectorAll('.form-section:not(:first-child) .form-section-content').forEach(content => {
        content.classList.add('hidden');
    });

    // Legacy image section toggle (for backward compatibility)
    function toggleImageSection() {
        const section = document.getElementById('imageSection');
        const icon = document.getElementById('imageToggleIcon');
        if (section && icon) {
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                section.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        }
    }
    
    // Make toggleImageSection available globally
    window.toggleImageSection = toggleImageSection;
    
    // =========== PLATFORM TABS ===========
    // Platform tab switching
    document.querySelectorAll('.platform-tab').forEach(tab => {
        tab.addEventListener('click', function() {

            // Clear active state from all tabs
            document.querySelectorAll('.platform-tab').forEach(t => {
                t.classList.remove('bg-blue-100', 'border-blue-500', 'border-b-2', 'text-blue-600', 'active');
                t.classList.add('text-gray-500');
            });
            
            // Add active state to clicked tab
            this.classList.add('bg-blue-100', 'border-blue-500', 'border-b-2', 'text-blue-600', 'active');
            this.classList.remove('text-gray-500');
            
            // Hide all tab panes
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.add('hidden');
                pane.classList.remove('active');
            });
            
            // Show selected tab pane
            const targetId = this.getAttribute('data-target');
            const targetPane = document.getElementById(targetId);
            if (targetPane) {
                console.log('Found target pane:', targetId); // Debug
                targetPane.classList.remove('hidden');
                targetPane.classList.add('active');
            } else {
                console.error('Target pane not found:', targetId); // Debug
            }
        });
    });

    
    // Activate the first platform tab by default
    const firstTab = document.querySelector('.platform-tab');
    if (firstTab) {
        firstTab.click();
    }
    

    // =========== IMAGE HANDLING ===========
    // Image preview for file uploads
    const fileInputs = document.querySelectorAll('input[type="file"]');
    const previewContainer = document.getElementById('imagePreview');
    
    if (previewContainer) {
        fileInputs.forEach(input => {
            input.addEventListener('change', function(e) {
                // Clear previous previews if this is the primary image
                if (this.name === 'primary_image_file') {
                    // Only clear the primary image preview
                    const primaryPreviews = previewContainer.querySelectorAll('[data-source="primary"]');
                    primaryPreviews.forEach(prev => prev.remove());
                }
                
                if (this.files) {
                    Array.from(this.files).forEach(file => {
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const preview = document.createElement('div');
                                preview.className = 'relative aspect-square';
                                preview.setAttribute('data-source', input.name === 'primary_image_file' ? 'primary' : 'additional');
                                preview.innerHTML = `
                                    <img src="${e.target.result}" 
                                            class="w-full h-full object-cover rounded-lg shadow-sm"
                                            alt="Preview">
                                    <div class="absolute top-1 right-1">
                                        <button type="button" class="remove-image bg-red-500 text-white rounded-full p-1 hover:bg-red-600">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    </div>
                                `;
                                previewContainer.appendChild(preview);
                                
                                // Add event listener to remove button
                                preview.querySelector('.remove-image').addEventListener('click', function() {
                                    preview.remove();
                                    // Clear the file input if it's the primary image
                                    if (input.name === 'primary_image_file') {
                                        input.value = '';
                                    }
                                });
                            };
                            reader.readAsDataURL(file);
                        } else {
                            alert('Please select only image files.');
                            this.value = ''; // Clear the input
                        }
                    });
                }
            });
        });
    }
    
    // Initialize drag and drop for images
    let imagesList = [];

    // Function to update hidden inputs when images are reordered
    function updateImageOrder() {
    const previewContainer = document.getElementById('imagePreview');
    if (!previewContainer) return;
    
    const images = previewContainer.querySelectorAll('.image-preview');
    
    // Update the array
    imagesList = Array.from(images).map(img => {
        return {
            url: img.dataset.url,
            source: img.dataset.source
        };
    });
    
    // The first image is the primary image, all others are additional
    if (imagesList.length > 0) {
        const primaryImage = imagesList[0];
        const additionalImages = imagesList.slice(1);
        
        // Set the hidden input fields for form submission
        if (primaryImage.source === 'upload') {
            // Will be handled by file input
        } else if (primaryImage.source === 'url') {
            document.querySelector('input[name="primary_image_url"]').value = primaryImage.url;
        } else if (primaryImage.source === 'dropbox') {
            document.querySelector('input[name="primary_image_url"]').value = primaryImage.url;
        }
        
        // Set additional images
        const additionalUrls = additionalImages
            .filter(img => img.source === 'url' || img.source === 'dropbox')
            .map(img => img.url);
            
        document.querySelector('input[name="additional_images_urls"]').value = additionalUrls.join('\n');
    }
}

// Add Sortable.js library if it doesn't exist
if (!window.Sortable) {
    const script = document.createElement('script');
    script.src = "https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js";
    script.onload = initializeSortable;
    document.head.appendChild(script);
} else {
    initializeSortable();
}

function initializeSortable() {
    const container = document.getElementById('imagePreview');
    if (container) {
        new Sortable(container, {
            animation: 150,
            ghostClass: 'bg-blue-100',
            onEnd: function(evt) {
                // Update the order of images after drag
                updateImageOrder();
                console.log('Image order updated after drag');
            }
        });
        
        console.log('Sortable initialized on imagePreview container');
        
        // Also initialize for Dropbox selected images
        const dropboxContainer = document.getElementById('dropbox-selected-images');
        if (dropboxContainer) {
            new Sortable(dropboxContainer, {
                animation: 150,
                ghostClass: 'bg-blue-100',
                onEnd: function() {
                    // Update selected images array to match new order
                    const imageElements = dropboxContainer.querySelectorAll('[data-url]');
                    selectedImages = Array.from(imageElements).map(el => {
                        return {
                            url: el.dataset.url,
                            name: el.dataset.name || ''
                        };
                    });
                    updateSelectedImagesDisplay();
                }
            });
            console.log('Sortable initialized on dropbox-selected-images container');
        }
    }
}

    // =========== COPY FROM EXISTING ===========
    
    const existingProductSelect = document.getElementById('existingProduct');
    const copyButton = document.getElementById('copyButton');
    const copyStatus = document.getElementById('copyStatus');
    
    if (existingProductSelect && copyButton && copyStatus) {
        copyButton.addEventListener('click', function() {
            const productId = existingProductSelect.value;
            if (!productId) {
                copyStatus.textContent = 'Please select a product first';
                copyStatus.classList.add('text-red-600');
                return;
            }
            
            copyStatus.textContent = 'Loading product data...';
            copyStatus.classList.remove('text-red-600');
            copyStatus.classList.add('text-blue-600');
            
            // Fetch product data
            fetch(`/inventory/api/products/${productId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // Fill the form with product data
                    fillFormWithProductData(data);
                    copyStatus.textContent = 'Product data copied successfully!';
                    copyStatus.classList.remove('text-blue-600');
                    copyStatus.classList.add('text-green-600');
                    
                    // Clear the status after 3 seconds
                    setTimeout(() => {
                        copyStatus.textContent = '';
                    }, 3000);
                })
                .catch(error => {
                    console.error('Error fetching product data:', error);
                    copyStatus.textContent = 'Error fetching product data';
                    copyStatus.classList.remove('text-blue-600');
                    copyStatus.classList.add('text-red-600');
                });
        });
    }

    function fillFormWithProductData(data) {
        // Basic info
        setValueIfExists('brand', data.brand);
        setValueIfExists('model', data.model);
        // Generate a new SKU rather than copying
        document.getElementById('generateSku')?.click();
        setValueIfExists('year', data.year);
        setValueIfExists('decade', data.decade);
        setValueIfExists('category', data.category);
        setValueIfExists('finish', data.finish);
        
        // Description & Condition
        setValueIfExists('description', data.description);
        setValueIfExists('condition', data.condition);
        setValueIfExists('status', 'DRAFT'); // Always start as draft
        
        // Pricing & Inventory
        setValueIfExists('base_price', data.base_price);
        setValueIfExists('cost_price', data.cost_price);
        setValueIfExists('processing_time', data.processing_time || '3');
        setValueIfExists('collective_discount', data.collective_discount || '0');
        setValueIfExists('offer_discount', data.offer_discount || '0');
        
        // Checkboxes
        setCheckedIfExists('in_collective', data.in_collective);
        setCheckedIfExists('in_inventory', data.in_inventory !== false);
        setCheckedIfExists('free_shipping', data.free_shipping);
        setCheckedIfExists('buy_now', data.buy_now !== false);
        setCheckedIfExists('show_vat', data.show_vat !== false);
        setCheckedIfExists('local_pickup', data.local_pickup);
        setCheckedIfExists('available_for_shipment', data.available_for_shipment !== false);
        
        // URLs
        setValueIfExists('video_url', data.video_url);
        setValueIfExists('external_link', data.external_link);
        
        // Platform data - eBay
        if (data.platform_data && data.platform_data.ebay) {
            setValueIfExists('ebay_category_id', data.platform_data.ebay.category_id);
            setValueIfExists('ebay_format', data.platform_data.ebay.format || 'FixedPrice');
            setValueIfExists('ebay_duration', data.platform_data.ebay.duration || 'GTC');
            setCheckedIfExists('ebay_sync_inventory', data.platform_data.ebay.sync_inventory !== false);
        }
        
        // Platform data - Reverb
        if (data.platform_data && data.platform_data.reverb) {
            setValueIfExists('reverb_product_type', data.platform_data.reverb.product_type);
            setValueIfExists('reverb_primary_category', data.platform_data.reverb.primary_category);
            setValueIfExists('reverb_shipping_profile', data.platform_data.reverb.shipping_profile);
            setCheckedIfExists('reverb_offers_enabled', data.platform_data.reverb.offers_enabled !== false);
        }
        
        // Platform data - V&R
        if (data.platform_data && data.platform_data.vr) {
            setValueIfExists('vr_category', data.platform_data.vr.category);
            setValueIfExists('vr_featured', data.platform_data.vr.featured);
            setValueIfExists('vr_notes', data.platform_data.vr.notes);
        }
        
        // Platform data - Website
        if (data.platform_data && data.platform_data.website) {
            setValueIfExists('website_category', data.platform_data.website.category);
            setValueIfExists('website_priority', data.platform_data.website.priority);
            setValueIfExists('website_seo_keywords', data.platform_data.website.seo_keywords);
            setValueIfExists('website_short_description', data.platform_data.website.short_description);
        }
    }

    function setValueIfExists(id, value) {
        const element = document.getElementById(id);
        if (element && value !== undefined && value !== null) {
            element.value = value;
        }
    }

    function setCheckedIfExists(id, value) {
        const element = document.getElementById(id);
        if (element) {
            element.checked = !!value;
        }
    }
    

    // =========== GENERATE SKU ===========
    // Generate SKU - updated for new autogen logic.
    const generateSkuButton = document.getElementById('generateSku');
    if (generateSkuButton) {
        generateSkuButton.addEventListener('click', async function() {
            try {
                // Show loading state
                generateSkuButton.disabled = true;
                generateSkuButton.innerHTML = `
                    <svg class="animate-spin h-4 w-4 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                `;
                
                // Call API endpoint to get next available SKU
                const response = await fetch('/inventory/api/next-sku');
                const data = await response.json();
                
                if (data.sku) {
                    document.getElementById('sku').value = data.sku;
                } else {
                    alert('Error generating SKU: ' + data.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Error generating SKU:', error);
                alert('Error generating SKU. Please try again.');
            } finally {
                // Restore button state
                generateSkuButton.disabled = false;
                generateSkuButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                `;
            }
        });
    }
    

    // =========== FORM VALIDATION ===========
    // Form validation and submission
    const form = document.getElementById('addProductForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            let isValid = true;
            const requiredFields = form.querySelectorAll('[required]');
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    field.classList.add('border-red-500');
                    
                    // Add error message if not exists
                    const errorId = `${field.id}-error`;
                    if (!document.getElementById(errorId)) {
                        const errorMsg = document.createElement('p');
                        errorMsg.id = errorId;
                        errorMsg.className = 'text-red-500 text-xs mt-1';
                        errorMsg.textContent = 'This field is required';
                        field.parentNode.appendChild(errorMsg);
                    }
                } else {
                    field.classList.remove('border-red-500');
                    const errorMsg = document.getElementById(`${field.id}-error`);
                    if (errorMsg) {
                        errorMsg.remove();
                    }
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                
                // Scroll to the first error
                const firstError = form.querySelector('.border-red-500');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                return false;
            }
            
            // Log all form values for debugging
            console.log('Form submission started');
            const formData = new FormData(form);
            for (let [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
            }
            
            console.log('Submitting form to:', form.action);
            return true;
        });
        
        // Clear validation errors when typing
        const formInputs = form.querySelectorAll('input, select, textarea');
        formInputs.forEach(input => {
            input.addEventListener('input', function() {
                this.classList.remove('border-red-500');
                const errorMsg = document.getElementById(`${this.id}-error`);
                if (errorMsg) {
                    errorMsg.remove();
                }
            });
        });
    }


    // =========== DROPBOX INTEGRATION ===========
    // Tab switching functionality for image upload methods
    const tabs = ['upload', 'url', 'dropbox'];
    currentPath = '';
    tabs.forEach(tab => {
        const tabButton = document.getElementById(`tab-${tab}`);
        if (tabButton) {
            tabButton.addEventListener('click', function() {
                // Hide all content panels
                tabs.forEach(t => {
                    const contentEl = document.getElementById(`content-${t}`);
                    if (contentEl) {
                        contentEl.classList.add('hidden');
                    }
                    const tabEl = document.getElementById(`tab-${t}`);
                    if (tabEl) {
                        tabEl.classList.remove('bg-blue-50', 'border-blue-500', 'text-blue-600');
                    }
                });
                
                // Show the selected content panel
                const contentEl = document.getElementById(`content-${tab}`);
                if (contentEl) {
                    contentEl.classList.remove('hidden');
                }
                tabButton.classList.add('bg-blue-50', 'border-blue-500', 'text-blue-600');
                
                // If dropbox tab is selected, load folders
                if (tab === 'dropbox') {
                    loadDropboxFolders();
                }
            });
        }
    });
    
    // Dropbox functionality
    let navigationHistory = [];
    let selectedImages = [];
    
    const dropboxElements = {
        browser: document.getElementById('dropbox-browser'),
        items: document.getElementById('dropbox-items'),
        loading: document.getElementById('dropbox-loading'),
        empty: document.getElementById('dropbox-empty'),
        error: document.getElementById('dropbox-error'),
        currentPath: document.getElementById('dropbox-current-path'),
        backButton: document.getElementById('dropbox-back'),
        refreshButton: document.getElementById('dropbox-refresh'),
        selectedImages: document.getElementById('dropbox-selected-images'),
        noSelection: document.getElementById('dropbox-no-selection'),
        primaryImage: document.getElementById('dropbox-primary-image'),
        additionalImages: document.getElementById('dropbox-additional-images')
    };
    
    // Initialize dropbox elements
    if (dropboxElements.backButton) {
        dropboxElements.backButton.addEventListener('click', function() {
            if (navigationHistory.length > 0) {
                currentPath = navigationHistory.pop();
                loadDropboxFolders(currentPath);
                dropboxElements.backButton.disabled = navigationHistory.length === 0;
            }
        });
    }
    
    if (dropboxElements.refreshButton) {
        dropboxElements.refreshButton.addEventListener('click', function() {
            loadDropboxFolders(currentPath);
        });
    }

    // ADD THE CODE HERE - after the refreshButton event listener
    // Initialize the regenerate links button
    if (document.getElementById('regenerate-links-button')) {
        document.getElementById('regenerate-links-button').addEventListener('click', function() {
            console.log("Regenerate links button clicked for path:", currentPath);
            if (currentPath) {
                generateFolderLinks(currentPath);
            } else {
                console.log("No current path available");
                if (dropboxElements.error) {
                    dropboxElements.error.textContent = 'Please navigate to a folder first';
                    dropboxElements.error.classList.remove('hidden');
                }
            }
        });
    }
    
    // Function to load Dropbox folders
    function loadDropboxFolders(path = '') {
        // Update current path (make sure this line exists)
        currentPath = path;
        // Show loading state
        dropboxElements.items.classList.add('hidden');
        if (dropboxElements.empty) dropboxElements.empty.classList.add('hidden');
        if (dropboxElements.error) dropboxElements.error.classList.add('hidden');
        dropboxElements.loading.classList.remove('hidden');
        
        // Update loading with a helpful message
        dropboxElements.loading.innerHTML = `
            <svg class="animate-spin h-6 w-6 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-sm font-medium">Loading Dropbox folders...</p>
        `;
    
        // Update current path display
        if (dropboxElements.currentPath) {
            dropboxElements.currentPath.textContent = path || '/';
        }
    
        // Make API request
        fetch(`/inventory/api/dropbox/folders?path=${encodeURIComponent(path)}`)
            .then(response => {
                // First check status code
                if (response.status === 202) {
                    // The operation is still processing
                    return response.json().then(data => {
                        console.log("Received 202 status - operation in progress", data);
                        
                        // Update loading message
                        dropboxElements.loading.innerHTML = `
                            <svg class="animate-spin h-6 w-6 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="text-sm font-medium">${data.message || 'Processing Dropbox request...'}</p>
                            <p class="text-xs text-gray-500 mt-1">Please wait, this may take a moment...</p>
                            <button id="dropbox-retry" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                Check Again
                            </button>
                        `;
                        
                        // Add event listener to retry button
                        const retryButton = document.getElementById('dropbox-retry');
                        if (retryButton) {
                            retryButton.addEventListener('click', function() {
                                loadDropboxFolders(path);
                            });
                        }
                        
                        // Set a timer to automatically retry after 5 seconds
                        // setTimeout(() => {
                        //     loadDropboxFolders(path);
                        // }, 5000);
                        
                        // Signal that this is a pending state, not an error
                        throw new Error('PENDING');
                    });
                }
                
                // For all other status codes, proceed normally
                return response.json();
            })
            .then(data => {
                console.log("Dropbox folder data:", data);
                // Hide loading state
                dropboxElements.loading.classList.add('hidden');
                
                if (data.error) {
                    if (dropboxElements.error) {
                        dropboxElements.error.textContent = data.error;
                        dropboxElements.error.classList.remove('hidden');
                    }
                    return;
                }
                
                // Clear items container
                dropboxElements.items.innerHTML = '';
    
                // Handle folder list
                const folders = data.folders || data.items || [];
                if (folders.length > 0) {
                    // Display folders
                    folders.forEach(folder => {
                        if (!folder.is_folder && !/\.(jpe?g|png|gif)$/i.test(folder.name)) {
                            return; // Skip non-image files
                        }
                        
                        const itemElement = document.createElement('div');
                        
                        if (!folder.is_folder && folder.is_folder !== false) {
                            folder.is_folder = true; // Default to folder for backward compatibility
                        }
                        
                        if (folder.is_folder) {
                            // Render folder
                            itemElement.className = 'p-2 border rounded flex items-center cursor-pointer hover:bg-gray-50';
                            itemElement.innerHTML = `
                                <svg class="h-5 w-5 mr-2 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                                </svg>
                                <span class="text-sm truncate">${folder.name}</span>
                            `;
                            
                            itemElement.addEventListener('click', function() {
                                navigationHistory.push(currentPath);
                                currentPath = folder.path;
                                loadDropboxFolders(folder.path);
                                if (dropboxElements.backButton) {
                                    dropboxElements.backButton.disabled = false;
                                }
                            });
                        } else {
                            // Render image file
                            itemElement.className = 'relative border rounded overflow-hidden cursor-pointer hover:border-blue-500';
                            
                            // If we have a temp link, show thumbnail
                            if (folder.temp_link) {
                                itemElement.innerHTML = `
                                    <div class="aspect-w-1 aspect-h-1">
                                        <img src="${folder.temp_link}" alt="${folder.name}" class="object-cover w-full h-full">
                                    </div>
                                    <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white p-1">
                                        <p class="text-xs truncate">${folder.name}</p>
                                    </div>
                                `;
                                
                                // Add click handler to select image
                                itemElement.addEventListener('click', function() {
                                    const imageData = {
                                        url: folder.temp_link,
                                        name: folder.name,
                                        path: folder.path
                                    };
                                    
                                    toggleImageSelection(imageData);
                                });
                            } else {
                                itemElement.innerHTML = `
                                    <div class="aspect-w-1 aspect-h-1 flex items-center justify-center bg-gray-100">
                                        <svg class="h-8 w-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white p-1">
                                        <p class="text-xs truncate">${folder.name}</p>
                                    </div>
                                `;
                                
                                // Add click handler to load images
                                itemElement.addEventListener('click', function() {
                                    // Load images from the current folder
                                    loadDropboxImages(folder.path);
                                });
                            }
                        }
                        
                        dropboxElements.items.appendChild(itemElement);
                    });
                    
                    dropboxElements.items.classList.remove('hidden');
                } else {
                    // Show empty state
                    if (dropboxElements.empty) {
                        dropboxElements.empty.classList.remove('hidden');
                    }
                    
                    // No folders found, try to load images instead
                    console.log("No folders found, trying to load images for path:", path);
                    
                    // Check if it might be an image folder and try to load images
                    loadDropboxImages(path);
                }
            })
            .catch(error => {
                // Skip error handling for PENDING status
                if (error.message === 'PENDING') {
                    return;
                }
                
                console.error('Error loading Dropbox folders:', error);
                dropboxElements.loading.classList.add('hidden');
                if (dropboxElements.error) {
                    dropboxElements.error.textContent = 'Error loading Dropbox content';
                    dropboxElements.error.classList.remove('hidden');
                }
            });
    }

    
    // Function to load Dropbox images from a folder
    function loadDropboxImages(folderPath) {
        if (!dropboxElements.items || !dropboxElements.loading) {
            console.error('Dropbox UI elements not found');
            return;
        }
        
        console.log(`Loading Dropbox images from folder: ${folderPath}`);
        
        // Show loading state
        dropboxElements.items.classList.add('hidden');
        if (dropboxElements.empty) dropboxElements.empty.classList.add('hidden');
        if (dropboxElements.error) dropboxElements.error.classList.add('hidden');
        dropboxElements.loading.classList.remove('hidden');
        
        dropboxElements.loading.innerHTML = `
            <svg class="animate-spin h-6 w-6 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-sm font-medium">Loading images from folder...</p>
        `;
        
        // Make API request to get images
        fetch(`/inventory/api/dropbox/images?folder_path=${encodeURIComponent(folderPath)}`)
            .then(response => response.json())
            .then(data => {
                console.log(`Received ${data.images ? data.images.length : 0} images from folder ${folderPath}`);
                
                if (data.images && data.images.length > 0) {
                    // We have images, display them
                    dropboxElements.loading.classList.add('hidden');
                    displayImages(data.images);
                } else {
                    // No images found, try generating the links automatically
                    console.log("No images found, generating links automatically");
                    dropboxElements.loading.innerHTML = `
                        <svg class="animate-spin h-6 w-6 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="text-sm font-medium">Generating thumbnails automatically...</p>
                    `;
                    
                    // Generate links automatically
                    fetch(`/inventory/api/dropbox/generate-links?folder_path=${encodeURIComponent(folderPath)}`)
                        .then(response => response.json())
                        .then(linkData => {
                            dropboxElements.loading.classList.add('hidden');
                            
                            if (linkData.status === 'success' && linkData.images && linkData.images.length > 0) {
                                // Display the newly generated images
                                displayImages(linkData.images);
                            } else {
                                // Still no images, show empty state
                                if (dropboxElements.empty) {
                                    dropboxElements.empty.textContent = 'No images found in this folder';
                                    dropboxElements.empty.classList.remove('hidden');
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error generating links:', error);
                            dropboxElements.loading.classList.add('hidden');
                            if (dropboxElements.error) {
                                dropboxElements.error.textContent = 'Error generating thumbnails';
                                dropboxElements.error.classList.remove('hidden');
                            }
                        });
                }
            })
            .catch(error => {
                console.error('Error loading Dropbox images:', error);
                dropboxElements.loading.classList.add('hidden');
                if (dropboxElements.error) {
                    dropboxElements.error.textContent = 'Error loading images';
                    dropboxElements.error.classList.remove('hidden');
                }
            });
    }


    // Function to generate temporary links for the current folder
    function generateFolderLinks(folderPath) {
        console.log("Generating temporary links for folder:", folderPath);
        console.log("generateFolderLinks called with path:", folderPath);
        
        // Show loading state
        dropboxElements.loading.classList.remove('hidden');
        dropboxElements.items.classList.add('hidden');
        if (dropboxElements.empty) dropboxElements.empty.classList.add('hidden');
        if (dropboxElements.error) dropboxElements.error.classList.add('hidden');
        
        dropboxElements.loading.innerHTML = `
            <svg class="animate-spin h-6 w-6 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-sm font-medium">Generating temporary links for folder...</p>
        `;
        
        // Make API request
        fetch(`/inventory/api/dropbox/generate-links?folder_path=${encodeURIComponent(folderPath)}`)
            .then(response => response.json())
            .then(data => {
                console.log("Generate links API response:", data);
                
                // Hide loading state
                dropboxElements.loading.classList.add('hidden');
                
                if (data.status === 'success') {
                    // Refresh the view to show the new links
                    if (data.images && data.images.length > 0) {
                        // Update the UI directly with the returned images
                        displayImages(data.images);
                    } else {
                        // If no images returned but operation was successful, reload the folder
                        loadDropboxImages(folderPath);
                    }
                } else {
                    // Show error message
                    if (dropboxElements.error) {
                        dropboxElements.error.textContent = data.message || 'Error generating links';
                        dropboxElements.error.classList.remove('hidden');
                    }
                }
            })
            .catch(error => {
                console.error('Error generating links:', error);
                dropboxElements.loading.classList.add('hidden');
                if (dropboxElements.error) {
                    dropboxElements.error.textContent = 'Error generating temporary links';
                    dropboxElements.error.classList.remove('hidden');
                }
            });
    }

    function displayImages(images) {
        console.log("Displaying images:", images.length);
        // Clear items container
        dropboxElements.items.innerHTML = '';
        
        if (images.length > 0) {
            // Show Select All button and update its text
            const selectAllButton = document.getElementById('select-all-images');
            if (selectAllButton) {
                selectAllButton.classList.remove('hidden');
                selectAllButton.textContent = `Select All Images (${images.length})`;
                
                // Remove any existing event listeners and replace with new one
                selectAllButton.replaceWith(selectAllButton.cloneNode(true));
                
                // Get the fresh reference and add event listener
                document.getElementById('select-all-images').addEventListener('click', function() {
                    // Add all currently displayed images to selection
                    images.forEach(image => {
                        // Only add if not already selected
                        if (!selectedImages.some(selected => selected.url === image.url)) {
                            selectedImages.push(image);
                        }
                    });
                    
                    // Update the image preview directly
                    updateImagePreview();
                    updateHiddenInputs();
                    
                    // Show a confirmation message
                    const notification = document.createElement('div');
                    notification.className = 'fixed bottom-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50';
                    notification.innerHTML = `
                        <span class="block sm:inline">${images.length} images selected</span>
                    `;
                    document.body.appendChild(notification);
                    
                    // Remove the notification after 3 seconds
                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                });
            }
            
            // IMPROVED: Better grid layout with proper sizing
            const imageGrid = document.createElement('div');
            imageGrid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 w-full';
            dropboxElements.items.appendChild(imageGrid);
            
            // Add images to the grid with improved sizing and aspect ratio
            images.forEach(image => {
                // Check if image is already selected (for visual feedback)
                const isSelected = selectedImages.some(selected => selected.url === image.url);
                
                const imageItem = document.createElement('div');
                imageItem.className = `relative border rounded overflow-hidden cursor-pointer hover:border-blue-500 ${isSelected ? 'ring-2 ring-green-500' : ''}`;
                imageItem.dataset.imageUrl = image.url; // Add data attribute to track this image
                
                // FIXED: Set a much larger explicit height instead of aspect ratio
                imageItem.style.height = '150px'; // Increased from previous small size
                
                imageItem.innerHTML = `
                    <div class="h-full w-full">
                        <div class="absolute inset-0 flex items-center justify-center">
                            <img src="${image.url}" alt="${image.name}" 
                                class="max-w-full max-h-full object-contain" loading="lazy">
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white p-2">
                            <p class="text-sm truncate">${image.name}</p>
                        </div>
                        ${isSelected ? `
                        <div class="absolute top-2 right-2">
                            <span class="bg-green-500 text-white rounded-full p-1 flex items-center justify-center w-6 h-6">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                            </span>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                // Add click handler to select image
                imageItem.addEventListener('click', function() {
                    toggleImageSelection(image);
                    
                    // Update visual selection state immediately
                    const isNowSelected = selectedImages.some(selected => selected.url === image.url);
                    if (isNowSelected) {
                        this.classList.add('ring-2', 'ring-green-500');
                        if (!this.querySelector('.absolute.top-2.right-2')) {
                            const checkmark = document.createElement('div');
                            checkmark.className = 'absolute top-2 right-2';
                            checkmark.innerHTML = `
                                <span class="bg-green-500 text-white rounded-full p-1 flex items-center justify-center w-6 h-6">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                </span>
                            `;
                            this.querySelector('.h-full').appendChild(checkmark);
                        }
                    } else {
                        this.classList.remove('ring-2', 'ring-green-500');
                        const checkmark = this.querySelector('.absolute.top-2.right-2');
                        if (checkmark) checkmark.remove();
                    }
                });
                
                imageGrid.appendChild(imageItem);
            });
            
            dropboxElements.items.classList.remove('hidden');
        } else {
            // Hide the Select All button
            const selectAllButton = document.getElementById('select-all-images');
            if (selectAllButton) {
                selectAllButton.classList.add('hidden');
            }
            
            // Show empty state
            if (dropboxElements.empty) {
                dropboxElements.empty.textContent = 'No images found in this folder';
                dropboxElements.empty.classList.remove('hidden');
            }
        }
    }


    function toggleImageSelection(image) {
        const existingIndex = selectedImages.findIndex(img => img.url === image.url);
        
        if (existingIndex >= 0) {
            // Remove from selection
            selectedImages.splice(existingIndex, 1);
        } else {
            // Add to selection
            selectedImages.push(image);
        }
        
        // Update the main image preview
        updateImagePreview();
        
        // Update hidden inputs
        updateHiddenInputs();
    }

   
    function updateHiddenInputs() {
        if (selectedImages.length > 0) {
            // Update primary image input
            const primaryImageInput = document.getElementById('primary-image-input');
            if (primaryImageInput) {
                primaryImageInput.value = selectedImages[0].url;
            }
            
            // Update additional images input
            const additionalImagesInput = document.getElementById('additional-images-input');
            if (additionalImagesInput && selectedImages.length > 1) {
                const additionalUrls = selectedImages.slice(1).map(img => img.url).join('\n');
                additionalImagesInput.value = additionalUrls;
            } else if (additionalImagesInput) {
                additionalImagesInput.value = '';
            }
        } else {
            // Clear hidden inputs
            const primaryImageInput = document.getElementById('primary-image-input');
            if (primaryImageInput) primaryImageInput.value = '';
            
            const additionalImagesInput = document.getElementById('additional-images-input');
            if (additionalImagesInput) additionalImagesInput.value = '';
        }
    }
    
    // Declare a variable to store the sortable instance
    let dropboxSortableInstance = null;
    

    function updateSelectedImagesDisplay() {
        if (!dropboxElements.selectedImages || !dropboxElements.noSelection) {
            console.error('Dropbox selection elements not found');
            return;
        }
        
        // Destroy the existing sortable instance if it exists
        if (dropboxSortableInstance) {
            dropboxSortableInstance.destroy();
            dropboxSortableInstance = null;
        }
        
        // Clear existing content except the "no selection" message
        const children = Array.from(dropboxElements.selectedImages.children);
        children.forEach(child => {
            if (child !== dropboxElements.noSelection) {
                child.remove();
            }
        });
        
        if (selectedImages.length > 0) {
            // Hide the "no selection" message
            dropboxElements.noSelection.classList.add('hidden');
            
            // Create a container for the image grid
            const imageGrid = document.createElement('div');
            imageGrid.id = "sortable-dropbox-images";
            imageGrid.className = "grid grid-cols-2 md:grid-cols-4 gap-2 w-full";
            dropboxElements.selectedImages.appendChild(imageGrid);
            
            // Display selected images
            selectedImages.forEach((image, index) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'relative border rounded overflow-hidden group';
                imageItem.dataset.index = index; // Store the index for sorting
                imageItem.style.height = '150px'; // Set explicit height
                
                // First image is primary
                const isPrimary = index === 0;
                const borderClass = isPrimary ? 'border-blue-500 ring-2 ring-blue-300' : 'border-gray-300';
                
                imageItem.innerHTML = `
                    <div class="aspect-w-1 aspect-h-1 ${borderClass}">
                        <img src="${image.url}" alt="${image.name || 'Image'}" class="object-cover w-full h-full">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 flex items-center justify-center">
                            <button type="button" class="remove-btn hidden group-hover:block bg-red-500 text-white rounded-full p-1">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white p-1 flex justify-between items-center">
                        <span class="text-xs truncate">${isPrimary ? 'Primary' : `Additional ${index}`}</span>
                    </div>
                `;
                
                // Add remove button functionality
                const removeBtn = imageItem.querySelector('.remove-btn');
                removeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectedImages.splice(index, 1); // Remove this image
                    updateSelectedImagesDisplay(); // Refresh the display
                });
                
                imageGrid.appendChild(imageItem);
            });
            
            // Update hidden inputs for form submission
            if (selectedImages.length > 0) {
                // Update primary image input
                const primaryImageInput = document.getElementById('primary-image-input');
                if (primaryImageInput) {
                    primaryImageInput.value = selectedImages[0].url;
                }
                
                // Update additional images input
                const additionalImagesInput = document.getElementById('additional-images-input');
                if (additionalImagesInput && selectedImages.length > 1) {
                    const additionalUrls = selectedImages.slice(1).map(img => img.url).join('\n');
                    additionalImagesInput.value = additionalUrls;
                } else if (additionalImagesInput) {
                    additionalImagesInput.value = '';
                }
            }
            
            // Initialize Sortable on the grid container
            const sortableContainer = document.getElementById('sortable-dropbox-images');
            if (sortableContainer) {
                dropboxSortableInstance = new Sortable(sortableContainer, {
                    animation: 150,
                    ghostClass: 'bg-blue-100',
                    handle: '.aspect-w-1', // Use the image container as handle
                    filter: '.remove-btn', // Prevent dragging when clicking remove button
                    onEnd: function() {
                        // Get the new order of images
                        const newOrder = [];
                        const items = sortableContainer.querySelectorAll('[data-index]');
                        
                        // Build new array based on the DOM order
                        items.forEach(item => {
                            const oldIndex = parseInt(item.dataset.index);
                            if (!isNaN(oldIndex) && oldIndex >= 0 && oldIndex < selectedImages.length) {
                                newOrder.push(selectedImages[oldIndex]);
                            }
                        });
                        
                        // Only update if we have the right number of items
                        if (newOrder.length === selectedImages.length) {
                            selectedImages = newOrder;
                            
                            // Update the hidden inputs without rebuilding UI
                            if (selectedImages.length > 0) {
                                // Update primary image input
                                const primaryImageInput = document.getElementById('primary-image-input');
                                if (primaryImageInput) {
                                    primaryImageInput.value = selectedImages[0].url;
                                }
                                
                                // Update additional images input
                                const additionalImagesInput = document.getElementById('additional-images-input');
                                if (additionalImagesInput && selectedImages.length > 1) {
                                    const additionalUrls = selectedImages.slice(1).map(img => img.url).join('\n');
                                    additionalImagesInput.value = additionalUrls;
                                }
                                
                                // Update visual indicators (primary vs additional)
                                const imageItems = sortableContainer.querySelectorAll('[data-index]');
                                imageItems.forEach((item, idx) => {
                                    // Update data-index attributes
                                    item.dataset.index = idx;
                                    
                                    // Update primary/additional status
                                    const isPrimary = idx === 0;
                                    const imageContainer = item.querySelector('.aspect-w-1');
                                    if (imageContainer) {
                                        if (isPrimary) {
                                            imageContainer.classList.add('border-blue-500', 'ring-2', 'ring-blue-300');
                                            imageContainer.classList.remove('border-gray-300');
                                        } else {
                                            imageContainer.classList.remove('border-blue-500', 'ring-2', 'ring-blue-300');
                                            imageContainer.classList.add('border-gray-300');
                                        }
                                    }
                                    
                                    // Update status text
                                    const statusText = item.querySelector('.absolute.bottom-0 span');
                                    if (statusText) {
                                        statusText.textContent = isPrimary ? 'Primary' : `Additional ${idx}`;
                                    }
                                });
                            }
                        }
                    }
                });
            }
        } else {
            // No selected images, show the message
            dropboxElements.noSelection.classList.remove('hidden');
            
            // Clear hidden inputs
            const primaryImageInput = document.getElementById('primary-image-input');
            if (primaryImageInput) primaryImageInput.value = '';
            
            const additionalImagesInput = document.getElementById('additional-images-input');
            if (additionalImagesInput) additionalImagesInput.value = '';
        }
    }

    // New helper function to update the visual state in the Dropbox browser
    function updateDropboxBrowserSelectionState() {
        // Get all the image items in the Dropbox browser
        const dropboxImages = document.querySelectorAll('#dropbox-items [data-image-url]');
        
        dropboxImages.forEach(imageItem => {
            const imageUrl = imageItem.dataset.imageUrl;
            const isSelected = selectedImages.some(img => img.url === imageUrl);
            
            // Update the visual state
            if (isSelected) {
                imageItem.classList.add('ring-2', 'ring-green-500');
                
                // Add checkmark if it doesn't exist
                if (!imageItem.querySelector('.absolute.top-2.right-2')) {
                    const checkmark = document.createElement('div');
                    checkmark.className = 'absolute top-2 right-2';
                    checkmark.innerHTML = `
                        <span class="bg-green-500 text-white rounded-full p-1 flex items-center justify-center w-6 h-6">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </span>
                    `;
                    imageItem.querySelector('.h-full').appendChild(checkmark);
                }
            } else {
                imageItem.classList.remove('ring-2', 'ring-green-500');
                const checkmark = imageItem.querySelector('.absolute.top-2.right-2');
                if (checkmark) checkmark.remove();
            }
        });
    }

    function updateImagePreview() {
        const imagePreview = document.getElementById('imagePreview');
        if (!imagePreview) return;
        
        // Clear all existing previews (whether Dropbox or file uploads)
        imagePreview.innerHTML = '';
        
        if (selectedImages.length === 0) {
            // If no images selected, show a placeholder message
            const placeholder = document.createElement('div');
            placeholder.className = 'col-span-full text-center py-6 text-gray-500 border border-dashed rounded-lg';
            placeholder.textContent = 'No images selected. Please upload files, enter URLs, or select from Dropbox.';
            imagePreview.appendChild(placeholder);
            // ADDED: Update the visual state in the Dropbox browser
            updateDropboxBrowserSelectionState();
            return;
        }
        
        // Add all selected images to the preview
        selectedImages.forEach((image, index) => {
            const isPrimary = index === 0;
            const preview = document.createElement('div');
            preview.className = 'relative aspect-square';
            preview.setAttribute('data-source', 'dropbox');
            preview.setAttribute('data-index', index);
            
            preview.innerHTML = `
                <img src="${image.url}" 
                    class="w-full h-full object-cover rounded-lg shadow-sm ${isPrimary ? 'ring-2 ring-blue-500' : ''}"
                    alt="${isPrimary ? 'Primary' : 'Additional'} Image">
                <div class="absolute top-1 right-1">
                    <button type="button" class="remove-image bg-red-500 text-white rounded-full p-1 hover:bg-red-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="absolute bottom-1 left-1 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded">
                    ${isPrimary ? 'Primary' : `Additional ${index}`}
                </div>
            `;
            
            // Add event listener to remove button
            preview.querySelector('.remove-image').addEventListener('click', function() {
                selectedImages.splice(index, 1);
                updateImagePreview();
                updateHiddenInputs();
            });
                
            imagePreview.appendChild(preview);
        });
        
        // Initialize Sortable on the main image preview container
        if (window.Sortable) {
            if (imagePreview._sortable) {
                imagePreview._sortable.destroy();
            }
            
            imagePreview._sortable = new Sortable(imagePreview, {
                animation: 150,
                ghostClass: 'bg-blue-100',
                onEnd: function() {
                    // Get new order from DOM
                    const newOrder = [];
                    const items = imagePreview.querySelectorAll('[data-index]');
                    
                    items.forEach(item => {
                        const oldIndex = parseInt(item.dataset.index);
                        if (!isNaN(oldIndex) && oldIndex >= 0 && oldIndex < selectedImages.length) {
                            newOrder.push(selectedImages[oldIndex]);
                        }
                    });
                    
                    // Only update if we have the right number of items
                    if (newOrder.length === selectedImages.length) {
                        selectedImages = newOrder;
                        updateImagePreview();
                        updateHiddenInputs();
                    }
                }
            });
        }
    }


    function initializeDropboxWithFallback() {
    // Try to load Dropbox folders
    fetch('/inventory/api/dropbox/folders?path=')
        .then(response => {
            if (!response.ok && response.status !== 202) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // If there's an error message, show it
            if (data.error || data.status === 'error') {
                throw new Error(data.message || 'Error loading Dropbox');
            }
        })
        .catch(error => {
            console.error('Dropbox error:', error);
            // Provide a fallback UI for Dropbox tab
            const dropboxTab = document.getElementById('content-dropbox');
            if (dropboxTab) {
                dropboxTab.innerHTML = `
                    <div class="p-4 border rounded bg-yellow-50">
                        <h3 class="font-medium text-yellow-800">Dropbox Integration Unavailable</h3>
                        <p class="text-yellow-700 mt-2">The Dropbox integration is currently unavailable. Please use direct file upload instead.</p>
                        <button type="button" class="mt-3 px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600" 
                            onclick="document.getElementById('tab-upload').click()">
                            Switch to File Upload
                        </button>
                    </div>
                `;
            }
            
            // Switch to upload tab
            document.getElementById('tab-upload')?.click();
        });
}


    // Call this function on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Dropbox with fallback
        initializeDropboxWithFallback();
    });

    // Initialize tabs if they exist
    if (document.getElementById('tab-upload') && !document.getElementById('content-dropbox')) {
        console.warn('Dropbox content tab not found. Make sure to add the HTML.');
    }

    function setupDropboxTabs() {
        const dropboxTab = document.getElementById('tab-dropbox');
        const uploadTab = document.getElementById('tab-upload');
        const urlTab = document.getElementById('tab-url');
    
        // Exit if tabs not found
        if (!uploadTab || !urlTab || !dropboxTab) {
            console.warn('Tab elements not found');
            return;
        }
    
        const contentUpload = document.getElementById('content-upload');
        const contentUrl = document.getElementById('content-url');
        const contentDropbox = document.getElementById('content-dropbox');
    
        // Exit if content not found
        if (!contentUpload || !contentUrl || !contentDropbox) {
            console.warn('Content elements not found');
            return;
        }
    
    // Show dropbox tab by default
    dropboxTab.classList.add('active-tab');
    contentDropbox.classList.remove('hidden');
    contentUpload.classList.add('hidden');
    contentUrl.classList.add('hidden');
    
    // Load Dropbox folders when page loads
    loadDropboxFolders();
    
    // Dropbox tab click handler
    dropboxTab.addEventListener('click', function() {
        dropboxTab.classList.add('active-tab');
        uploadTab.classList.remove('active-tab');
        urlTab.classList.remove('active-tab');
        
        contentDropbox.classList.remove('hidden');
        contentUpload.classList.add('hidden');
        contentUrl.classList.add('hidden');
        
        // Refresh Dropbox contents if needed
        if (currentPath) {
            loadDropboxFolders(currentPath);
        } else {
            loadDropboxFolders();
        }
    });
    
    // Upload tab click handler
    uploadTab.addEventListener('click', function() {
        uploadTab.classList.add('active-tab');
        urlTab.classList.remove('active-tab');
        dropboxTab.classList.remove('active-tab');
        
        contentUpload.classList.remove('hidden');
        contentUrl.classList.add('hidden');
        contentDropbox.classList.add('hidden');
    });
    
    // URL tab click handler
    urlTab.addEventListener('click', function() {
        uploadTab.classList.remove('active-tab');
        urlTab.classList.add('active-tab');
        dropboxTab.classList.remove('active-tab');
        
        contentUpload.classList.add('hidden');
        contentUrl.classList.remove('hidden');
        contentDropbox.classList.add('hidden');
    });
}

    // When DOM is loaded, setup the tab functionality - this is a redundant check that's helpful
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setupDropboxTabs();
    } 
    else {
        document.addEventListener('DOMContentLoaded', setupDropboxTabs);
    }

   
});

// SECTION: Form Controls
// =====================================================

// Handle sync radio buttons
const syncAllYes = document.getElementById('sync_all_yes');
const syncAllNo = document.getElementById('sync_all_no');
const platformSelection = document.getElementById('platform-selection');

if (syncAllYes && syncAllNo && platformSelection) {
    syncAllYes.addEventListener('change', function() {
        if (this.checked) {
            platformSelection.classList.add('hidden');
        }
    });
    
    syncAllNo.addEventListener('change', function() {
        if (this.checked) {
            platformSelection.classList.remove('hidden');
        }
    });
}

// Make sure form submission includes the selected platforms
document.getElementById('addProductForm').addEventListener('submit', function(e) {
    if (document.getElementById('sync_all_no') && document.getElementById('sync_all_no').checked) {
        const selectedPlatforms = Array.from(
            document.querySelectorAll('input[name="sync_platforms"]:checked')
        ).map(cb => cb.value);
        
        if (selectedPlatforms.length === 0) {
            e.preventDefault();
            alert('Please select at least one platform to sync with, or choose "Sync All Platforms"');
        }
    }
});

// Auto-generate SEO keywords
document.getElementById('generate-seo')?.addEventListener('click', function() {
    const brand = document.getElementById('brand')?.value || '';
    const model = document.getElementById('model')?.value || '';
    const category = document.getElementById('category')?.value || '';
    const finish = document.getElementById('finish')?.value || '';
    
    // Generate keywords from product info
    const keywords = [brand, model, category, finish, 'vintage', 'guitar']
        .filter(word => word && word.trim() !== '')  // Remove empty values
        .map(word => word.trim().toLowerCase())      // Standardize format
        .filter((word, index, self) => self.indexOf(word) === index); // Remove duplicates
    
    // Set the keywords field
    const keywordsField = document.getElementById('website_seo_keywords');
    if (keywordsField) {
        keywordsField.value = keywords.join(', ');
    }
});

// SECTION: Price Handling
// =====================================================

// Price formatting and calculation functions
function formatPrice(price) {
    // Format a number as currency with comma separators
    return new Intl.NumberFormat('en-GB', { 
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(price);
}

function parsePrice(formattedPrice) {
    // Parse a formatted price back to a number
    if (!formattedPrice) return 0;
    return parseFloat(formattedPrice.replace(/[^0-9.-]+/g, ""));
}

function calculateEbayPrice(basePrice) {
    // 5% higher than base price
    return Math.round(basePrice * 1.05);
}

function calculateReverbPrice(basePrice) {
    // Add 5%, then round to banner price (£xx9)
    const withMargin = basePrice * 1.05;
    
    // Round up to the nearest 100
    let roundedUp = Math.ceil(withMargin / 100) * 100;
    
    // Subtract 1 to get banner price
    return roundedUp - 1;
}

function calculateVRPrice(basePrice) {
    // 5% higher than base price
    return Math.round(basePrice * 1.05);
}

function calculateWebsitePrice(basePrice) {
    // Same as base price
    return basePrice;
}

// Initialize and update prices
const basePriceDisplay = document.getElementById('base_price_display');
const basePrice = document.getElementById('base_price');

if (basePriceDisplay && basePrice) {
    // Format the initial value
    if (basePrice.value) {
        basePriceDisplay.value = formatPrice(parseFloat(basePrice.value));
    }
    
    // Update when price changes
    basePriceDisplay.addEventListener('input', function() {
        const numericValue = parsePrice(this.value);
        basePrice.value = numericValue;
        
        // Update platform prices
        updatePlatformPrices(numericValue);
    });
    
    // Also trigger on blur to ensure formatting
    basePriceDisplay.addEventListener('blur', function() {
        const numericValue = parsePrice(this.value);
        if (numericValue > 0) {
            this.value = formatPrice(numericValue);
        }
        basePrice.value = numericValue;
    });
    
    // Initial calculation of platform prices
    updatePlatformPrices(parsePrice(basePriceDisplay.value));
}

function updatePlatformPrices(basePrice) {
    if (!basePrice || isNaN(basePrice) || basePrice <= 0) {
        return;
    }
    
    // eBay price
    const ebayPrice = calculateEbayPrice(basePrice);
    document.getElementById('ebay_price').value = ebayPrice;
    document.getElementById('ebay_price_display').value = formatPrice(ebayPrice);
    
    // Reverb price
    const reverbPrice = calculateReverbPrice(basePrice);
    document.getElementById('reverb_price').value = reverbPrice;
    document.getElementById('reverb_price_display').value = formatPrice(reverbPrice);
    
    // V&R price
    const vrPrice = calculateVRPrice(basePrice);
    document.getElementById('vr_price').value = vrPrice;
    document.getElementById('vr_price_display').value = formatPrice(vrPrice);
    
    // Website price (same as base)
    document.getElementById('website_price').value = basePrice;
    document.getElementById('website_price_display').value = formatPrice(basePrice);
}

// Make platform price fields updatable but also format them on blur
['ebay_price_display', 'reverb_price_display', 'vr_price_display', 'website_price_display'].forEach(id => {
    const displayField = document.getElementById(id);
    const valueField = document.getElementById(id.replace('_display', ''));
    
    if (displayField && valueField) {
        displayField.addEventListener('input', function() {
            valueField.value = parsePrice(this.value);
        });
        
        displayField.addEventListener('blur', function() {
            const numericValue = parsePrice(this.value);
            if (numericValue > 0) {
                this.value = formatPrice(numericValue);
            }
            valueField.value = numericValue;
        });
    }
});

document.addEventListener('DOMContentLoaded', function() {
    // Create a sticky header for the top section
    const headerElement = document.querySelector('.bg-gray-50.border-b');
    const contentContainer = document.querySelector('.container');
    
    if (headerElement) {
        // Get initial offset position of the header
        const headerOffsetTop = headerElement.offsetTop;
        
        // Function to handle scroll event
        function handleScroll() {
            if (window.pageYOffset > headerOffsetTop) {
                // Add sticky class when scrolled past the header position
                headerElement.classList.add('sticky', 'top-0', 'z-50', 'shadow-md', 'w-full');
                
                // Add padding to container to prevent content jump
                if (!headerElement.classList.contains('is-sticky')) {
                    headerElement.classList.add('is-sticky');
                    contentContainer.style.paddingTop = `${headerElement.offsetHeight}px`;
                }
            } else {
                // Remove sticky class when scrolled back up
                headerElement.classList.remove('sticky', 'top-0', 'z-50', 'shadow-md', 'is-sticky');
                contentContainer.style.paddingTop = '0';
            }
        }
        
        // Attach scroll event listener
        window.addEventListener('scroll', handleScroll);
    }
});

// Fix for the Dropbox integration with fallback
function initializeDropboxWithFallback() {
    // Try to load Dropbox folders
    fetch('/inventory/api/dropbox/folders?path=')
        .then(response => {
            if (!response.ok && response.status !== 202) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // If there's an error message, show it
            if (data.error || data.status === 'error') {
                throw new Error(data.message || 'Error loading Dropbox');
            }
        })
        .catch(error => {
            console.error('Dropbox error:', error);
            // Provide a fallback UI for Dropbox tab
            const dropboxTab = document.getElementById('content-dropbox');
            if (dropboxTab) {
                dropboxTab.innerHTML = `
                    <div class="p-4 border rounded bg-yellow-50">
                        <h3 class="font-medium text-yellow-800">Dropbox Integration Unavailable</h3>
                        <p class="text-yellow-700 mt-2">The Dropbox integration is currently unavailable. Please use direct file upload instead.</p>
                        <button type="button" class="mt-3 px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600" 
                            onclick="document.getElementById('tab-upload').click()">
                            Switch to File Upload
                        </button>
                    </div>
                `;
            }
            
            // Switch to upload tab
            document.getElementById('tab-upload')?.click();
        });
}

document.addEventListener('DOMContentLoaded', function() {
    // You might already have a DOMContentLoaded handler
    // In that case, add the function call inside your existing handler
    initializeDropboxWithFallback();
});

// SECTION: Shipping
// =====================================================

// Shipping Profile Management
document.addEventListener('DOMContentLoaded', function() {
    const shippingProfileSelect = document.getElementById('shipping_profile');
    const lengthInput = document.getElementById('length');
    const widthInput = document.getElementById('width');
    const heightInput = document.getElementById('height');
    const weightInput = document.getElementById('weight');
    const carriersCheckboxes = document.querySelectorAll('input[name="carriers"]');
    const manageProfilesBtn = document.getElementById('manage-profiles');

    // Load shipping profiles from API - call this directly
    loadShippingProfiles();
    
    // Manage profiles button
    if (manageProfilesBtn) {
        manageProfilesBtn.addEventListener('click', function() {
            // In a real implementation, this would open a modal to manage profiles
            alert('Profile management would open here. This would be connected to a database of shipping profiles.');
        });
    }

    // Load shipping profiles from API
    async function loadShippingProfiles() {
        if (!shippingProfileSelect) return;
        
        console.log("Loading shipping profiles from API...");
        
        try {
            const response = await fetch('/inventory/shipping-profiles');
            console.log("API response status:", response.status);
            
            if (!response.ok) throw new Error('Failed to load shipping profiles');
            
            const profiles = await response.json();
            console.log("Profiles loaded:", profiles.length);
            
            // Clear existing options except the first one
            while (shippingProfileSelect.options.length > 1) {
                shippingProfileSelect.options.remove(1);
            }
            
            // Add profiles from API
            profiles.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.id;
                option.textContent = profile.name;
                
                // Store profile data in the option's dataset
                option.dataset.profile = JSON.stringify({
                    dimensions: profile.dimensions,
                    weight: profile.weight,
                    carriers: profile.carriers,
                    options: profile.options,
                    rates: profile.rates
                });
                
                shippingProfileSelect.appendChild(option);
            });
            
            console.log(`Added ${profiles.length} shipping profiles to dropdown`);
        } catch (error) {
            console.error('Error loading shipping profiles:', error);
        }
    }

    // When a profile is selected, apply its values
    if (shippingProfileSelect) {
        shippingProfileSelect.addEventListener('change', function() {
            console.log("Profile selected:", this.value);
            const selectedOption = this.options[this.selectedIndex];
            if (!selectedOption || !selectedOption.dataset.profile) return;
            
            try {
                const profile = JSON.parse(selectedOption.dataset.profile);
                
                // Apply dimensions - using the JSONB structure from database
                if (profile.dimensions) {
                    if (lengthInput) lengthInput.value = profile.dimensions.length || '';
                    if (widthInput) widthInput.value = profile.dimensions.width || '';
                    if (heightInput) heightInput.value = profile.dimensions.height || '';
                }
                
                // Apply weight
                if (weightInput) weightInput.value = profile.weight || '';
                
                // Apply carrier (now a single radio button)
                if (profile.carriers && profile.carriers.length > 0) {
                    const carrierRadio = document.querySelector(`input[name="carrier"][value="${profile.carriers[0]}"]`);
                    if (carrierRadio) carrierRadio.checked = true;
                }
                
                // Apply options (from JSONB options object)
                if (profile.options) {
                    const reqSigCheckbox = document.getElementById('require_signature');
                    const insuranceCheckbox = document.getElementById('insurance');
                    const fragileCheckbox = document.getElementById('fragile');
                    
                    if (reqSigCheckbox) reqSigCheckbox.checked = !!profile.options.require_signature;
                    if (insuranceCheckbox) insuranceCheckbox.checked = !!profile.options.insurance;
                    if (fragileCheckbox) fragileCheckbox.checked = !!profile.options.fragile;
                }
                
                // Apply rates (from JSONB rates object)
                if (profile.rates) {
                    const ukRateInput = document.querySelector('input[name="uk_rate"]');
                    const europeRateInput = document.querySelector('input[name="europe_rate"]');
                    const usaRateInput = document.querySelector('input[name="usa_rate"]');
                    const rowRateInput = document.querySelector('input[name="row_rate"]');
                    
                    if (ukRateInput) ukRateInput.value = profile.rates.uk || '';
                    if (europeRateInput) europeRateInput.value = profile.rates.europe || '';
                    if (usaRateInput) usaRateInput.value = profile.rates.usa || '';
                    if (rowRateInput) rowRateInput.value = profile.rates.row || '';
                }
                
            } catch (error) {
                console.error('Error applying profile data:', error);
            }
        });
    }
});

//     // Define shipping profiles
//     const shippingProfiles = {

//         'standard': {
//             dimensions: { length: '', width: '', height: '' },
//             weight: '',
//             carriers: ['dhl', 'fedex', 'ups'],
//             options: { require_signature: false, insurance: false, fragile: false },
//             rates: { uk: '10.00', europe: '20.00', usa: '35.00', row: '45.00' }
//         },
//         'guitars_large': {
//             dimensions: { length: '130', width: '40', height: '15' },
//             weight: '7',
//             carriers: ['dhl', 'fedex'],
//             options: { require_signature: true, insurance: true, fragile: true },
//             rates: { uk: '25.00', europe: '50.00', usa: '75.00', row: '90.00' }
//         },
//         'guitars_small': {
//             dimensions: { length: '110', width: '35', height: '12' },
//             weight: '5',
//             carriers: ['dhl', 'ups'],
//             options: { require_signature: true, insurance: true, fragile: true },
//             rates: { uk: '20.00', europe: '40.00', usa: '60.00', row: '75.00' }
//         },
//         'fragile': {
//             dimensions: { length: '', width: '', height: '' },
//             weight: '',
//             carriers: ['dhl'],
//             options: { require_signature: true, insurance: true, fragile: true },
//             rates: { uk: '15.00', europe: '30.00', usa: '45.00', row: '60.00' }
//         },
//         'international': {
//             dimensions: { length: '', width: '', height: '' },
//             weight: '',
//             carriers: ['dhl', 'fedex'],
//             options: { require_signature: true, insurance: true, fragile: false },
//             rates: { uk: '12.00', europe: '25.00', usa: '40.00', row: '50.00' }
//         }
//     };
    
//     // Package type presets
//     const packagePresets = {
//         'guitar_case': { length: '120', width: '40', height: '15', weight: '6' },
//         'pedal_small': { length: '15', width: '10', height: '5', weight: '0.5' },
//         'pedal_medium': { length: '25', width: '15', height: '10', weight: '1' },
//         'amp_head': { length: '60', width: '30', height: '25', weight: '10' },
//         'amp_combo': { length: '70', width: '50', height: '30', weight: '15' }
//     };
    
//     // Apply shipping profile
//     if (shippingProfileSelect) {
//         shippingProfileSelect.addEventListener('change', function() {
//             const profileName = this.value;
//             if (profileName && shippingProfiles[profileName]) {
//                 applyShippingProfile(shippingProfiles[profileName]);
//             }
//         });
//     }
    
//     // Apply package preset
//     if (packageTypeSelect) {
//         packageTypeSelect.addEventListener('change', function() {
//             const packageType = this.value;
//             if (packageType && packagePresets[packageType]) {
//                 applyPackagePreset(packagePresets[packageType]);
//             }
//         });
//     }
    
//     function applyShippingProfile(profile) {
//         // Apply dimensions if provided
//         if (profile.dimensions) {
//             if (lengthInput && profile.dimensions.length) lengthInput.value = profile.dimensions.length;
//             if (widthInput && profile.dimensions.width) widthInput.value = profile.dimensions.width;
//             if (heightInput && profile.dimensions.height) heightInput.value = profile.dimensions.height;
//         }
        
//         // Apply weight if provided
//         if (weightInput && profile.weight) weightInput.value = profile.weight;
        
//         // Check/uncheck carriers
//         carriersCheckboxes.forEach(checkbox => {
//             checkbox.checked = profile.carriers.includes(checkbox.value);
//         });
        
//         // Set shipping options
//         if (profile.options) {
//             Object.keys(profile.options).forEach(option => {
//                 const checkbox = document.getElementById(option);
//                 if (checkbox) checkbox.checked = profile.options[option];
//             });
//         }
        
//         // Set regional rates
//         if (profile.rates) {
//             Object.keys(profile.rates).forEach(region => {
//                 const input = document.querySelector(`input[name="${region}_rate"]`);
//                 if (input) input.value = profile.rates[region];
//             });
//         }
//     }
    
//     function applyPackagePreset(preset) {
//         if (lengthInput) lengthInput.value = preset.length;
//         if (widthInput) widthInput.value = preset.width;
//         if (heightInput) heightInput.value = preset.height;
//         if (weightInput) weightInput.value = preset.weight;
//     }
    
//     // Load shipping profiles from API
//     async function loadShippingProfiles() {
//         const profileSelect = document.getElementById('shipping_profile');
//         if (!profileSelect) return;
        
//         try {
//             const response = await fetch('/inventory/shipping-profiles');
//             if (!response.ok) throw new Error('Failed to load shipping profiles');
            
//             const profiles = await response.json();
            
//             // Clear existing options except the first one
//             while (profileSelect.options.length > 1) {
//                 profileSelect.options.remove(1);
//             }
            
//             // Add profiles from API
//             profiles.forEach(profile => {
//                 const option = document.createElement('option');
//                 option.value = profile.id;
//                 option.textContent = profile.name;
                
//                 // Store profile data in the option's dataset
//                 // This now correctly handles the JSONB structure from the database
//                 option.dataset.profile = JSON.stringify({
//                     dimensions: profile.dimensions, // Already a JSON object from the database
//                     weight: profile.weight,
//                     carriers: profile.carriers,
//                     options: profile.options,
//                     rates: profile.rates
//                 });
                
//                 profileSelect.appendChild(option);
//             });
            
//             console.log(`Loaded ${profiles.length} shipping profiles`);
//         } catch (error) {
//             console.error('Error loading shipping profiles:', error);
//         }
//     }

//     // When a profile is selected, apply its values
//     document.getElementById('shipping_profile')?.addEventListener('change', function() {
//         const selectedOption = this.options[this.selectedIndex];
//         if (!selectedOption || !selectedOption.dataset.profile) return;
        
//         try {
//             const profile = JSON.parse(selectedOption.dataset.profile);
            
//             // Apply dimensions - using the JSONB structure from database
//             if (profile.dimensions) {
//                 document.getElementById('length').value = profile.dimensions.length || '';
//                 document.getElementById('width').value = profile.dimensions.width || '';
//                 document.getElementById('height').value = profile.dimensions.height || '';
//             }
            
//             // Apply weight
//             document.getElementById('weight').value = profile.weight || '';
            
//             // Apply carriers (as array in JSONB)
//             document.querySelectorAll('input[name="carriers"]').forEach(checkbox => {
//                 checkbox.checked = profile.carriers && profile.carriers.includes(checkbox.value);
//             });
            
//             // Apply options (from JSONB options object)
//             if (profile.options) {
//                 document.getElementById('require_signature').checked = !!profile.options.require_signature;
//                 document.getElementById('insurance').checked = !!profile.options.insurance;
//                 document.getElementById('fragile').checked = !!profile.options.fragile;
//             }
            
//             // Apply rates (from JSONB rates object)
//             if (profile.rates) {
//                 document.querySelector('input[name="uk_rate"]').value = profile.rates.uk || '';
//                 document.querySelector('input[name="europe_rate"]').value = profile.rates.europe || '';
//                 document.querySelector('input[name="usa_rate"]').value = profile.rates.usa || '';
//                 document.querySelector('input[name="row_rate"]').value = profile.rates.row || '';
//             }
            
//         } catch (error) {
//             console.error('Error applying profile data:', error);
//         }
//     });

//     // Initialize when document is ready
//     document.addEventListener('DOMContentLoaded', function() {
//         loadShippingProfiles();
//     }); 

//     // Manage profiles button
//     const manageProfilesBtn = document.getElementById('manage-profiles');
//     if (manageProfilesBtn) {
//         manageProfilesBtn.addEventListener('click', function() {
//             // In a real implementation, this would open a modal to manage profiles
//             alert('Profile management would open here. This would be connected to a database of shipping profiles.');
//         });
//     }
// });


</script>

<style>
    .transition-transform {
        transition: transform 0.2s ease-in-out;
    }
    
    .platform-tab.active {
        border-bottom-width: 2px;
        border-color: rgb(59, 130, 246);
        color: rgb(37, 99, 235);
        background-color: rgb(219, 234, 254);
    }
    
    /* Add spacing between form sections */
    .form-section {
        margin-bottom: 1.5rem;
    }
    
    /* Remove margin from the last section to avoid extra padding at the bottom */
    .form-section:last-child {
        margin-bottom: 0;
    }
    .tab-pane {
        display: none;
    }
    
    .tab-pane.active {
        display: block;
    }

    /* Add these styles to the <style> tag */
        .sticky {
        position: fixed;
        animation: slideDown 0.3s;
        width: 100%;
        background-color: white;
    }

    @keyframes slideDown {
        from {
            transform: translateY(-100%);
        }
        to {
            transform: translateY(0);
        }
    }

    .tab-button {
        min-width: 120px;
        display: inline-flex;
        justify-content: center;
    }

</style>
{% endblock %}