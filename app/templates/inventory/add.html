{% extends "base.html" %}

{% block title %}Add Product - Realtime Inventory Forms Flow{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
        <div class="max-w-6xl mx-auto">
            <!-- Modern Header -->
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
                <div class="bg-gradient-to-r from-indigo-600 to-blue-600 px-8 py-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <h1 class="text-3xl font-bold text-white">Add New Product</h1>
                            <p class="text-indigo-100 mt-1">Create a new inventory item with all details</p>
                        </div>
                        <a href="/inventory" 
                           class="inline-flex items-center px-4 py-2 bg-white/20 backdrop-blur border border-white/30 rounded-lg text-white hover:bg-white/30 transition-all duration-200">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                            </svg>
                            Back to Inventory
                        </a>
                    </div>
                </div>

                <!-- Quick Actions Bar -->
                <div class="px-8 py-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-gray-200">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-indigo-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"/>
                                    <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"/>
                                </svg>
                                <label class="text-sm font-semibold text-gray-700">Quick Copy:</label>
                            </div>
                            <select id="existingProduct"
                                    class="px-3 py-1.5 bg-white rounded-lg border border-gray-300 shadow-sm text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 min-w-[200px] max-w-[300px]">
                                <option value="">Select a product to copy...</option>
                    {% for product in existing_products|sort(attribute='brand') %}
                    <option value="{{ product.id }}" title="{{ product.brand or 'Unknown Brand' }} {{ product.model or '' }}">
                        {% set display_text = ((product.brand or "Unknown Brand") ~ " " ~ (product.model or "")) %}
                        {{ display_text|truncate(60, True, '...') }}
                    </option>
                    {% endfor %}
                            </select>
                            <button type="button" id="copyButton" 
                                class="inline-flex items-center px-4 py-1.5 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                                Copy
                            </button>

                            <!-- Draft Selector -->
                            <div class="ml-6 flex items-center">
                                <svg class="w-5 h-5 text-gray-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                                </svg>
                                <label class="text-sm font-semibold text-gray-700">Resume Draft:</label>
                                <select id="draftSelector"
                                        class="ml-2 px-3 py-1.5 bg-white rounded-lg border border-gray-300 shadow-sm text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 min-w-[200px] max-w-[250px]">
                                    <option value="">Select a draft...</option>
                                </select>
                                <button type="button" id="loadDraftButton"
                                    class="ml-2 inline-flex items-center px-4 py-1.5 bg-gray-600 text-white text-sm font-medium rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                                    </svg>
                                    Load Draft
                                </button>
                            </div>
                        </div>
                        <div class="text-sm text-gray-600">
                            <span id="copyStatus" class="inline-flex items-center"></span>
                        </div>
                    </div>
                </div>

        <!-- Error Messages (if any) -->
        {% if error %}
        <div class="p-4">
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                <span class="block sm:inline">{{ error }}</span>
            </div>
        </div>
        {% endif %}

                <form
                    method="POST" 
                    action="/inventory/add"
                    enctype="multipart/form-data" 
                    class="p-8"
                    id="addProductForm"
                    >

                    <!-- Form Sections -->
                    <div class="space-y-6">

                        <!-- Basic Info Section -->
                        <div class="form-section">
                            <button type="button" 
                                class="form-section-header group flex justify-between items-center w-full py-3 px-5 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-gray-100 hover:to-gray-150 rounded-xl transition-all duration-200">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center mr-3">
                                        <svg class="w-5 h-5 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"/>
                                        </svg>
                                    </div>
                                    <span class="text-lg font-semibold text-gray-800">Basic Information</span>
                                </div>
                                <svg class="form-section-icon w-5 h-5 text-gray-500 transform transition-transform group-hover:text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>
                            <div class="form-section-content p-6 bg-white border border-gray-200 rounded-xl mt-3 shadow-sm">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Brand Field -->
                                    <div class="group">
                                        <label class="flex items-center text-sm font-semibold text-gray-700 mb-2">
                                            <svg class="w-4 h-4 mr-1.5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"/>
                                            </svg>
                                            Brand
                                            <span id="brandVRStatus" class="ml-2 text-xs font-normal"></span>
                                        </label>
                                        <div class="relative">
                                            <input type="text" name="brand" id="brand" required
                                                list="brandsList"
                                                autocomplete="off"
                                                class="w-full px-4 py-2.5 bg-gray-50 border border-gray-300 rounded-lg focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all duration-200 pr-10"
                                                value="{{ form_data.brand if form_data else '' }}"
                                                placeholder="e.g., Fender, Gibson, Martin...">
                                            <datalist id="brandsList">
                                                {% for brand in existing_brands %}
                                                <option value="{{ brand }}">
                                                {% endfor %}
                                            </datalist>
                                            <!-- Brand validation spinner/checkmark -->
                                            <div id="brandValidationIcon" class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                                <!-- Will show spinner during check, then ✓ or ⚠️ -->
                                            </div>
                                        </div>
                                <!-- V&R brand warning -->
                                <div id="vrBrandWarning" class="mt-1 p-2 bg-yellow-50 border border-yellow-200 rounded-md hidden">
                                    <p class="text-xs text-yellow-800">
                                        <svg class="inline w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                        </svg>
                                        Brand '<span id="vrBrandName"></span>' not recognized by V&R. Will use 'Justin' for V&R listings.
                                    </p>
                                </div>
                                <!-- Hidden field to track V&R brand status -->
                                <input type="hidden" name="vr_brand_fallback" id="vrBrandFallback" value="false">
                                    </div>
                                    
                                    <!-- Model Field -->
                                    <div class="group">
                                        <label class="flex items-center text-sm font-semibold text-gray-700 mb-2">
                                            <svg class="w-4 h-4 mr-1.5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M7 2a1 1 0 00-.707 1.707L7 4.414v3.758a1 1 0 01-.293.707l-4 4C.817 14.769 2.156 18 4.828 18h10.343c2.673 0 4.012-3.231 2.122-5.121l-4-4A1 1 0 0113 8.172V4.414l.707-.707A1 1 0 0013 2H7zm2 6.172V4h2v4.172a3 3 0 00.879 2.12l1.027 1.028a4 4 0 00-2.171.102l-.47.156a4 4 0 01-2.53 0l-.563-.187a1.993 1.993 0 00-.114-.035l1.063-1.063A3 3 0 009 8.172z" clip-rule="evenodd"/>
                                            </svg>
                                            Model
                                        </label>
                                        <div class="relative">
                                            <input type="text" name="model" id="model" required
                                                class="w-full px-4 py-2.5 bg-gray-50 border border-gray-300 rounded-lg focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all duration-200"
                                                value="{{ form_data.model if form_data else '' }}"
                                                placeholder="e.g., Stratocaster, Les Paul, D-28..."
                                                autocomplete="off">
                                            <!-- Model suggestions dropdown -->
                                            <div id="modelSuggestions" class="absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-xl hidden max-h-60 overflow-y-auto">
                                            </div>
                                        </div>
                                        <p id="modelHint" class="mt-1 text-xs text-gray-500 italic"></p>
                                    </div>
                                    <!-- Category Field -->
                                    <div class="group">
                                        <label class="flex items-center text-sm font-semibold text-gray-700 mb-2">
                                            <svg class="w-4 h-4 mr-1.5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"/>
                                            </svg>
                                            Category
                                        </label>
                                        <input type="text" name="category" id="category" required list="categoriesList"
                                            class="w-full px-4 py-2.5 bg-gray-50 border border-gray-300 rounded-lg focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all duration-200"
                                            value="{{ form_data.category if form_data else '' }}"
                                            placeholder="Select or type category...">
                                        <datalist id="categoriesList">
                                            {% for category in categories %}
                                            <option value="{{ category }}">
                                            {% endfor %}
                                        </datalist>
                                    </div>
                                    <!-- SKU Field -->
                                    <div class="group">
                                        <label class="flex items-center text-sm font-semibold text-gray-700 mb-2">
                                            <svg class="w-4 h-4 mr-1.5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                                            </svg>
                                            SKU
                                        </label>
                                        <div class="flex space-x-2">
                                            <input type="text" name="sku" id="sku" required
                                                class="flex-1 px-4 py-2.5 bg-gray-50 border border-gray-300 rounded-lg focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all duration-200"
                                                value="{{ form_data.sku if form_data else '' }}"
                                                placeholder="RIFF-1xxxxxxx">
                                            <button type="button" id="generateSku"
                                                class="px-3 py-2.5 bg-gradient-to-r from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300 rounded-lg transition-all duration-200 group"
                                                title="Generate SKU">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600 group-hover:text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    <!-- Finish Field -->
                                    <div class="group">
                                        <label class="flex items-center text-sm font-semibold text-gray-700 mb-2">
                                            <svg class="w-4 h-4 mr-1.5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M5.05 3.636a1 1 0 010 1.414 7 7 0 000 9.9 1 1 0 01-1.414 1.414 9 9 0 010-12.728 1 1 0 011.414 0zm9.9 0a1 1 0 011.414 0 9 9 0 010 12.728 1 1 0 11-1.414-1.414 7 7 0 000-9.9 1 1 0 010-1.414zM7.879 6.464a1 1 0 010 1.414 3 3 0 000 4.243 1 1 0 01-1.415 1.414 5 5 0 010-7.07 1 1 0 011.415 0zm4.242 0a1 1 0 011.415 0 5 5 0 010 7.072 1 1 0 01-1.415-1.415 3 3 0 000-4.242 1 1 0 010-1.415zM10 9a1 1 0 011 1v.01a1 1 0 11-2 0V10a1 1 0 011-1z" clip-rule="evenodd"/>
                                            </svg>
                                            Finish
                                        </label>
                                        <input type="text" name="finish" id="finish"
                                            class="w-full px-4 py-2.5 bg-gray-50 border border-gray-300 rounded-lg focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all duration-200"
                                            value="{{ form_data.finish if form_data else '' }}"
                                            placeholder="e.g., Sunburst, Natural, Black...">
                                    </div>
                                    <!-- Year Field -->
                                    <div class="group">
                                        <label class="flex items-center text-sm font-semibold text-gray-700 mb-2">
                                            <svg class="w-4 h-4 mr-1.5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                                            </svg>
                                            Year
                                            <span class="ml-1 inline-flex items-center group relative">
                                                <svg class="w-4 h-4 text-gray-400 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                                                </svg>
                                                <span class="absolute left-0 bottom-full mb-2 w-48 p-2 bg-gray-900 text-white text-xs rounded shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                                    Enter the year of manufacture. Will automatically set the decade field.
                                                </span>
                                            </span>
                                        </label>
                                        <input type="number" name="year" id="year"
                                            class="w-full px-4 py-2.5 bg-gray-50 border border-gray-300 rounded-lg focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all duration-200"
                                            value="{{ form_data.year if form_data else '' }}"
                                            min="1900" max="2030"
                                            placeholder="e.g., 1965, 2020...">
                                    </div>
                                    <!-- Decade Field -->
                                    <div class="group">
                                        <label class="flex items-center text-sm font-semibold text-gray-700 mb-2">
                                            <svg class="w-4 h-4 mr-1.5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 1 1 0 000 2H6a2 2 0 00-2 2v6a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-1a1 1 0 100-2 2 2 0 012 2v8a2 2 0 01-2 2H6a2 2 0 01-2-2V5z" clip-rule="evenodd"/>
                                            </svg>
                                            Decade
                                            <span class="ml-1 inline-flex items-center group relative">
                                                <svg class="w-4 h-4 text-gray-400 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                                                </svg>
                                                <span class="absolute left-0 bottom-full mb-2 w-48 p-2 bg-gray-900 text-white text-xs rounded shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                                    Auto-populates from Year. Only select manually if year is unknown.
                                                </span>
                                            </span>
                                        </label>
                                        <select name="decade" id="decade"
                                            class="w-full px-4 py-2.5 bg-gray-50 border border-gray-300 rounded-lg focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all duration-200 appearance-none cursor-pointer">
                                            <option value="">-- Select Decade --</option>
                                            {% for decade in range(1920, 2030, 10) %}
                                            <option value="{{ decade }}">{{ decade }}s</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <!-- Title field - full width -->
                                    <div class="md:col-span-2 group">
                                        <label class="flex items-center text-sm font-semibold text-gray-700 mb-2">
                                            <svg class="w-4 h-4 mr-1.5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                                            </svg>
                                            Title
                                            <span class="ml-1 inline-flex items-center group relative">
                                                <svg class="w-4 h-4 text-gray-400 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                                                </svg>
                                                <span class="absolute left-0 bottom-full mb-2 w-48 p-2 bg-gray-900 text-white text-xs rounded shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                                    Auto-generates from Brand, Model, Finish, and Year. Can be manually edited.
                                                </span>
                                            </span>
                                        </label>
                                        <div class="flex space-x-2">
                                            <input type="text" name="title" id="title"
                                                class="flex-1 px-4 py-2.5 bg-gray-50 border border-gray-300 rounded-lg focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all duration-200"
                                                value="{{ form_data.title if form_data else '' }}"
                                                placeholder="Auto-generates from Brand, Model, Finish, Year">
                                            <button type="button" id="regenerateTitle"
                                                class="px-3 py-2.5 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-lg transition-all duration-200 group shadow-sm"
                                                title="Regenerate Title">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Description & Condition Section -->
                        <div class="form-section">
                            <button type="button" 
                                class="form-section-header group flex justify-between items-center w-full py-3 px-5 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-gray-100 hover:to-gray-150 rounded-xl transition-all duration-200">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-amber-100 rounded-lg flex items-center justify-center mr-3">
                                        <svg class="w-5 h-5 text-amber-600" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm3 1h6v4H7V5zm6 6H7v2h6v-2z" clip-rule="evenodd"/>
                                        </svg>
                                    </div>
                                    <span class="text-lg font-semibold text-gray-800">Description & Condition</span>
                                </div>
                                <svg class="form-section-icon w-5 h-5 text-gray-500 transform transition-transform group-hover:text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>
                            <div class="form-section-content p-6 bg-white border border-gray-200 rounded-xl mt-3 shadow-sm">
                        <div class="space-y-4">
                                    <div>
                                        <label class="flex items-center text-sm font-semibold text-gray-700 mb-2">
                                            <svg class="w-4 h-4 mr-1.5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                                            </svg>
                                            Description
                                        </label>
                                        <textarea name="description" id="description" rows="6"
                                            class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all duration-200 resize-none"
                                            placeholder="Enter a detailed description of the product...">{{ form_data.description if form_data else '' }}</textarea>
                                    </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label class="flex items-center text-sm font-semibold text-gray-700 mb-2">
                                                <svg class="w-4 h-4 mr-1.5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                                </svg>
                                                Condition
                                            </label>
                                            <select name="condition" id="condition" required
                                                class="w-full px-4 py-2.5 bg-gray-50 border border-gray-300 rounded-lg focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all duration-200 appearance-none cursor-pointer">
                                                <option value="NEW" {% if form_data and form_data.condition == 'NEW' %}selected{% endif %}>✨ NEW</option>
                                                <option value="EXCELLENT" {% if form_data and form_data.condition == 'EXCELLENT' %}selected{% endif %}>🌟 EXCELLENT</option>
                                                <option value="VERYGOOD" {% if form_data and form_data.condition == 'VERYGOOD' %}selected{% endif %}>⭐ VERY GOOD</option>
                                                <option value="GOOD" {% if form_data and form_data.condition == 'GOOD' %}selected{% endif %}>👍 GOOD</option>
                                                <option value="FAIR" {% if form_data and form_data.condition == 'FAIR' %}selected{% endif %}>👌 FAIR</option>
                                                <option value="POOR" {% if form_data and form_data.condition == 'POOR' %}selected{% endif %}>⚠️ POOR</option>
                                            </select>
                                        </div>
                                <div class="group">
                                    <label class="flex items-center text-sm font-semibold text-gray-700 mb-2">
                                        <svg class="w-4 h-4 mr-1.5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                                        </svg>
                                        Status
                                    </label>
                                    <select name="status" id="status" required
                                        class="w-full px-4 py-2.5 bg-gray-50 border border-gray-300 rounded-lg focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all duration-200"
                                        style="font-size: 16px;">
                                        <option value="DRAFT" {% if not form_data or form_data.status == 'DRAFT' %}selected{% endif %}>📝 Draft</option>
                                        <option value="ACTIVE" {% if form_data and form_data.status == 'ACTIVE' %}selected{% endif %}>✅ Active</option>
                                        <option value="ARCHIVED" {% if form_data and form_data.status == 'ARCHIVED' %}selected{% endif %}>📦 Archived</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pricing & Inventory Section -->
                <div class="form-section">
                    <button type="button" 
                        class="form-section-header group flex justify-between items-center w-full py-3 px-5 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-gray-100 hover:to-gray-150 rounded-xl transition-all duration-200">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/>
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-lg font-semibold text-gray-800">Pricing & Inventory</span>
                        </div>
                        <svg class="form-section-icon w-5 h-5 text-gray-500 transform transition-transform group-hover:text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div class="form-section-content p-6 bg-white border border-gray-200 rounded-xl mt-3 shadow-sm">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Base Price <span class="text-xs font-normal text-gray-500">(inc. VAT)</span></label>
                                <div class="mt-1 relative rounded-md shadow-sm">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <span class="text-gray-500 sm:text-sm">£</span>
                                    </div>
                                    <input type="text" name="base_price_display" id="base_price_display" 
                                        class="pl-7 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                        value="{{ form_data.base_price if form_data else '' }}">
                                    <!-- Hidden field to store the actual numeric value -->
                                    <input type="hidden" name="base_price" id="base_price" value="{{ form_data.base_price if form_data else '' }}">
                                </div>
                            </div>
                            <!-- Hidden fields to keep backend compatibility -->
                            <input type="hidden" name="processing_time" id="processing_time" value="{{ form_data.processing_time if form_data else '3' }}">
                            <input type="hidden" name="collective_discount" id="collective_discount" value="{{ form_data.collective_discount if form_data else '0' }}">
                            <input type="hidden" name="offer_discount" id="offer_discount" value="{{ form_data.offer_discount if form_data else '0' }}">
                        </div>
                        
                        <!-- Has Inventory checkbox with Quantity field -->
                        <div class="mt-6 border-b pb-4">
                            <div class="flex items-start">
                                <div class="flex items-center">
                                    <input type="checkbox" name="is_stocked_item" id="is_stocked_item"
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        {% if form_data and form_data.is_stocked_item %}checked{% endif %}>
                                    <label for="is_stocked_item" class="ml-2 block text-sm font-medium text-gray-700">
                                        Has Inventory?
                                        <span class="ml-1 inline-flex items-center group relative">
                                            <svg class="w-4 h-4 text-gray-400 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                                            </svg>
                                            <span class="absolute left-0 bottom-full mb-2 w-64 p-2 bg-gray-900 text-white text-xs rounded shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                                Check this if you have multiple units of this item. Reveals quantity field for stock tracking.
                                            </span>
                                        </span>
                                    </label>
                                </div>
                                <!-- Quantity field - hidden by default -->
                                <div id="quantityField" class="ml-8 hidden">
                                    <label for="quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                                    <input type="number" name="quantity" id="quantity"
                                        class="mt-1 block w-20 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                        value="{{ form_data.quantity if form_data else '1' }}"
                                        min="1">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Other inventory-related checkboxes -->
                        <div class="mt-4">
                            <div class="flex space-x-6">
                                <div class="flex items-center">
                                    <input type="checkbox" name="in_collective" id="in_collective"
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        {% if form_data and form_data.in_collective %}checked{% endif %}>
                                    <label for="in_collective" class="ml-2 block text-sm text-gray-700">In Collective</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="in_inventory" id="in_inventory"
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        {% if form_data and form_data.in_inventory %}checked{% endif %} checked>
                                    <label for="in_inventory" class="ml-2 block text-sm text-gray-700">In Inventory</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="buy_now" id="buy_now"
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        {% if form_data and form_data.buy_now %}checked{% endif %} checked>
                                    <label for="buy_now" class="ml-2 block text-sm text-gray-700">Buy Now</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Always include VAT, so show_vat is always true -->
                        <input type="hidden" name="show_vat" id="show_vat" value="on">
                    </div>
                </div>

                <!-- Images & Media Section -->
                <div class="form-section">
                    <button type="button" 
                        class="form-section-header group flex justify-between items-center w-full py-3 px-5 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-gray-100 hover:to-gray-150 rounded-xl transition-all duration-200">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                                <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-lg font-semibold text-gray-800">Images & Media</span>
                            <span id="images-count" class="ml-2 text-sm text-gray-500"></span>
                        </div>
                        <svg class="form-section-icon w-5 h-5 text-gray-500 transform transition-transform group-hover:text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                <div class="form-section-content p-6 bg-white border border-gray-200 rounded-xl mt-3 shadow-sm">
                    <!-- Modern Tab Navigation -->
                    <div class="bg-gray-100 p-1 rounded-lg mb-6">
                        <div class="flex space-x-1">
                            <button type="button" id="tab-dropbox" class="tab-button flex-1 inline-flex items-center justify-center px-4 py-2.5 text-gray-600 hover:text-gray-800 font-medium rounded-md transition-all duration-200">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"/>
                                </svg>
                                Dropbox
                            </button>
                            <button type="button" id="tab-upload" class="tab-button flex-1 inline-flex items-center justify-center px-4 py-2.5 text-gray-600 hover:text-gray-800 font-medium rounded-md transition-all duration-200">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                                </svg>
                                Upload Files
                            </button>
                            <button type="button" id="tab-url" class="tab-button flex-1 inline-flex items-center justify-center px-4 py-2.5 text-gray-600 hover:text-gray-800 font-medium rounded-md transition-all duration-200">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/>
                                </svg>
                                Image URLs
                            </button>
                        </div>
                    </div>
                    
                    <!-- Upload Files Tab -->
                    <div id="content-upload" class="mt-4">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700">Upload Images <span id="file-count" class="text-gray-500"></span></label>
                            <input type="file" name="image_files" accept="image/*" multiple class="mt-1 block w-full" id="imageFiles">
                            <p class="mt-1 text-sm text-gray-500">Select files to add to your images. The first image will be used as the main product image.</p>
                        </div>
                    </div>
                    
                    <!-- Image URLs Tab -->
                    <div id="content-url" class="mt-4 hidden">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700">Image URLs</label>
                            <textarea name="image_urls" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Enter one URL per line. The first URL will be the main product image." id="imageUrls"></textarea>
                        </div>
                    </div>
                    
                    <!-- Dropbox Tab -->
                    <div id="content-dropbox" class="hidden">
                                        <!-- Navigation Bar -->
                                        <div class="bg-gray-50 rounded-lg p-3 mb-4">
                                            <div class="flex items-center space-x-2">
                                                <button type="button" id="dropbox-back" 
                                                        class="p-2 bg-white rounded-lg border border-gray-200 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200" 
                                                        disabled>
                                                    <svg class="h-4 w-4 text-gray-600" viewBox="0 0 20 20" fill="currentColor">
                                                        <path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                                                    </svg>
                                                </button>
                                                
                                                <div class="flex-grow bg-white rounded-lg border border-gray-200 px-3 py-2">
                                                    <div class="flex items-center">
                                                        <svg class="w-4 h-4 text-gray-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                                            <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"/>
                                                        </svg>
                                                        <span id="dropbox-current-path" class="text-sm font-medium text-gray-700">/</span>
                                                    </div>
                                                </div>
                                                
                                                <button type="button" id="dropbox-refresh" 
                                                        class="inline-flex items-center px-3 py-2 bg-white rounded-lg border border-gray-200 hover:bg-gray-50 transition-colors duration-200" 
                                                        title="Load or refresh images">
                                                    <svg class="h-4 w-4 text-gray-600 mr-1.5" viewBox="0 0 20 20" fill="currentColor">
                                                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                                                    </svg>
                                                    <span class="text-sm font-medium text-gray-700">Load</span>
                                                </button>
                                                
                                                <button type="button" 
                                                        id="dropbox-sync-now"
                                                        class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-indigo-500 to-indigo-600 text-white text-sm font-medium rounded-lg hover:from-indigo-600 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 shadow-sm"
                                                        title="Sync new images from Dropbox">
                                                    <svg class="h-4 w-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                                    </svg>
                                                    Sync
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Dropbox Browser -->
                                        <div class="bg-gray-50 rounded-lg p-4 min-h-[500px] max-h-[700px] overflow-y-auto" id="dropbox-browser">
                                            <!-- Initial state - prompt to use refresh button -->
                                            <div class="text-center py-12" id="dropbox-initial">
                                                <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"/>
                                                </svg>
                                                <p class="text-gray-600 mb-2">No images loaded</p>
                                                <p class="text-sm text-gray-500">Click the refresh button above to load images from Dropbox</p>
                                            </div>
                                            
                                            <!-- Loading state (hidden initially) -->
                                            <div class="text-center py-12 hidden" id="dropbox-loading">
                                                <svg class="animate-spin h-8 w-8 mx-auto mb-4 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                                <p class="text-gray-600 font-medium">Loading Dropbox folders...</p>
                                            </div>
                                            <div id="dropbox-items" class="grid grid-cols-5 gap-2 hidden"></div>
                                            <div class="text-center py-12 hidden" id="dropbox-empty">
                                                <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"/>
                                                </svg>
                                                <p class="text-gray-500">No folders or images found</p>
                                            </div>
                                            <div class="text-center py-12 hidden" id="dropbox-error">
                                                <svg class="w-12 h-12 mx-auto mb-4 text-red-300" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                                </svg>
                                                <p class="text-red-600 font-medium">Error loading Dropbox content</p>
                                            </div>
                                        </div>
                                        
                                        <!-- Select All Button -->
                                        <div class="flex justify-end mt-3">
                                            <button type="button" 
                                                    id="select-all-images" 
                                                    class="inline-flex items-center px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 hidden">
                                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 0016 0zm-8-3a1 1 0 00-.867 1.5 6 6 0 1011.734 0A1 1 0 0012 15H8z" clip-rule="evenodd"/>
                                                </svg>
                                                Select All Images
                                            </button>
                                        </div>
                                    </div>
                                    <!-- End of Dropbox Tab -->
                                    
                                    <!-- Selected Images Preview -->
                                    <div class="mt-6 bg-gray-50 rounded-lg p-4">
                                        <div class="flex items-center justify-between mb-3">
                                            <div>
                                                <h3 class="text-sm font-semibold text-gray-800">Selected Images</h3>
                                                <p class="text-xs text-gray-500 mt-0.5">Drag to reorder • First image is the primary</p>
                                            </div>
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800" id="imageCount">
                                                0 images
                                            </span>
                                        </div>
                                        <div id="imagePreview" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3 min-h-[120px] sortable-container">
                                            <div class="col-span-full flex flex-col items-center justify-center py-8 text-gray-400" id="noImagesPlaceholder">
                                                <svg class="w-10 h-10 mb-2" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                                                </svg>
                                                <p class="text-sm">No images selected</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Additional Media -->
                                    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="bg-gray-50 rounded-lg p-4">
                                            <label class="flex items-center text-sm font-semibold text-gray-700 mb-2">
                                                <svg class="w-4 h-4 mr-1.5 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"/>
                                                </svg>
                                                YouTube Video URL
                                            </label>
                                            <input type="text" name="video_url" id="video_url" 
                                                   placeholder="https://youtube.com/watch?v=..."
                                                   class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all duration-200">
                                        </div>
                                        
                                        <div class="bg-gray-50 rounded-lg p-4">
                                            <label class="flex items-center text-sm font-semibold text-gray-700 mb-2">
                                                <svg class="w-4 h-4 mr-1.5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/>
                                                </svg>
                                                External Link
                                            </label>
                                            <input type="text" name="external_link" id="external_link" 
                                                   placeholder="https://..."
                                                   class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all duration-200">
                                        </div>
                                    </div>
                                    
                                    <!-- Hidden inputs for storing selected Dropbox images -->
                                    <input type="hidden" id="primary-image-input" name="primary_image_url">
                                    <input type="hidden" id="additional-images-input" name="additional_images_urls">
                </div>
                </div>

                <!-- Shipping Section -->
                <div class="form-section">
                    <button type="button" 
                        class="form-section-header group flex justify-between items-center w-full py-3 px-5 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-gray-100 hover:to-gray-150 rounded-xl transition-all duration-200">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-teal-100 rounded-lg flex items-center justify-center mr-3">
                                <svg class="w-5 h-5 text-teal-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
                                    <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z"/>
                                </svg>
                            </div>
                            <span class="text-lg font-semibold text-gray-800">Shipping</span>
                        </div>
                        <svg class="form-section-icon w-5 h-5 text-gray-500 transform transition-transform group-hover:text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div class="form-section-content p-6 bg-white border border-gray-200 rounded-xl mt-3 shadow-sm">
                        <!-- Shipping Profile Selector - Full Width -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Shipping Profile</label>
                            <div class="flex items-center space-x-2">
                                <select id="shipping_profile" name="shipping_profile" required
                                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="">-- Select a profile --</option>
                                    <!-- Profiles loaded from API -->
                                </select>
                                <!-- Removing the Manage button as per your request -->
                            </div>
                            <p class="mt-2 text-sm text-gray-500">Select a predefined shipping profile or customize below</p>
                            <p id="shippingProfileError" class="mt-1 text-sm text-red-600 hidden">Please select a shipping profile to enable product creation.</p>
                        </div>

                        <!-- Dimensions and Weight in a single row -->
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                            <div class="md:col-span-1">
                                <label for="weight" class="block text-sm font-medium text-gray-700 mb-2">Weight</label>
                                <div class="relative rounded-md shadow-sm">
                                    <input type="text" name="weight" id="weight" 
                                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                        <span class="text-gray-500 sm:text-sm">kg</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="md:col-span-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Dimensions</label>
                                <div class="grid grid-cols-3 gap-3">
                                    <div>
                                        <div class="relative rounded-md shadow-sm">
                                            <input type="text" name="length" id="length" placeholder="Length" 
                                                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                                <span class="text-gray-500 sm:text-xs">cm</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="relative rounded-md shadow-sm">
                                            <input type="text" name="width" id="width" placeholder="Width"
                                                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                                <span class="text-gray-500 sm:text-xs">cm</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="relative rounded-md shadow-sm">
                                            <input type="text" name="height" id="height" placeholder="Height" 
                                                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                                <span class="text-gray-500 sm:text-xs">cm</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Carrier Selection - Using Radio Buttons -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Preferred Carrier</label>
                            <div class="bg-gray-50 p-4 rounded-lg grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="flex items-center">
                                    <input id="carrier_dhl" name="carrier" type="radio" value="dhl" 
                                        class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="carrier_dhl" class="ml-3 block text-sm text-gray-700">DHL</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="carrier_fedex" name="carrier" type="radio" value="fedex" 
                                        class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="carrier_fedex" class="ml-3 block text-sm text-gray-700">FedEx</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="carrier_tnt" name="carrier" type="radio" value="tnt" 
                                        class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="carrier_tnt" class="ml-3 block text-sm text-gray-700">TNT</label>
                                </div>
                            </div>
                        </div>

                        <!-- Shipping Options -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Shipping Options</label>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-gray-50 p-4 rounded-lg">
                                <div class="flex items-center">
                                    <input type="checkbox" name="free_shipping" id="free_shipping_option"
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        {% if form_data and form_data.free_shipping %}checked{% endif %}>
                                    <label for="free_shipping_option" class="ml-3 block text-sm text-gray-700">Free Shipping</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="local_pickup" id="local_pickup_option"
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        {% if form_data and form_data.local_pickup %}checked{% endif %}>
                                    <label for="local_pickup_option" class="ml-3 block text-sm text-gray-700">Local Pickup Available</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="available_for_shipment" id="available_for_shipment_option"
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        {% if form_data and form_data.available_for_shipment %}checked{% endif %} checked>
                                    <label for="available_for_shipment_option" class="ml-3 block text-sm text-gray-700">Available for Shipment</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="require_signature" name="require_signature" type="checkbox" 
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="require_signature" class="ml-3 block text-sm text-gray-700">Require Signature</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="insurance" name="insurance" type="checkbox" 
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="insurance" class="ml-3 block text-sm text-gray-700">Add Insurance</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="fragile" name="fragile" type="checkbox"
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="fragile" class="ml-3 block text-sm text-gray-700">Mark as Fragile</label>
                                </div>
                            </div>
                        </div>

                        <!-- Regional Rates -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Regional Shipping Rates</label>
                            <div class="overflow-x-auto bg-white border border-gray-200 rounded-lg">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Region</th>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rate (£)</th>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Processing Time</th>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Enabled</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">United Kingdom</td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <input type="text" name="uk_rate" class="w-24 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <select name="uk_processing" class="w-32 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                                    <option value="1-2">1-2 days</option>
                                                    <option value="3-5" selected>3-5 days</option>
                                                    <option value="5-7">5-7 days</option>
                                                </select>
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <input type="checkbox" name="uk_enabled" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                            </td>
                                        </tr>
                                        <!-- Additional rows for Europe, USA, and Rest of World follow the same pattern -->
                                        <tr>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">Europe</td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <input type="text" name="europe_rate" class="w-24 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <select name="europe_processing" class="w-32 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                                    <option value="3-5">3-5 days</option>
                                                    <option value="5-7" selected>5-7 days</option>
                                                    <option value="7-10">7-10 days</option>
                                                </select>
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <input type="checkbox" name="europe_enabled" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">USA</td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <input type="text" name="usa_rate" class="w-24 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <select name="usa_processing" class="w-32 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                                    <option value="5-7">5-7 days</option>
                                                    <option value="7-10" selected>7-10 days</option>
                                                    <option value="10-14">10-14 days</option>
                                                </select>
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <input type="checkbox" name="usa_enabled" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">Rest of World</td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <input type="text" name="row_rate" class="w-24 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <select name="row_processing" class="w-32 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                                    <option value="7-10">7-10 days</option>
                                                    <option value="10-14" selected>10-14 days</option>
                                                    <option value="14-21">14-21 days</option>
                                                </select>
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <input type="checkbox" name="row_enabled" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Platform-Specific Section -->
                <div class="form-section">
                    <button type="button" 
                        class="form-section-header group flex justify-between items-center w-full py-3 px-5 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-gray-100 hover:to-gray-150 rounded-xl transition-all duration-200">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z"/>
                                    <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z"/>
                                </svg>
                            </div>
                            <span class="text-lg font-semibold text-gray-800">Platform Settings</span>
                        </div>
                        <svg class="form-section-icon w-5 h-5 text-gray-500 transform transition-transform group-hover:text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div class="form-section-content p-6 bg-white border border-gray-200 rounded-xl mt-3 shadow-sm">
                        <!-- Platform Tabs -->
                        <div class="mb-4 border-b">
                            <ul class="flex flex-wrap -mb-px" id="platformTabs" role="tablist">
                                <li class="mr-2" role="presentation">
                                    <button class="inline-block py-2 px-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 platform-tab active" 
                                        id="shopify-tab" 
                                        data-target="shopifyTabContent" 
                                        type="button" 
                                        role="tab" 
                                        aria-selected="true">
                                        Shopify
                                    </button>
                                </li>
                                <li class="mr-2" role="presentation">
                                    <button class="inline-block py-2 px-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 platform-tab" 
                                        id="reverb-tab" 
                                        data-target="reverbTabContent" 
                                        type="button" 
                                        role="tab" 
                                        aria-selected="false">
                                        Reverb
                                    </button>
                                </li>
                                <li class="mr-2" role="presentation">
                                    <button class="inline-block py-2 px-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 platform-tab" 
                                        id="vr-tab" 
                                        data-target="vrTabContent" 
                                        type="button" 
                                        role="tab" 
                                        aria-selected="false">
                                        Vintage & Rare
                                    </button>
                                </li>
                                <li role="presentation">
                                    <button class="inline-block py-2 px-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 platform-tab" 
                                        id="ebay-tab" 
                                        data-target="ebayTabContent" 
                                        type="button" 
                                        role="tab" 
                                        aria-selected="false">
                                        eBay
                                    </button>
                                </li>
                            </ul>
                        </div>

                        <!-- Tab Content -->
                        <div class="tab-content">
                            <!-- eBay Tab Content -->
                            <div id="ebayTabContent" class="tab-pane hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">eBay Category</label>
                                        <select name="platform_data__ebay__category_id" id="ebay_category_id"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <option value="">-- Select eBay Category --</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">eBay Price</label>
                                        <div class="mt-1 relative rounded-md shadow-sm">
                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <span class="text-gray-500 sm:text-sm">£</span>
                                            </div>
                                            <input type="text" name="platform_data__ebay__price_display" id="ebay_price_display" 
                                                class="pl-7 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <input type="hidden" name="platform_data__ebay__price" id="ebay_price">
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">5% higher than base price</p>
                                    </div>
                                    <!-- Hidden eBay Format -->
                                    <div style="display: none;">
                                        <label class="block text-sm font-medium text-gray-700">eBay Format</label>
                                        <select name="platform_data__ebay__format" id="ebay_format"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <option value="FixedPrice">Buy It Now</option>
                                            <option value="Auction">Auction</option>
                                        </select>
                                    </div>
                                    <!-- Hidden eBay Duration -->
                                    <div style="display: none;">
                                        <label class="block text-sm font-medium text-gray-700">eBay Duration</label>
                                        <select name="platform_data__ebay__duration" id="ebay_duration"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <option value="GTC">Good 'Til Cancelled</option>
                                            <option value="Days_30">30 Days</option>
                                            <option value="Days_10">10 Days</option>
                                            <option value="Days_7">7 Days</option>
                                            <option value="Days_5">5 Days</option>
                                            <option value="Days_3">3 Days</option>
                                            <option value="Days_1">1 Day</option>
                                        </select>
                                    </div>
                                    <div class="flex items-center h-full pt-6">
                                        <input type="checkbox" name="platform_data__ebay__sync_inventory" id="ebay_sync_inventory"
                                            class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                        <label for="ebay_sync_inventory" class="ml-2 block text-sm text-gray-700">
                                            Sync inventory with eBay
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Reverb Tab Content -->
                            <div id="reverbTabContent" class="tab-pane hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="col-span-2">
                                        <label class="block text-sm font-medium text-gray-700">Reverb Category</label>
                                        <input type="text" id="reverb_primary_category"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                            placeholder="Populated from main category selection" readonly>
                                        <input type="hidden" name="platform_data__reverb__category_uuid" id="reverb_category_uuid">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Reverb Price</label>
                                        <div class="mt-1 relative rounded-md shadow-sm">
                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <span class="text-gray-500 sm:text-sm">£</span>
                                            </div>
                                            <input type="text" name="platform_data__reverb__price_display" id="reverb_price_display" 
                                                class="pl-7 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <input type="hidden" name="platform_data__reverb__price" id="reverb_price">
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">Banner price (£xx9)</p>
                                    </div>
                                    <div class="flex items-center h-full">
                                        <input type="checkbox" name="platform_data__reverb__offers_enabled" id="reverb_offers_enabled"
                                            class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                        <label for="reverb_offers_enabled" class="ml-2 block text-sm text-gray-700">
                                            Enable offers
                                        </label>
                                    </div>
                                    <div class="flex items-center h-full">
                                        <input type="checkbox" name="platform_data__reverb__draft_mode" id="reverb_draft_mode"
                                            class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                        <label for="reverb_draft_mode" class="ml-2 block text-sm text-gray-700">
                                            Create as draft (not live)
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Vintage & Rare Tab Content -->
                            <div id="vrTabContent" class="tab-pane hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">V&R Category</label>
                                        <select name="platform_data__vr__category" id="vr_category"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <option value="">-- Select V&R Category --</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">V&R Price</label>
                                        <div class="mt-1 relative rounded-md shadow-sm">
                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <span class="text-gray-500 sm:text-sm">£</span>
                                            </div>
                                            <input type="text" name="platform_data__vr__price_display" id="vr_price_display" 
                                                class="pl-7 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <input type="hidden" name="platform_data__vr__price" id="vr_price">
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">5% higher than base price</p>
                                    </div>
                                    <div class="col-span-2">
                                        <label class="block text-sm font-medium text-gray-700">V&R Special Notes</label>
                                        <textarea name="platform_data__vr__notes" id="vr_notes" rows="3"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Shopify Tab Content -->
                            <div id="shopifyTabContent" class="tab-pane active">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Shopify Category</label>
                                        <select name="platform_data__shopify__category" id="shopify_category"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <option value="">-- Select Shopify Category --</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Shopify Price</label>
                                        <div class="mt-1 relative rounded-md shadow-sm">
                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <span class="text-gray-500 sm:text-sm">£</span>
                                            </div>
                                            <input type="text" name="platform_data__shopify__price_display" id="shopify_price_display" 
                                                class="pl-7 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <input type="hidden" name="platform_data__shopify__price" id="shopify_price">
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">Same as base price</p>
                                    </div>
                                    <div class="col-span-2">
                                        <label class="block text-sm font-medium text-gray-700">
                                            SEO Keywords (comma separated)
                                        </label>
                                        <input type="text" name="platform_data__shopify__seo_keywords" id="shopify_seo_keywords"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                            placeholder="vintage, guitar, instrument">
                                    </div>
                                    <div class="col-span-2">
                                        <label class="block text-sm font-medium text-gray-700">Short Description (for listings)</label>
                                        <textarea name="platform_data__shopify__short_description" id="shopify_short_description" rows="2"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>


                <div class="form-section">
                    <button type="button" 
                        class="form-section-header group flex justify-between items-center w-full py-3 px-5 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-gray-100 hover:to-gray-150 rounded-xl transition-all duration-200">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-pink-100 rounded-lg flex items-center justify-center mr-3">
                                <svg class="w-5 h-5 text-pink-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-lg font-semibold text-gray-800">Platform Sync</span>
                        </div>
                        <svg class="form-section-icon w-5 h-5 text-gray-500 transform transition-transform group-hover:text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div class="form-section-content p-6 bg-white border border-gray-200 rounded-xl mt-3 shadow-sm">
                        <!-- Sync Options -->
                        <div class="mb-6">
                            <p class="text-sm text-gray-700 mb-3">Choose which platforms to sync this product with:</p>
                            
                            <div class="flex items-center space-x-4 mb-4">
                                <div class="flex items-center">
                                    <input type="radio" name="sync_all" id="sync_all_yes" value="true" checked
                                        class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="sync_all_yes" class="ml-2 block text-sm text-gray-700">Sync All Platforms</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" name="sync_all" id="sync_all_no" value="false"
                                        class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="sync_all_no" class="ml-2 block text-sm text-gray-700">Select Platforms</label>
                                </div>
                            </div>
                            
                            <!-- Platform selection (shown when "Select Platforms" is chosen) -->
                            <div id="platform-selection" class="mb-4 grid grid-cols-2 md:grid-cols-4 gap-4 hidden">
                                <div class="flex items-center">
                                    <input type="checkbox" name="sync_platforms" value="shopify" id="sync_shopify"
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="sync_shopify" class="ml-2 block text-sm text-gray-700">Shopify</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="sync_platforms" value="reverb" id="sync_reverb"
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="sync_reverb" class="ml-2 block text-sm text-gray-700">Reverb</label>
                                </div>
                                <div class="flex items-center" id="sync_vr_container">
                                    <input type="checkbox" name="sync_platforms" value="vr" id="sync_vr"
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="sync_vr" class="ml-2 block text-sm text-gray-700">Vintage & Rare</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="sync_platforms" value="ebay" id="sync_ebay"
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="sync_ebay" class="ml-2 block text-sm text-gray-700">eBay</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Platform Status -->
                        <div class="border-t pt-6">
                            <h4 class="text-sm font-semibold text-gray-700 mb-4">Sync Status</h4>
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
                                <!-- Shopify Status -->
                                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200" id="shopify-status-box">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-gray-700">Shopify</span>
                                        <div class="w-2 h-2 rounded-full {% if shopify_status == 'success' %}bg-green-500{% elif shopify_status == 'pending' %}bg-yellow-500{% else %}bg-gray-300{% endif %}"></div>
                                    </div>
                                    <p class="text-xs text-gray-500">{{ shopify_message or 'Not synced' }}</p>
                                </div>

                                <!-- Reverb Status -->
                                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200" id="reverb-status-box">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-gray-700">Reverb</span>
                                        <div class="w-2 h-2 rounded-full {% if reverb_status == 'success' %}bg-green-500{% elif reverb_status == 'pending' %}bg-yellow-500{% else %}bg-gray-300{% endif %}"></div>
                                    </div>
                                    <p class="text-xs text-gray-500">{{ reverb_message or 'Not synced' }}</p>
                                </div>

                                <!-- V&R Status -->
                                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200" id="vr-status-box">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-gray-700">V&R</span>
                                        <div class="w-2 h-2 rounded-full {% if vr_status == 'success' %}bg-green-500{% elif vr_status == 'pending' %}bg-yellow-500{% else %}bg-gray-300{% endif %}"></div>
                                    </div>
                                    <p class="text-xs text-gray-500">{{ vr_message or 'Not synced' }}</p>
                                </div>

                                <!-- eBay Status -->
                                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200" id="ebay-status-box">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-gray-700">eBay</span>
                                        <div class="w-2 h-2 rounded-full {% if ebay_status == 'success' %}bg-green-500{% elif ebay_status == 'pending' %}bg-yellow-500{% else %}bg-gray-300{% endif %}"></div>
                                    </div>
                                    <p class="text-xs text-gray-500">{{ ebay_message or 'Not synced' }}</p>
                                </div>
                            </div>
                            
                            <!-- Status Legend -->
                            <div class="mt-4 flex items-center justify-center space-x-4 text-xs text-gray-500">
                                <div class="flex items-center space-x-1">
                                    <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                    <span>Synced</span>
                                </div>
                                <div class="flex items-center space-x-1">
                                    <div class="w-2 h-2 bg-yellow-500 rounded-full"></div>
                                    <span>Pending</span>
                                </div>
                                <div class="flex items-center space-x-1">
                                    <div class="w-2 h-2 bg-gray-300 rounded-full"></div>
                                    <span>Not Synced</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Buttons -->
                <div class="flex justify-end mt-6 space-x-3">
                    <button type="button" id="saveDraftBtn"
                            class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 font-medium">
                        Save as Draft
                    </button>
                    <button type="submit" id="createProductBtn" disabled
                            class="bg-blue-600 text-white px-6 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 font-medium opacity-50 cursor-not-allowed">
                        Create Product
                    </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Store the last known category value to prevent it being cleared
let lastKnownCategoryValue = '';
const prefillDraftId = {{ prefill_draft_id if prefill_draft_id is not none else 'null' }};

document.addEventListener('DOMContentLoaded', function() {
    const shippingProfileSelect = document.getElementById('shipping_profile');
    const createProductBtn = document.getElementById('createProductBtn');
    const shippingProfileError = document.getElementById('shippingProfileError');
    let shippingProfilesLoaded = false;
    let shippingProfilesCache = [];

    function updateCreateButtonState() {
        if (!createProductBtn) {
            return;
        }

        const hasProfile = shippingProfileSelect && shippingProfileSelect.value && shippingProfileSelect.value.trim() !== '';

        if (hasProfile) {
            createProductBtn.disabled = false;
            createProductBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            createProductBtn.classList.add('hover:bg-blue-700');
            if (shippingProfileError) {
                shippingProfileError.classList.add('hidden');
            }
            if (shippingProfileSelect) {
                shippingProfileSelect.classList.remove('border-red-500');
            }
        } else {
            createProductBtn.disabled = true;
            createProductBtn.classList.add('opacity-50', 'cursor-not-allowed');
            createProductBtn.classList.remove('hover:bg-blue-700');
            if (shippingProfileError) {
                if (shippingProfilesLoaded) {
                    shippingProfileError.classList.remove('hidden');
                } else {
                    shippingProfileError.classList.add('hidden');
                }
            }
            if (shippingProfileSelect && shippingProfilesLoaded) {
                shippingProfileSelect.classList.add('border-red-500');
            }
        }
    }

    if (shippingProfileSelect) {
        shippingProfileSelect.addEventListener('change', () => {
            updateCreateButtonState();

            if (shippingProfilesCache.length > 0) {
                const selectedProfile = shippingProfilesCache.find(profile => String(profile.id) === String(shippingProfileSelect.value));
                if (selectedProfile) {
                    populateShippingDetails(selectedProfile);
                }
            }
        });
    }

    updateCreateButtonState();

    // Load shipping profiles from Reverb
    loadShippingProfiles();

    // Load drafts (and resume if requested)
    loadDrafts().then(() => {
        if (prefillDraftId) {
            const draftSelector = document.getElementById('draftSelector');
            const loadDraftButton = document.getElementById('loadDraftButton');
            if (draftSelector) {
                draftSelector.value = prefillDraftId.toString();
                draftSelector.dispatchEvent(new Event('change'));
            }
            if (loadDraftButton) {
                setTimeout(() => {
                    if (!loadDraftButton.disabled) {
                        loadDraftButton.click();
                    }
                }, 100);
            }
        }
    });
    
    // Platform sync radio button handling
    const syncAllYes = document.getElementById('sync_all_yes');
    const syncAllNo = document.getElementById('sync_all_no');
    const platformSelection = document.getElementById('platform-selection');
    const platformCheckboxes = document.querySelectorAll('input[name="sync_platforms"]');
    
    // Initialize status boxes based on sync selection
    function initializeStatusBoxes() {
        const syncAllYes = document.getElementById('sync_all_yes');
        const syncAllNo = document.getElementById('sync_all_no');
        
        console.log('Initializing status boxes...');
        console.log('Sync All Yes checked:', syncAllYes?.checked);
        console.log('Sync All No checked:', syncAllNo?.checked);
        
        if (syncAllYes && syncAllYes.checked) {
            // Sync All is selected - all status boxes should be visible
            console.log('Sync All is selected - making all status boxes visible');
            ['shopify', 'reverb', 'vr', 'ebay'].forEach(platform => {
                const statusBox = document.getElementById(`${platform}-status-box`);
                if (statusBox) {
                    console.log(`Making ${platform} status box visible`);
                    statusBox.classList.remove('opacity-40');
                    statusBox.style.opacity = '1';
                }
            });
        } else if (syncAllNo && syncAllNo.checked) {
            // Individual platform selection - check each checkbox
            console.log('Individual platform selection - checking each checkbox');
            updateStatusBoxes();
        }
    }
    
    // Run immediately
    initializeStatusBoxes();
    
    // Also run after a delay to catch any late initialization
    setTimeout(initializeStatusBoxes, 500);
    
    if (syncAllYes && syncAllNo) {
        
        syncAllYes.addEventListener('change', function() {
            if (this.checked) {
                platformSelection.classList.add('hidden');
                // Reset all status boxes to normal
                ['shopify', 'reverb', 'vr', 'ebay'].forEach(platform => {
                    const statusBox = document.getElementById(`${platform}-status-box`);
                    if (statusBox) {
                        statusBox.classList.remove('opacity-40');
                    }
                });
            }
        });
        
        syncAllNo.addEventListener('change', function() {
            if (this.checked) {
                platformSelection.classList.remove('hidden');
                updateStatusBoxes();
            }
        });
        
        // Handle individual platform checkbox changes
        platformCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateStatusBoxes);
        });
    }
    
    function updateStatusBoxes() {
        // First check if "Sync All" is selected
        const syncAllYes = document.getElementById('sync_all_yes');
        
        if (syncAllYes && syncAllYes.checked) {
            // If Sync All is selected, all status boxes should be visible
            ['shopify', 'reverb', 'vr', 'ebay'].forEach(platform => {
                const statusBox = document.getElementById(`${platform}-status-box`);
                if (statusBox) {
                    statusBox.classList.remove('opacity-40');
                    statusBox.style.opacity = '1';
                }
            });
        } else {
            // Grey out status boxes for unselected platforms
            ['shopify', 'reverb', 'vr', 'ebay'].forEach(platform => {
                const checkbox = document.getElementById(`sync_${platform}`);
                const statusBox = document.getElementById(`${platform}-status-box`);
                
                if (statusBox && checkbox) {
                    if (checkbox.checked) {
                        statusBox.classList.remove('opacity-40');
                        statusBox.style.opacity = '1';
                    } else {
                        statusBox.classList.add('opacity-40');
                        statusBox.style.opacity = '0.4';
                    }
                }
            });
        }
    }
    
    function checkProAudioCategory(category) {
        const isProAudio = category && category.startsWith('Pro Audio');
        console.log('Checking category:', category, 'Is Pro Audio:', isProAudio);
        
        // Get VR elements
        const vrTab = document.getElementById('vr-tab');
        const vrTabContent = document.getElementById('vrTabContent');
        const vrSyncCheckbox = document.getElementById('sync_vr');
        const vrSyncContainer = document.getElementById('sync_vr_container');
        const vrStatusBox = document.getElementById('vr-status-box');
        
        if (isProAudio) {
            // Disable VR tab
            if (vrTab) {
                vrTab.classList.add('opacity-40', 'cursor-not-allowed');
                vrTab.disabled = true;
                vrTab.setAttribute('title', 'V&R not available for Pro Audio categories');
            }
            
            // Hide VR tab content if it's active
            if (vrTabContent && !vrTabContent.classList.contains('hidden')) {
                vrTabContent.classList.add('hidden');
                // Switch to first tab
                const firstTab = document.querySelector('.platform-tab');
                if (firstTab) firstTab.click();
            }
            
            // Disable VR sync checkbox
            if (vrSyncCheckbox) {
                vrSyncCheckbox.checked = false;
                vrSyncCheckbox.disabled = true;
            }
            
            if (vrSyncContainer) {
                vrSyncContainer.classList.add('opacity-40');
                vrSyncContainer.setAttribute('title', 'V&R not available for Pro Audio categories');
            }
            
            // Grey out VR status box
            if (vrStatusBox) {
                vrStatusBox.classList.add('opacity-40');
            }
        } else {
            // Enable VR tab
            if (vrTab) {
                vrTab.classList.remove('opacity-40', 'cursor-not-allowed');
                vrTab.disabled = false;
                vrTab.removeAttribute('title');
            }
            
            // Enable VR sync checkbox
            if (vrSyncCheckbox) {
                vrSyncCheckbox.disabled = false;
            }
            
            if (vrSyncContainer) {
                vrSyncContainer.classList.remove('opacity-40');
                vrSyncContainer.removeAttribute('title');
            }
            
            // Update all status boxes based on sync selection
            updateStatusBoxes();
        }
    }
    
    // Add category change listener
    const categoryField = document.getElementById('category');
    if (categoryField) {
        console.log('Category field found, adding listeners');
        
        // Track last update to prevent double-triggering
        let lastCategoryUpdate = '';
        
        // Use input event for immediate feedback
        categoryField.addEventListener('input', function() {
            const selectedCategory = this.value;
            console.log('Category input changed to:', selectedCategory);
            // Only update if it's a complete category (has /) and different from last
            if (selectedCategory && selectedCategory.includes(' / ') && selectedCategory !== lastCategoryUpdate) {
                lastCategoryUpdate = selectedCategory;
                updatePlatformCategories(selectedCategory);
                checkProAudioCategory(selectedCategory);
            }
        });
        
        // Also trigger on change for datalist selection
        categoryField.addEventListener('change', function() {
            const selectedCategory = this.value;
            console.log('Category changed to:', selectedCategory);
            if (selectedCategory && selectedCategory !== lastCategoryUpdate) {
                lastCategoryUpdate = selectedCategory;
                updatePlatformCategories(selectedCategory);
                checkProAudioCategory(selectedCategory);
            }
        });
        
        // If there's already a value, trigger the mapping
        if (categoryField.value) {
            console.log('Initial category value:', categoryField.value);
            updatePlatformCategories(categoryField.value);
            checkProAudioCategory(categoryField.value);
        }
        
        // Also check after a short delay for dynamically populated values (e.g., from copy)
        setTimeout(() => {
            if (categoryField.value && categoryField.value !== lastCategoryUpdate) {
                console.log('Delayed category value found:', categoryField.value);
                lastCategoryUpdate = categoryField.value;
                updatePlatformCategories(categoryField.value);
                checkProAudioCategory(categoryField.value);
            }
        }, 1000);
        
        // Override the value setter to detect programmatic changes
        const valueDescriptor = Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, 'value');
        const originalValueSetter = valueDescriptor?.set;
        const originalValueGetter = valueDescriptor?.get;

        Object.defineProperty(categoryField, 'value', {
            configurable: true,
            get: function() {
                // Fall back to attribute only if the native getter is unavailable
                return originalValueGetter ? originalValueGetter.call(this) : (this.getAttribute('value') || '');
            },
            set: function(val) {
                // Preserve the native setter behaviour
                if (originalValueSetter) {
                    originalValueSetter.call(this, val);
                }

                // Keep the attribute in sync so legacy code reading attributes still works
                if (val === null || val === undefined) {
                    this.removeAttribute('value');
                } else {
                    this.setAttribute('value', val);
                }

                // Trigger cross-platform category updates when the value actually changes
                if (val && val !== lastCategoryUpdate) {
                    console.log('Category value set programmatically:', val);
                    lastCategoryUpdate = val;
                    setTimeout(() => {
                        updatePlatformCategories(val);
                        checkProAudioCategory(val);
                    }, 100);
                }
            }
        });
    } else {
        console.error('Category field not found!')
    }
    
    // Track when categories are loaded - make it global
    window.categoriesLoaded = {
        ebay: false,
        shopify: false,
        vr: false
    };
    
    // Pending category selections to apply after loading - make it global
    window.pendingCategorySelections = {
        ebay: null,
        shopify: null,
        vr: null
    };
    
    // Load platform categories
    async function loadPlatformCategories() {
        const platforms = ['ebay', 'shopify', 'vr'];
        
        const promises = platforms.map(async (platform) => {
            try {
                const response = await fetch(`/inventory/platform-categories/${platform}`);
                if (!response.ok) {
                    console.error(`Failed to load ${platform} categories:`, response.status);
                    return;
                }
                
                const data = await response.json();
                const selectId = platform === 'vr' ? 'vr_category' : `${platform}_category${platform === 'ebay' ? '_id' : ''}`;
                const select = document.getElementById(selectId);
                
                if (select && data.categories) {
                    // Clear existing options except the first one
                    while (select.options.length > 1) {
                        select.remove(1);
                    }
                    
                    // Add new options
                    data.categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.id;
                        
                        // Format display based on platform
                        if (platform === 'shopify') {
                            // For Shopify, show merchant type and GID
                            option.textContent = `${cat.name} (${cat.id})`;
                            option.title = cat.full_name || ''; // Full path as tooltip
                        } else if (platform === 'ebay') {
                            // For eBay, show name and ID
                            option.textContent = `${cat.name} (${cat.id})`;
                        } else if (platform === 'vr') {
                            // For V&R, show category name and ID
                            option.textContent = `${cat.name} (${cat.id})`;
                        }
                        
                        select.appendChild(option);
                    });
                    
                    console.log(`Loaded ${data.categories.length} ${platform} categories`);
                    window.categoriesLoaded[platform] = true;
                    
                    // Apply any pending selection
                    if (window.pendingCategorySelections[platform]) {
                        console.log(`Applying pending ${platform} category selection:`, window.pendingCategorySelections[platform]);
                        
                        // Small delay to ensure DOM is ready
                        setTimeout(() => {
                            if (platform === 'ebay') {
                                const ebaySelect = document.getElementById('ebay_category_id');
                                if (ebaySelect) {
                                    ebaySelect.value = window.pendingCategorySelections[platform];
                                    console.log(`Set eBay dropdown value to: ${ebaySelect.value}`);
                                }
                            } else if (platform === 'shopify') {
                                const shopifySelect = document.getElementById('shopify_category');
                                if (shopifySelect) {
                                    console.log(`Attempting to set Shopify value to: "${window.pendingCategorySelections[platform]}"`);
                                    console.log(`Current Shopify options (first 5):`);
                                    for (let i = 0; i < Math.min(5, shopifySelect.options.length); i++) {
                                        console.log(`  Option ${i}: value="${shopifySelect.options[i].value}"`);
                                    }
                                    
                                    // Try setting the value
                                    shopifySelect.value = window.pendingCategorySelections[platform];
                                    
                                    // Check if it worked
                                    if (shopifySelect.value === window.pendingCategorySelections[platform]) {
                                        console.log(`✅ Successfully set Shopify dropdown to: ${shopifySelect.value}`);
                                    } else {
                                        console.log(`❌ Failed to set Shopify dropdown. Current value: ${shopifySelect.value}`);
                                        
                                        // Try one more time with exact string matching
                                        for (let i = 0; i < shopifySelect.options.length; i++) {
                                            if (shopifySelect.options[i].value === window.pendingCategorySelections[platform]) {
                                                shopifySelect.selectedIndex = i;
                                                console.log(`✅ Set by index ${i}: ${shopifySelect.value}`);
                                                break;
                                            }
                                        }
                                    }
                                }
                            } else if (platform === 'vr') {
                                const vrSelect = document.getElementById('vr_category');
                                if (vrSelect) {
                                    vrSelect.value = window.pendingCategorySelections[platform];
                                    console.log(`Set V&R dropdown value to: ${vrSelect.value}`);
                                }
                            }
                            window.pendingCategorySelections[platform] = null;
                        }, 100); // 100ms delay
                    }
                }
            } catch (error) {
                console.error(`Error loading ${platform} categories:`, error);
            }
        });
        
        // Wait for all to complete
        await Promise.all(promises);
        return true;
    }
    
    // Load categories when page loads
    window.categoriesLoadPromise = loadPlatformCategories();
    
    async function loadShippingProfiles() {
        if (!shippingProfileSelect) {
            console.log('Shipping profile select not found');
            return;
        }

        try {
            console.log('Loading shipping profiles...');
            // Fetch shipping profiles from the API
            const response = await fetch('/inventory/shipping-profiles');
            if (!response.ok) {
                console.error('Failed to load shipping profiles:', response.status);
                return;
            }
            
            const profiles = await response.json();
            console.log('Loaded profiles:', profiles);
            shippingProfilesCache = profiles;
            
            // Clear existing options
            shippingProfileSelect.innerHTML = '<option value="">-- Select a shipping profile --</option>';
            
            // Add profiles to the select dropdown using display_name
            profiles.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.id;
                // Use display_name if available, otherwise fall back to name
                const displayText = profile.display_name || profile.name;
                option.textContent = displayText;
                console.log(`Adding option: ${displayText}`);
                shippingProfileSelect.appendChild(option);
            });
            
            shippingProfilesLoaded = true;
            updateCreateButtonState();

            // Populate details if a profile was pre-selected (e.g., from draft)
            if (shippingProfileSelect.value) {
                const selectedProfile = profiles.find(p => String(p.id) === String(shippingProfileSelect.value));
                if (selectedProfile) {
                    populateShippingDetails(selectedProfile);
                }
            }
        } catch (error) {
            console.error('Error loading shipping profiles:', error);
            shippingProfilesLoaded = false;
            updateCreateButtonState();
        }
    }
    
    function populateShippingDetails(profile) {
        // Populate weight if available
        if (profile.weight) {
            const weightInput = document.getElementById('weight');
            if (weightInput) weightInput.value = profile.weight;
        }
        
        // Populate dimensions if available
        if (profile.dimensions) {
            if (profile.dimensions.length) {
                const lengthInput = document.getElementById('length');
                if (lengthInput) lengthInput.value = profile.dimensions.length;
            }
            if (profile.dimensions.width) {
                const widthInput = document.getElementById('width');
                if (widthInput) widthInput.value = profile.dimensions.width;
            }
            if (profile.dimensions.height) {
                const heightInput = document.getElementById('height');
                if (heightInput) heightInput.value = profile.dimensions.height;
            }
        }
        
        // Set carrier preference if available
        if (profile.carriers && profile.carriers.length > 0) {
            const carrier = profile.carriers[0].toLowerCase();
            const carrierRadio = document.getElementById(`carrier_${carrier}`);
            if (carrierRadio) carrierRadio.checked = true;
        }
        
        // Set options if available
        if (profile.options) {
            if (profile.options.free_shipping !== undefined) {
                const freeShippingCheckbox = document.getElementById('free_shipping_option');
                if (freeShippingCheckbox) freeShippingCheckbox.checked = profile.options.free_shipping;
            }
            if (profile.options.insurance !== undefined) {
                const insuranceCheckbox = document.getElementById('insurance');
                if (insuranceCheckbox) insuranceCheckbox.checked = profile.options.insurance;
            }
            if (profile.options.require_signature !== undefined) {
                const signatureCheckbox = document.getElementById('require_signature');
                if (signatureCheckbox) signatureCheckbox.checked = profile.options.require_signature;
            }
        }
        
        // Populate rates if available
        if (profile.rates) {
            // UK rate
            if (profile.rates.uk) {
                const ukRateInput = document.querySelector('input[name="uk_rate"]');
                if (ukRateInput) ukRateInput.value = profile.rates.uk;
            }
            // Europe rate
            if (profile.rates.europe) {
                const europeRateInput = document.querySelector('input[name="europe_rate"]');
                if (europeRateInput) europeRateInput.value = profile.rates.europe;
            }
            // USA rate
            if (profile.rates.usa) {
                const usaRateInput = document.querySelector('input[name="usa_rate"]');
                if (usaRateInput) usaRateInput.value = profile.rates.usa;
            }
            // Rest of World rate
            if (profile.rates.row) {
                const rowRateInput = document.querySelector('input[name="row_rate"]');
                if (rowRateInput) rowRateInput.value = profile.rates.row;
            }
        }
    }
    
    // Brand validation functionality
    const brandInput = document.getElementById('brand');
    const brandValidationIcon = document.getElementById('brandValidationIcon');
    const vrBrandWarning = document.getElementById('vrBrandWarning');
    const vrBrandName = document.getElementById('vrBrandName');
    const vrBrandFallback = document.getElementById('vrBrandFallback');
    const brandVRStatus = document.getElementById('brandVRStatus');
    
    let brandCheckTimeout;
    
    // Function to check brand with V&R
    async function checkVRBrand(brand) {
        if (!brand || brand.length < 2) {
            brandValidationIcon.innerHTML = '';
            vrBrandWarning.classList.add('hidden');
            brandVRStatus.textContent = '';
            return;
        }
        
        // Show spinner
        brandValidationIcon.innerHTML = `
            <svg class="animate-spin h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        `;
        
        try {
            const response = await fetch(`/api/vr/validate-brand?brand=${encodeURIComponent(brand)}`);
            const data = await response.json();
            
            if (data.valid) {
                // Brand is recognized by V&R
                brandValidationIcon.innerHTML = `
                    <svg class="h-5 w-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                `;
                vrBrandWarning.classList.add('hidden');
                vrBrandFallback.value = 'false';
                brandVRStatus.innerHTML = '<span class="text-green-600">✓ V&R</span>';
            } else {
                // Brand not recognized - will use Justin
                brandValidationIcon.innerHTML = `
                    <svg class="h-5 w-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                `;
                vrBrandName.textContent = brand;
                vrBrandWarning.classList.remove('hidden');
                vrBrandFallback.value = 'true';
                brandVRStatus.innerHTML = '<span class="text-yellow-600">⚠ V&R: Justin</span>';
            }
        } catch (error) {
            console.error('Error checking V&R brand:', error);
            // On error, just clear the icon
            brandValidationIcon.innerHTML = '';
            brandVRStatus.textContent = '';
        }
    }
    
    // Add event listener for brand input
    if (brandInput) {
        brandInput.addEventListener('input', function() {
            clearTimeout(brandCheckTimeout);
            brandCheckTimeout = setTimeout(() => {
                checkVRBrand(this.value);
            }, 500); // Debounce for 500ms
        });
        
        // Check on initial load if there's a value
        if (brandInput.value) {
            checkVRBrand(brandInput.value);
        }
    }
    
    // Model field enhancements with keyboard navigation
    const modelInput = document.getElementById('model');
    const modelSuggestions = document.getElementById('modelSuggestions');
    const modelHint = document.getElementById('modelHint');
    let selectedSuggestionIndex = -1;
    
    if (modelInput) {
        // Common models by brand (can be expanded or fetched from API)
        const brandModels = {
            'Fender': ['Stratocaster', 'Telecaster', 'Jazzmaster', 'Jaguar', 'Mustang', 'Precision Bass', 'Jazz Bass', 'Twin Reverb', 'Deluxe Reverb', 'Princeton'],
            'Gibson': ['Les Paul', 'SG', 'ES-335', 'Flying V', 'Explorer', 'Firebird', 'J-45', 'J-200', 'Hummingbird', 'L-5'],
            'Martin': ['D-28', 'D-18', 'D-35', 'D-45', 'HD-28', '000-28', 'OM-28', 'D-15', 'D-41', '00-18'],
            'Gretsch': ['White Falcon', 'Country Gentleman', 'Tennessee Rose', 'Duo Jet', 'Electromatic', 'G5220', 'G5422TG', 'G6120', 'Streamliner'],
            'Marshall': ['JCM800', 'JCM900', 'JVM410', 'DSL40', 'DSL100', 'JTM45', 'Plexi', '1959SLP', 'Silver Jubilee', 'Origin'],
            'Rickenbacker': ['360', '330', '620', '4001', '4003', '360/12', '330/12', '381', '325', '4004'],
            'PRS': ['Custom 24', 'Custom 22', 'McCarty', 'Silver Sky', 'CE 24', 'SE Custom', 'Santana', 'DGT', 'Tremonti'],
            'Ibanez': ['RG', 'JEM', 'Prestige', 'AZ', 'S Series', 'Artcore', 'SR Bass', 'BTB Bass', 'Talman', 'Iceman'],
            'Yamaha': ['Pacifica', 'FG830', 'LL16', 'A Series', 'L Series', 'SG2000', 'Revstar', 'TRBX', 'BB Bass'],
            'Epiphone': ['Casino', 'Sheraton', 'Dot', 'Les Paul', 'SG', 'Riviera', 'Wildkat', 'Emperor', 'Broadway']
        };
        
        // Function to show model suggestions
        function showModelSuggestions() {
            const brand = document.getElementById('brand').value.trim();
            const modelValue = modelInput.value.trim().toLowerCase();
            selectedSuggestionIndex = -1;
            
            // Clear suggestions if no brand selected
            if (!brand) {
                modelSuggestions.classList.add('hidden');
                modelHint.textContent = 'Select a brand first to see model suggestions';
                return;
            }
            
            // Get models for the brand
            const models = brandModels[brand] || [];
            
            if (models.length === 0) {
                modelHint.textContent = '';
                modelSuggestions.classList.add('hidden');
                return;
            }
            
            // Filter models based on input
            const filteredModels = modelValue ? 
                models.filter(m => m.toLowerCase().includes(modelValue)) : 
                models;
            
            if (filteredModels.length > 0 && modelValue.length > 0) {
                modelSuggestions.innerHTML = '';
                filteredModels.forEach((model, index) => {
                    const div = document.createElement('div');
                    div.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer model-suggestion';
                    div.textContent = model;
                    div.dataset.index = index;
                    div.onclick = () => {
                        modelInput.value = model;
                        modelSuggestions.classList.add('hidden');
                        modelHint.textContent = '';
                    };
                    modelSuggestions.appendChild(div);
                });
                modelSuggestions.classList.remove('hidden');
            } else {
                modelSuggestions.classList.add('hidden');
            }
            
            // Update hint
            if (models.length > 0 && !modelValue) {
                modelHint.textContent = `Popular ${brand} models: ${models.slice(0, 3).join(', ')}...`;
            } else {
                modelHint.textContent = '';
            }
        }
        
        // Function to highlight suggestion
        function highlightSuggestion(index) {
            const suggestions = modelSuggestions.querySelectorAll('.model-suggestion');
            suggestions.forEach(s => s.classList.remove('bg-gray-200'));
            if (index >= 0 && index < suggestions.length) {
                suggestions[index].classList.add('bg-gray-200');
            }
        }
        
        // Keyboard navigation
        modelInput.addEventListener('keydown', (e) => {
            const suggestions = modelSuggestions.querySelectorAll('.model-suggestion');
            const isVisible = !modelSuggestions.classList.contains('hidden');
            
            if (!isVisible || suggestions.length === 0) return;
            
            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestions.length - 1);
                    highlightSuggestion(selectedSuggestionIndex);
                    break;
                    
                case 'ArrowUp':
                    e.preventDefault();
                    selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                    highlightSuggestion(selectedSuggestionIndex);
                    break;
                    
                case 'Enter':
                    if (selectedSuggestionIndex >= 0) {
                        e.preventDefault();
                        suggestions[selectedSuggestionIndex].click();
                    }
                    break;
                    
                case 'Tab':
                    if (suggestions.length > 0) {
                        e.preventDefault();
                        // Select first suggestion or highlighted one
                        const indexToSelect = selectedSuggestionIndex >= 0 ? selectedSuggestionIndex : 0;
                        suggestions[indexToSelect].click();
                    }
                    break;
                    
                case 'Escape':
                    modelSuggestions.classList.add('hidden');
                    selectedSuggestionIndex = -1;
                    break;
            }
        });
        
        // Listen for brand changes
        document.getElementById('brand').addEventListener('change', showModelSuggestions);
        
        // Listen for model input
        modelInput.addEventListener('input', showModelSuggestions);
        modelInput.addEventListener('focus', showModelSuggestions);
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!modelInput.contains(e.target) && !modelSuggestions.contains(e.target)) {
                modelSuggestions.classList.add('hidden');
                selectedSuggestionIndex = -1;
            }
        });
    }
    
    // Title auto-generation
    const titleInput = document.getElementById('title');
    const regenerateTitle = document.getElementById('regenerateTitle');
    
    function generateTitle() {
        const brand = document.getElementById('brand').value.trim();
        const model = document.getElementById('model').value.trim();
        const finish = document.getElementById('finish').value.trim();
        const year = document.getElementById('year').value.trim();
        
        const parts = [];
        if (brand) parts.push(brand);
        if (model) parts.push(model);
        if (finish) parts.push(finish);
        if (year) parts.push(year);
        
        if (parts.length > 0) {
            titleInput.value = parts.join(' ');
        }
    }
    
    // Auto-generate title when fields change
    ['brand', 'model', 'finish', 'year'].forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('blur', () => {
                // Only auto-generate if title is empty or was previously auto-generated
                if (!titleInput.value || titleInput.dataset.autoGenerated === 'true') {
                    generateTitle();
                    titleInput.dataset.autoGenerated = 'true';
                }
            });
        }
    });
    
    // Manual title edit detection
    if (titleInput) {
        titleInput.addEventListener('input', () => {
            titleInput.dataset.autoGenerated = 'false';
        });
    }
    
    // Regenerate button
    if (regenerateTitle) {
        regenerateTitle.addEventListener('click', () => {
            generateTitle();
            titleInput.dataset.autoGenerated = 'true';
        });
    }

    const seoKeywordsInput = document.getElementById('shopify_seo_keywords');

    function generateSeoKeywords(force = false) {
        if (!seoKeywordsInput) {
            return;
        }

        const inputIsEmpty = !seoKeywordsInput.value.trim();
        const shouldGenerate = force ? inputIsEmpty : (inputIsEmpty || seoKeywordsInput.dataset.autoGenerated === 'true');
        if (!shouldGenerate) {
            return;
        }

        const brand = document.getElementById('brand')?.value || '';
        const model = document.getElementById('model')?.value || '';
        const category = document.getElementById('category')?.value || '';
        const finish = document.getElementById('finish')?.value || '';
        const year = document.getElementById('year')?.value || '';
        const condition = document.getElementById('condition')?.value || '';

        const keywords = [brand, model, year, finish, category, condition]
            .map(word => (word ?? '').toString().trim())
            .filter(word => word.length > 0)
            .map(word => word.toLowerCase())
            .filter((word, index, self) => self.indexOf(word) === index);

        if (keywords.length === 0) {
            return;
        }

        seoKeywordsInput.value = keywords.join(', ');
        seoKeywordsInput.dataset.autoGenerated = 'true';
        seoKeywordsInput.dispatchEvent(new Event('input', { bubbles: true }));
        seoKeywordsInput.dispatchEvent(new Event('change', { bubbles: true }));
    }

    if (seoKeywordsInput) {
        seoKeywordsInput.addEventListener('input', () => {
            seoKeywordsInput.dataset.autoGenerated = 'false';
        });
    }

    ['brand', 'model', 'category', 'finish'].forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', () => generateSeoKeywords());
            field.addEventListener('blur', () => generateSeoKeywords());
        }
    });

    generateSeoKeywords(true);

    // Year/Decade interaction
    const yearInput = document.getElementById('year');
    const decadeSelect = document.getElementById('decade');
    
    if (yearInput && decadeSelect) {
        yearInput.addEventListener('input', () => {
            const year = parseInt(yearInput.value);
            if (year && year >= 1900 && year <= 2030) {
                // Calculate decade
                const decade = Math.floor(year / 10) * 10;
                decadeSelect.value = decade;
                decadeSelect.disabled = true;
            } else {
                decadeSelect.disabled = false;
                if (!yearInput.value) {
                    decadeSelect.value = '';
                }
            }
        });
        
        // Check on page load
        if (yearInput.value) {
            const year = parseInt(yearInput.value);
            if (year && year >= 1900 && year <= 2030) {
                const decade = Math.floor(year / 10) * 10;
                decadeSelect.value = decade;
                decadeSelect.disabled = true;
            }
        }
    }
    
    // Has Inventory checkbox - show/hide quantity field
    const isStockedCheckbox = document.getElementById('is_stocked_item');
    const quantityField = document.getElementById('quantityField');
    const quantityInput = document.getElementById('quantity');
    
    if (isStockedCheckbox && quantityField) {
        // Function to toggle quantity field visibility
        function toggleQuantityField() {
            if (isStockedCheckbox.checked) {
                quantityField.classList.remove('hidden');
                quantityInput.required = true;
                // Set default value if empty
                if (!quantityInput.value) {
                    quantityInput.value = '1';
                }
            } else {
                quantityField.classList.add('hidden');
                quantityInput.required = false;
                quantityInput.value = '';
            }
        }
        
        // Listen for checkbox changes
        isStockedCheckbox.addEventListener('change', toggleQuantityField);
        
        // Check initial state on page load
        toggleQuantityField();
    }
    
    let currentPath = ''; // Global variable to track current folder path
    
    // Find the button after DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        const regenerateButton = document.getElementById('regenerate-links-button');
        if (regenerateButton) {
            regenerateButton.addEventListener('click', function() {
                console.log("Regenerate button clicked, current path:", currentPath);
                if (currentPath) {
                    generateFolderLinks(currentPath);
                } else {
                    console.error("No current path defined");
                    alert("Please navigate to a folder first");
                }
            });
        }
    });

    // =========== SECTION TOGGLING ===========
    // Handle collapsible sections
    document.querySelectorAll('.form-section-header').forEach(header => {
        header.addEventListener('click', function() {
            const content = this.closest('.form-section').querySelector('.form-section-content');
            const icon = this.querySelector('.form-section-icon');
            
            // Check if this is the Images & Media section
            const sectionText = this.querySelector('span').textContent;
            const isImagesSection = sectionText && sectionText.includes('Images & Media');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.add('rotate-180');

                // Auto-load Dropbox folders when Images & Media section is opened
                if (isImagesSection && !window.dropboxLoaded) {
                    console.log("Auto-loading Dropbox folders on section open");
                    loadDropboxFolders('');
                }
            } else {
                content.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        });
    });

    // Initialize TinyMCE - ADD THIS HERE
    tinymce.init({
        selector: '#description',
        plugins: 'anchor autolink charmap codesample emoticons image link lists media searchreplace table visualblocks wordcount',
        toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link image media table | align lineheight | numlist bullist indent outdent | emoticons charmap | removeformat',
        height: 300,
        menubar: false
    });

    // Open the first section by default
    const firstSection = document.querySelector('.form-section-header');
    if (firstSection) {
        firstSection.click();
    }

    // Open only the Basic Information section by default
    const basicInfoSection = document.querySelector('.form-section:first-child .form-section-header');
    if (basicInfoSection) {
        basicInfoSection.click();
    }

    // Make sure all other sections are collapsed
    document.querySelectorAll('.form-section:not(:first-child) .form-section-content').forEach(content => {
        content.classList.add('hidden');
    });

    // Legacy image section toggle (for backward compatibility)
    function toggleImageSection() {
        const section = document.getElementById('imageSection');
        const icon = document.getElementById('imageToggleIcon');
        if (section && icon) {
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                section.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        }
    }
    
    // Make toggleImageSection available globally
    window.toggleImageSection = toggleImageSection;
    
    // =========== PLATFORM TABS ===========
    // Platform tab switching
    document.querySelectorAll('.platform-tab').forEach(tab => {
        tab.addEventListener('click', function() {

            // Clear active state from all tabs
            document.querySelectorAll('.platform-tab').forEach(t => {
                t.classList.remove('bg-blue-100', 'border-blue-500', 'border-b-2', 'text-blue-600', 'active');
                t.classList.add('text-gray-500');
            });
            
            // Add active state to clicked tab
            this.classList.add('bg-blue-100', 'border-blue-500', 'border-b-2', 'text-blue-600', 'active');
            this.classList.remove('text-gray-500');
            
            // Hide all tab panes
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.add('hidden');
                pane.classList.remove('active');
            });
            
            // Show selected tab pane
            const targetId = this.getAttribute('data-target');
            const targetPane = document.getElementById(targetId);
            if (targetPane) {
                console.log('Found target pane:', targetId); // Debug
                targetPane.classList.remove('hidden');
                targetPane.classList.add('active');
            } else {
                console.error('Target pane not found:', targetId); // Debug
            }
        });
    });

    
    // Activate the first platform tab by default
    const firstTab = document.querySelector('.platform-tab');
    if (firstTab) {
        firstTab.click();
    }
    

    // =========== IMAGE HANDLING ===========
    // Image preview for file uploads
    const fileInputs = document.querySelectorAll('input[type="file"]');
    const previewContainer = document.getElementById('imagePreview');
    
    if (previewContainer) {
        fileInputs.forEach(input => {
            input.addEventListener('change', function(e) {
                // Clear previous previews if this is the primary image
                if (this.name === 'primary_image_file') {
                    // Only clear the primary image preview
                    const primaryPreviews = previewContainer.querySelectorAll('[data-source="primary"]');
                    primaryPreviews.forEach(prev => prev.remove());
                }
                
                if (this.files) {
                    // Don't clear existing images - append new ones instead
                    // This allows adding more images when loading from drafts

                    Array.from(this.files).forEach((file, fileIndex) => {
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                // Add to selectedImages array
                                const imageData = {
                                    url: e.target.result,
                                    name: file.name,
                                    source: 'file',
                                    file: file
                                };

                                // Add to array
                                selectedImages.push(imageData);

                                // Update the entire preview
                                updateImagePreview();
                                updateHiddenInputs();
                                updateImageCount();
                            };
                            reader.readAsDataURL(file);
                        } else {
                            alert('Please select only image files.');
                            this.value = ''; // Clear the input
                        }
                    });
                }
            });
        });
    }
    
    // Initialize drag and drop for images
    let imagesList = [];

    // Function to update hidden inputs when images are reordered
    function updateImageOrder() {
    const previewContainer = document.getElementById('imagePreview');
    if (!previewContainer) return;
    
    const images = previewContainer.querySelectorAll('.image-preview');
    
    // Update the array
    imagesList = Array.from(images).map(img => {
        return {
            url: img.dataset.url,
            source: img.dataset.source
        };
    });
    
    // The first image is the primary image, all others are additional
    if (imagesList.length > 0) {
        const primaryImage = imagesList[0];
        const additionalImages = imagesList.slice(1);
        
        // Set the hidden input fields for form submission
        if (primaryImage.source === 'upload') {
            // Will be handled by file input
        } else if (primaryImage.source === 'url') {
            document.querySelector('input[name="primary_image_url"]').value = primaryImage.url;
        } else if (primaryImage.source === 'dropbox') {
            document.querySelector('input[name="primary_image_url"]').value = primaryImage.url;
        }
        
        // Set additional images
        const additionalUrls = additionalImages
            .filter(img => img.source === 'url' || img.source === 'dropbox')
            .map(img => img.url);
            
        document.querySelector('input[name="additional_images_urls"]').value = additionalUrls.join('\n');
    }
}

// Add Sortable.js library if it doesn't exist
if (!window.Sortable) {
    const script = document.createElement('script');
    script.src = "https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js";
    script.onload = initializeSortable;
    document.head.appendChild(script);
} else {
    initializeSortable();
}

function initializeSortable() {
    const container = document.getElementById('imagePreview');
    if (container) {
        console.log('[initializeSortable] Creating Sortable instance #1');
        new Sortable(container, {
            animation: 150,
            ghostClass: 'bg-blue-100',
            onStart: function(evt) {
                console.log('[initializeSortable] Drag STARTED from instance #1');
            },
            onEnd: function(evt) {
                console.log('[initializeSortable] Drag ENDED in instance #1, updating selectedImages');
                
                // Get new order from DOM
                const newOrder = [];
                const items = container.querySelectorAll('[data-index]');
                
                items.forEach(item => {
                    const oldIndex = parseInt(item.dataset.index);
                    if (!isNaN(oldIndex) && oldIndex >= 0 && oldIndex < selectedImages.length) {
                        newOrder.push(selectedImages[oldIndex]);
                    }
                });
                
                // Only update if we have the right number of items
                if (newOrder.length === selectedImages.length) {
                    console.log('[initializeSortable] Updating selectedImages and refreshing preview');
                    selectedImages = newOrder;
                    updateImagePreview();
                    updateHiddenInputs();
                } else {
                    console.log('[initializeSortable] WARNING: newOrder length mismatch');
                }
                console.log('[initializeSortable] Instance #1 onEnd complete');
            }
        });
        
        console.log('Sortable initialized on imagePreview container (instance #1)');
        
        // Also initialize for Dropbox selected images
        const dropboxContainer = document.getElementById('dropbox-selected-images');
        if (dropboxContainer) {
            new Sortable(dropboxContainer, {
                animation: 150,
                ghostClass: 'bg-blue-100',
                onEnd: function() {
                    // Update selected images array to match new order
                    const imageElements = dropboxContainer.querySelectorAll('[data-url]');
                    selectedImages = Array.from(imageElements).map(el => {
                        return {
                            url: el.dataset.url,
                            name: el.dataset.name || ''
                        };
                    });
                    updateSelectedImagesDisplay();
                }
            });
            console.log('Sortable initialized on dropbox-selected-images container');
        }
    }
}

    // =========== COPY FROM EXISTING ===========
    
    const existingProductSelect = document.getElementById('existingProduct');
    const copyButton = document.getElementById('copyButton');
    const copyStatus = document.getElementById('copyStatus');
    
    if (existingProductSelect && copyButton && copyStatus) {
        copyButton.addEventListener('click', function() {
            const productId = existingProductSelect.value;
            if (!productId) {
                copyStatus.textContent = 'Please select a product first';
                copyStatus.classList.add('text-red-600');
                return;
            }
            
            copyStatus.textContent = 'Loading product data...';
            copyStatus.classList.remove('text-red-600');
            copyStatus.classList.add('text-blue-600');
            
            // Clear all existing validation errors before copying
            document.querySelectorAll('.border-red-500').forEach(field => {
                field.classList.remove('border-red-500');
            });
            document.querySelectorAll('[id$="-error"]').forEach(errorMsg => {
                console.log('Removing pre-existing error:', errorMsg.id);
                errorMsg.remove();
            });
            
            // Fetch product data
            fetch(`/inventory/api/products/${productId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // Fill the form with product data
                    fillFormWithProductData(data);
                    
                    // Trigger title generation after copying
                    if (typeof generateTitle === 'function') {
                        generateTitle();
                        const titleInput = document.getElementById('title');
                        if (titleInput) {
                            titleInput.dataset.autoGenerated = 'true';
                        }
                    }
                    
                    // Trigger year/decade population
                    const yearInput = document.getElementById('year');
                    const decadeSelect = document.getElementById('decade');
                    if (yearInput && decadeSelect && yearInput.value) {
                        const year = parseInt(yearInput.value);
                        if (year && year >= 1900 && year <= 2030) {
                            const decade = Math.floor(year / 10) * 10;
                            decadeSelect.value = decade;
                            decadeSelect.disabled = true;
                        }
                    }
                    
                    // Explicitly trigger category mapping check after copying
                    const categoryField = document.getElementById('category');
                    if (categoryField && categoryField.value) {
                        console.log('Category field value after copy:', categoryField.value);
                        
                        // Store the category value globally and locally to prevent it from being cleared
                        const categoryValue = categoryField.value;
                        lastKnownCategoryValue = categoryValue;
                        
                        // Force the HTML attribute to match
                        categoryField.setAttribute('value', categoryValue);
                        
                        // Remove any error state
                        categoryField.classList.remove('border-red-500');
                        const errorMsg = document.getElementById('category-error');
                        if (errorMsg) {
                            errorMsg.remove();
                        }
                        
                        // Trigger multiple events to ensure validation clears
                        const inputEvent = new Event('input', { bubbles: true });
                        const changeEvent = new Event('change', { bubbles: true });
                        
                        categoryField.dispatchEvent(inputEvent);
                        categoryField.dispatchEvent(changeEvent);
                        
                        // Check if we need to trigger category mapping lookup
                        // Do this AFTER events to ensure the value isn't cleared
                        setTimeout(() => {
                            // Double-check the value hasn't been cleared
                            if (!categoryField.value || categoryField.value !== categoryValue) {
                                console.warn('Category field was cleared! Restoring value:', categoryValue);
                                categoryField.value = categoryValue;
                                categoryField.setAttribute('value', categoryValue);
                                lastKnownCategoryValue = categoryValue;
                            }
                            
                            if (typeof fetchCategoryMappings === 'function') {
                                fetchCategoryMappings(categoryValue);
                            }
                        }, 50);
                        
                        // Add another safety check after a longer delay
                        setTimeout(() => {
                            if (!categoryField.value || categoryField.value !== categoryValue) {
                                console.warn('Category field was cleared again! Restoring value:', categoryValue);
                                categoryField.value = categoryValue;
                                categoryField.setAttribute('value', categoryValue);
                            }
                        }, 500);
                    }
                    
                    // Clear all validation errors on all required fields after copy
                    const allFields = document.querySelectorAll('[required]');
                    allFields.forEach(field => {
                        if (field.value && field.value.trim()) {
                            field.classList.remove('border-red-500');
                            const errorMsg = document.getElementById(`${field.id}-error`);
                            if (errorMsg) {
                                errorMsg.remove();
                            }
                        }
                    });
                    
                    copyStatus.textContent = 'Product data copied successfully!';
                    copyStatus.classList.remove('text-blue-600');
                    copyStatus.classList.add('text-green-600');
                    
                    // Clear the status after 3 seconds
                    setTimeout(() => {
                        copyStatus.textContent = '';
                    }, 3000);
                })
                .catch(error => {
                    console.error('Error fetching product data:', error);
                    copyStatus.textContent = 'Error fetching product data';
                    copyStatus.classList.remove('text-blue-600');
                    copyStatus.classList.add('text-red-600');
                });
        });
    }

    function fillFormWithProductData(data) {
        // Basic info
        setValueIfExists('brand', data.brand);
        setValueIfExists('model', data.model);
        // Generate a new SKU rather than copying
        document.getElementById('generateSku')?.click();
        setValueIfExists('year', data.year);
        setValueIfExists('decade', data.decade);
        setValueIfExists('category', data.category);
        setValueIfExists('finish', data.finish);
        
        // Description & Condition
        // Add standard footer to description
        const standardFooter = '<br/><br/>' +
            '<p><strong>ALL EU PURCHASES ARE DELIVERED WITH TAXES AND DUTIES PAID</strong></p>' +
            '<br/>' +
            '<p>All purchases include EU Taxes / Duties paid, i.e., nothing further is due on receipt of goods to any EU State.</p>' +
            '<br/>' +
            '<p><strong>WHY BUY FROM US</strong></p>' +
            '<br/>' +
            '<p>We are one of the world\'s leading specialists in used and vintage gear with over 30 years of experience. Prior to shipping, each item will be fully serviced and professionally packed.</p>' +
            '<br/>' +
            '<p><strong>SELL - TRADE - CONSIGN</strong></p>' +
            '<br/>' +
            '<p>If you are looking to sell, trade, or consign any of your classic gear, please contact us by message.</p>' +
            '<br/>' +
            '<p><strong>WORLDWIDE COLLECTION - DELIVERY</strong></p>' +
            '<br/>' +
            '<p>We offer personal delivery and collection services worldwide with offices/locations in London, Amsterdam, and Chicago.</p>' +
            '<br/>' +
            '<p><strong>VALUATION SERVICE</strong></p>' +
            '<br/>' +
            '<p>If you require a valuation of any of your classic gear, please forward a brief description and pictures, and we will come back to you ASAP.</p>';
        
        let description = data.description || '';
        // Only add footer if it's not already there
        if (!description.includes('ALL EU PURCHASES ARE DELIVERED WITH TAXES AND DUTIES PAID')) {
            description += standardFooter;
        }
        setValueIfExists('description', description);
        setValueIfExists('condition', data.condition);
        setValueIfExists('status', 'ACTIVE'); // Default to active
        
        // Pricing & Inventory
        setValueIfExists('base_price', data.base_price);
        setValueIfExists('processing_time', data.processing_time || '3');
        setValueIfExists('collective_discount', data.collective_discount || '0');
        setValueIfExists('offer_discount', data.offer_discount || '0');
        
        // Checkboxes
        setCheckedIfExists('in_collective', data.in_collective);
        setCheckedIfExists('in_inventory', data.in_inventory !== false);
        setCheckedIfExists('buy_now', data.buy_now !== false);
        setCheckedIfExists('is_stocked_item', data.is_stocked_item);
        
        // Shipping checkboxes (now in shipping section)
        setCheckedIfExists('free_shipping_option', data.free_shipping);
        setCheckedIfExists('local_pickup_option', data.local_pickup);
        setCheckedIfExists('available_for_shipment_option', data.available_for_shipment !== false);
        
        // If is_stocked_item is checked, set quantity
        if (data.is_stocked_item && data.quantity) {
            setValueIfExists('quantity', data.quantity);
            // Trigger the toggle to show quantity field
            if (typeof toggleQuantityField === 'function') {
                toggleQuantityField();
            }
        }
        
        // URLs
        setValueIfExists('video_url', data.video_url);
        setValueIfExists('external_link', data.external_link);
        
        // Platform data - eBay
        if (data.platform_data && data.platform_data.ebay) {
            setValueIfExists('ebay_category_id', data.platform_data.ebay.category_id);
            setValueIfExists('ebay_format', data.platform_data.ebay.format || 'FixedPrice');
            setValueIfExists('ebay_duration', data.platform_data.ebay.duration || 'GTC');
            setCheckedIfExists('ebay_sync_inventory', data.platform_data.ebay.sync_inventory !== false);
        }
        
        // Platform data - Reverb
        if (data.platform_data && data.platform_data.reverb) {
            setValueIfExists('reverb_product_type', data.platform_data.reverb.product_type);
            setValueIfExists('reverb_primary_category', data.platform_data.reverb.primary_category);
            setValueIfExists('reverb_category_uuid', data.platform_data.reverb.category_uuid);
            setValueIfExists('reverb_shipping_profile', data.platform_data.reverb.shipping_profile);
            setCheckedIfExists('reverb_offers_enabled', data.platform_data.reverb.offers_enabled !== false);
        }
        
        // Platform data - V&R
        if (data.platform_data && data.platform_data.vr) {
            setValueIfExists('vr_category', data.platform_data.vr.category);
            setValueIfExists('vr_featured', data.platform_data.vr.featured);
            setValueIfExists('vr_notes', data.platform_data.vr.notes);
        }
        
        // Platform data - Shopify
        if (data.platform_data && data.platform_data.shopify) {
            setValueIfExists('shopify_category', data.platform_data.shopify.category);
            setValueIfExists('shopify_priority', data.platform_data.shopify.priority);
            setValueIfExists('shopify_seo_keywords', data.platform_data.shopify.seo_keywords);
            setValueIfExists('shopify_short_description', data.platform_data.shopify.short_description);
        }
    }

    function setValueIfExists(id, value) {
        const element = document.getElementById(id);
        if (element && value !== undefined && value !== null) {
            element.value = value;
            
            // Special handling for category field to prevent value loss
            if (id === 'category') {
                console.log(`Setting category value: ${value}`);
                lastKnownCategoryValue = value;
                element.setAttribute('value', value);
            }
            
            // Clear any existing validation errors immediately
            element.classList.remove('border-red-500');
            const errorMsg = document.getElementById(`${id}-error`);
            if (errorMsg) {
                console.log(`Removing validation error for ${id}`);
                errorMsg.remove();
            }
            
            // Trigger both input and change events to ensure all handlers fire
            const inputEvent = new Event('input', { bubbles: true });
            element.dispatchEvent(inputEvent);
            
            const changeEvent = new Event('change', { bubbles: true });
            element.dispatchEvent(changeEvent);
        }
    }

    function setCheckedIfExists(id, value) {
        const element = document.getElementById(id);
        if (element) {
            element.checked = !!value;
        }
    }
    

    // =========== GENERATE SKU ===========
    // Generate SKU - updated for new autogen logic.
    const generateSkuButton = document.getElementById('generateSku');
    if (generateSkuButton) {
        generateSkuButton.addEventListener('click', async function() {
            try {
                // Show loading state
                generateSkuButton.disabled = true;
                generateSkuButton.innerHTML = `
                    <svg class="animate-spin h-4 w-4 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                `;
                
                // Call API endpoint to get next available SKU
                const response = await fetch('/inventory/api/next-sku');
                const data = await response.json();
                
                if (data.sku) {
                    document.getElementById('sku').value = data.sku;
                } else {
                    alert('Error generating SKU: ' + data.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Error generating SKU:', error);
                alert('Error generating SKU. Please try again.');
            } finally {
                // Restore button state
                generateSkuButton.disabled = false;
                generateSkuButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                `;
            }
        });
    }
    

    // =========== FORM VALIDATION ===========
    // Form validation and submission
    const form = document.getElementById('addProductForm');
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault(); // Always prevent default submission for inspection

            // Sync TinyMCE content back to textarea before validation
            if (typeof tinymce !== 'undefined' && tinymce.get('description')) {
                tinymce.get('description').save();
            }

            let isValid = true;
            const requiredFields = form.querySelectorAll('[required]');
            
            // Special handling for category field
            const categoryField = document.getElementById('category');
            if (categoryField) {
                console.log('Category field value:', categoryField.value);
                console.log('Category field trimmed value:', categoryField.value.trim());
                console.log('Last known category value:', lastKnownCategoryValue);
                
                // If the category field is empty but we have a last known value, restore it
                if (!categoryField.value && lastKnownCategoryValue) {
                    console.warn('Category field is empty during validation! Restoring last known value:', lastKnownCategoryValue);
                    categoryField.value = lastKnownCategoryValue;
                    categoryField.setAttribute('value', lastKnownCategoryValue);
                }
            }
            
            requiredFields.forEach(field => {
                // Log each required field for debugging
                if (field.id === 'category') {
                    console.log(`Validating ${field.id}: value="${field.value}", trimmed="${field.value.trim()}", empty=${!field.value.trim()}`);
                }
                if (field.id === 'shipping_profile') {
                    if (!field.value.trim()) {
                        isValid = false;
                        shippingProfilesLoaded = true;
                        updateCreateButtonState();
                    } else {
                        updateCreateButtonState();
                    }
                    return;
                }
                
                if (!field.value.trim()) {
                    isValid = false;
                    field.classList.add('border-red-500');
                    
                    // Add error message if not exists
                    const errorId = `${field.id}-error`;
                    if (!document.getElementById(errorId)) {
                        const errorMsg = document.createElement('p');
                        errorMsg.id = errorId;
                        errorMsg.className = 'text-red-500 text-xs mt-1';
                        errorMsg.textContent = 'This field is required';
                        field.parentNode.appendChild(errorMsg);
                    }
                } else {
                    field.classList.remove('border-red-500');
                    const errorMsg = document.getElementById(`${field.id}-error`);
                    if (errorMsg) {
                        errorMsg.remove();
                    }
                }
            });
            
            if (!isValid) {
                // Scroll to the first error
                const firstError = form.querySelector('.border-red-500');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return false;
            }
            
            // Log all form values for debugging
            console.log('Form submission started - INSPECTION MODE');
            const formData = new FormData(form);

            // Clean up empty numeric fields to avoid validation errors
            const numericFields = ['base_price', 'offer_discount', 'platform_data__ebay__price',
                                 'platform_data__reverb__price', 'platform_data__vr__price',
                                 'platform_data__shopify__price'];

            numericFields.forEach(field => {
                if (formData.has(field) && formData.get(field) === '') {
                    console.log(`Removing empty field: ${field}`);
                    formData.delete(field);
                }
            });

            for (let [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
            }
            
            // Add platform sync fields based on form state
            const syncAll = document.getElementById('sync_all_yes').checked;
            
            if (syncAll) {
                // If sync all is checked, enable all platforms
                formData.append('sync_shopify', 'true');
                formData.append('sync_ebay', 'true');
                formData.append('sync_vr', 'true');
                formData.append('sync_reverb', 'true');
            } else {
                // Check individual platform checkboxes
                const platforms = ['shopify', 'ebay', 'vr', 'reverb'];
                platforms.forEach(platform => {
                    const checkbox = document.getElementById(`sync_${platform}`);
                    formData.append(`sync_${platform}`, checkbox && checkbox.checked ? 'true' : 'false');
                });
            }
            
            // Add platform-specific fields with proper names
            // eBay
            const ebayCategory = document.getElementById('ebay_category_id');
            if (ebayCategory && ebayCategory.value) {
                formData.append('ebay_category', ebayCategory.value);
                // Get the selected option's text for category name
                const selectedOption = ebayCategory.options[ebayCategory.selectedIndex];
                if (selectedOption) {
                    formData.append('ebay_category_name', selectedOption.text);
                }
            }
            formData.append('ebay_price', document.getElementById('ebay_price')?.value || '');
            formData.append('ebay_payment_policy', document.getElementById('ebay_payment_policy')?.value || '');
            formData.append('ebay_return_policy', document.getElementById('ebay_return_policy')?.value || '');
            formData.append('ebay_shipping_policy', document.getElementById('ebay_shipping_policy')?.value || '');
            
            // Reverb - use platform_data__ prefix for proper processing
            const reverbPrice = document.getElementById('reverb_price')?.value;
            if (reverbPrice) {
                formData.append('platform_data__reverb__price', reverbPrice);
            }

            // Get both the category name and UUID
            const reverbCategoryName = document.getElementById('reverb_primary_category')?.value || '';
            const reverbUUID = document.getElementById('reverb_category_uuid')?.value || '';

            // Log for debugging
            console.log('Reverb Category Name:', reverbCategoryName);
            console.log('Reverb Category UUID:', reverbUUID);

            // The server expects the UUID in the primary_category field
            if (reverbUUID) {
                formData.append('platform_data__reverb__primary_category', reverbUUID);
            } else if (reverbCategoryName) {
                // Fallback to category name if UUID is not available
                console.warn('No UUID found for Reverb category, using name:', reverbCategoryName);
                formData.append('platform_data__reverb__primary_category', reverbCategoryName);
            }

            const reverbProductType = document.getElementById('reverb_product_type')?.value;
            if (reverbProductType) {
                formData.append('platform_data__reverb__product_type', reverbProductType);
            }
            
            // V&R
            const vrCategory = document.getElementById('vr_category');
            if (vrCategory && vrCategory.value) {
                const vrParts = vrCategory.value.split('/');
                if (vrParts[0]) formData.append('vr_category_id', vrParts[0]);
                if (vrParts[1]) formData.append('vr_subcategory_id', vrParts[1]);
                if (vrParts[2]) formData.append('vr_sub_subcategory_id', vrParts[2]);
                if (vrParts[3]) formData.append('vr_sub_sub_subcategory_id', vrParts[3]);
            }
            formData.append('vr_price', document.getElementById('vr_price')?.value || '');
            
            // Shopify
            const shopifyCategory = document.getElementById('shopify_category');
            formData.append('shopify_category_gid', shopifyCategory?.value || '');
            formData.append('shopify_price', document.getElementById('shopify_price')?.value || '');
            // Extract just the product type text without the GID
            if (shopifyCategory && shopifyCategory.selectedOptions[0]) {
                const fullText = shopifyCategory.selectedOptions[0].text;
                // Remove the GID part in parentheses if it exists
                const productType = fullText.replace(/\s*\(gid:.*\)$/, '').trim();
                formData.append('shopify_product_type', productType);
            } else {
                formData.append('shopify_product_type', '');
            }
            
            // Add shipping profile for Reverb
            const shippingProfileValue = document.getElementById('shipping_profile')?.value || '';
            if (shippingProfileValue) {
                formData.append('platform_data__reverb__shipping_profile', shippingProfileValue);
            }

            // Legacy field for backward compatibility
            formData.append('shipping_profile', shippingProfileValue);
            
            // Handle images properly based on their source
            // First, handle file uploads
            const fileImages = selectedImages.filter(img => img.source === 'file' && img.file);
            if (fileImages.length > 0) {
                await appendImageFilesToFormData(formData, fileImages);
            }

            // Then handle URL/Dropbox images from hidden inputs
            const primaryImageUrl = document.getElementById('primary-image-input')?.value || '';
            const additionalImagesUrls = document.getElementById('additional-images-input')?.value || '';

            // Use correct field names that match the server expectations
            if (primaryImageUrl) {
                formData.append('primary_image_url', primaryImageUrl);
            }
            if (additionalImagesUrls) {
                formData.append('additional_images_urls', additionalImagesUrls);
            }
            
            console.log('Primary image:', primaryImageUrl);
            console.log('Additional images:', additionalImagesUrls);
            
            // Show creating modal
            const creatingModal = document.createElement('div');
            creatingModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            creatingModal.innerHTML = `
                <div class="bg-white rounded-lg max-w-lg w-full p-6">
                    <div class="flex items-center">
                        <svg class="animate-spin h-5 w-5 mr-3 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <h2 class="text-xl font-semibold">Creating Product on Platforms...</h2>
                    </div>
                    <p class="mt-4 text-gray-600">Please wait while we create your product across the selected platforms.</p>
                    <p class="mt-2 text-sm text-gray-500">Check the console for detailed progress logs.</p>
                </div>
            `;
            document.body.appendChild(creatingModal);

            // Call actual creation endpoint
            try {
                console.log('🚀 Starting product creation across platforms...');
                console.log('Form data being sent:', Object.fromEntries(formData));

                const response = await fetch('/inventory/add', {
                    method: 'POST',
                    body: formData
                });

                // Remove creating modal
                document.body.removeChild(creatingModal);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ Server error response:', errorText);
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                console.log('✅ CREATION RESULT:', result);

                // Check if the result indicates an error
                if (result.status === 'error') {
                    // Display the error message properly
                    const errorModal = document.createElement('div');
                    errorModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                    errorModal.innerHTML = `
                        <div class="bg-white rounded-lg max-w-2xl w-full overflow-hidden">
                            <div class="p-6 border-b bg-red-50">
                                <h2 class="text-2xl font-bold text-red-800">Error Creating Product</h2>
                            </div>
                            <div class="p-6">
                                <div class="mb-4">
                                    <p class="text-red-700 font-medium">${result.error || 'An unknown error occurred'}</p>
                                </div>
                                ${result.platform_statuses ? `
                                <div class="mt-4 p-4 bg-gray-50 rounded">
                                    <h3 class="font-semibold mb-2">Platform Status:</h3>
                                    <pre class="text-xs overflow-x-auto">${JSON.stringify(result.platform_statuses, null, 2)}</pre>
                                </div>` : ''}
                            </div>
                            <div class="p-6 border-t flex justify-end gap-3">
                                <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                                    Close
                                </button>
                                ${result.error && result.error.includes('Suggested next SKU') ?
                                    `<button onclick="
                                        const match = '${result.error}'.match(/Suggested next SKU: ([A-Z0-9-]+)/);
                                        if (match) {
                                            document.getElementById('sku').value = match[1];
                                            this.closest('.fixed').remove();
                                        }
                                    " class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        Use Suggested SKU
                                    </button>` : ''
                                }
                            </div>
                        </div>
                    `;
                    document.body.appendChild(errorModal);
                    return;
                }

                // Check if we have a redirect URL in the response
                if (result.redirect_url) {
                    // Redirect to the product detail page with platform status
                    window.location.href = result.redirect_url;
                } else {
                    // Show success/error summary
                    const summaryModal = document.createElement('div');
                    summaryModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                    summaryModal.innerHTML = `
                        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-hidden">
                            <div class="p-6 border-b">
                                <h2 class="text-2xl font-bold text-gray-800">Product Creation Results</h2>
                            </div>
                            <div class="p-6 overflow-y-auto max-h-[70vh]">
                                <pre class="bg-gray-100 p-4 rounded-lg text-xs overflow-x-auto">${JSON.stringify(result, null, 2)}</pre>
                            </div>
                            <div class="p-6 border-t flex justify-end">
                                <button onclick="window.location.reload()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Create Another Product
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(summaryModal);
                }

            } catch (error) {
                console.error('Error inspecting payload:', error);
                alert('Error generating inspection payload. Check console for details.');
            }
            
            return false; // Prevent actual form submission
        });
        
        // Clear validation errors when typing
        const formInputs = form.querySelectorAll('input, select, textarea');
        formInputs.forEach(input => {
            input.addEventListener('input', function() {
                this.classList.remove('border-red-500');
                const errorMsg = document.getElementById(`${this.id}-error`);
                if (errorMsg) {
                    errorMsg.remove();
                }
            });
        });
    }

    // =========== DRAFT MANAGEMENT FUNCTIONALITY ===========
    // Load available drafts
    async function loadDrafts() {
        try {
            const response = await fetch('/inventory/drafts');
            const data = await response.json();

            const draftSelector = document.getElementById('draftSelector');
            const loadDraftButton = document.getElementById('loadDraftButton');

            // Clear existing options except the first one
            while (draftSelector.options.length > 1) {
                draftSelector.remove(1);
            }

            // Add drafts to the selector
            data.drafts.forEach(draft => {
                const option = document.createElement('option');
                option.value = draft.id;
                const date = new Date(draft.updated_at);
                const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                // Create full text for tooltip
                const fullText = `${draft.brand} ${draft.model} - ${draft.sku} (${formattedDate})`;
                option.title = fullText;

                // Create truncated text for display
                const displayText = `${draft.brand} ${draft.model} - ${draft.sku}`;
                const truncatedText = displayText.length > 50 ? displayText.substring(0, 47) + '...' : displayText;
                option.textContent = truncatedText;

                draftSelector.appendChild(option);
            });

            // Enable/disable load button based on selection
            draftSelector.addEventListener('change', function() {
                loadDraftButton.disabled = !this.value;
            });

            // Handle load draft button click
            loadDraftButton.addEventListener('click', async function() {
                const draftId = draftSelector.value;
                if (!draftId) return;

                try {
                    const response = await fetch(`/inventory/drafts/${draftId}`);
                    const draft = await response.json();

                    console.log('Draft data received:', draft);

                    // Helper function to decode HTML entities
                    function decodeHtmlEntities(text) {
                        const textarea = document.createElement('textarea');
                        textarea.innerHTML = text;
                        return textarea.value;
                    }

                    // Fill in the form fields with better error handling
                    const setFieldValue = (fieldId, value, defaultValue = '') => {
                        const field = document.getElementById(fieldId);
                        if (field) {
                            // Handle null, undefined, and empty values properly
                            if (value !== null && value !== undefined && value !== '') {
                                field.value = value;
                                console.log(`Set field ${fieldId} to: ${value}`);
                            } else if (defaultValue) {
                                field.value = defaultValue;
                                console.log(`Set field ${fieldId} to default: ${defaultValue}`);
                            } else {
                                field.value = '';
                                console.log(`Set field ${fieldId} to empty`);
                            }
                        } else {
                            console.warn(`Field not found: ${fieldId}`);
                        }
                    };

                    setFieldValue('brand', draft.brand);
                    setFieldValue('model', draft.model);
                    setFieldValue('sku', draft.sku);
                    // Handle title field
                    const titleField = document.getElementById('title');

                    if (draft.title) {
                        // Use saved title
                        setFieldValue('title', draft.title);
                    } else {
                        // Auto-generate title after other fields are populated
                        setTimeout(() => {
                            if (!titleField?.value) {
                                const brandField = document.getElementById('brand');
                                const modelField = document.getElementById('model');
                                const yearField = document.getElementById('year');
                                const finishField = document.getElementById('finish');

                                const brand = brandField?.value || '';
                                const model = modelField?.value || '';
                                const year = yearField?.value || '';
                                const finish = finishField?.value || '';

                                // Generate title based on available fields
                                // Avoid duplicating finish if it's already in the model
                                const titleParts = [];
                                if (year) titleParts.push(year);
                                if (brand) titleParts.push(brand);
                                if (model) titleParts.push(model);
                                // Only add finish if it's not already included in the model
                                if (finish && !model.toLowerCase().includes(finish.toLowerCase())) {
                                    titleParts.push(finish);
                                }

                                const generatedTitle = titleParts.join(' ');
                                if (generatedTitle && titleField) {
                                    titleField.value = generatedTitle;
                                }
                            }
                        }, 500);
                    }
                    setFieldValue('category', draft.category);
                    lastKnownCategoryValue = draft.category || ''; // Update the cached value
                    setFieldValue('condition', draft.condition);
                    // Base price has both display and hidden fields
                    if (draft.base_price !== null && draft.base_price !== undefined) {
                        setFieldValue('base_price', draft.base_price);
                        setFieldValue('base_price_display', draft.base_price);

                        // Calculate and update platform prices based on base price
                        updatePlatformPrices(draft.base_price);
                    }
                    setFieldValue('quantity', draft.quantity, 1);
                    // Decode HTML entities in description and update TinyMCE
                    if (draft.description) {
                        const decodedDescription = decodeHtmlEntities(draft.description);
                        setFieldValue('description', decodedDescription);

                        // Update TinyMCE editor
                        if (typeof tinymce !== 'undefined' && tinymce.get('description')) {
                            tinymce.get('description').setContent(decodedDescription);
                        }
                    }
                    // Set year first
                    setFieldValue('year', draft.year);

                    // Calculate and set decade based on year if decade is not set
                    if (draft.year && !draft.decade) {
                        const year = parseInt(draft.year);
                        if (year && year >= 1900 && year <= 2030) {
                            const decade = Math.floor(year / 10) * 10;
                            setFieldValue('decade', decade);
                        }
                    } else if (draft.decade) {
                        setFieldValue('decade', draft.decade);
                    }
                    setFieldValue('finish', draft.finish);
                    setFieldValue('processing_time', draft.processing_time, 3);
                    // Skip location and stock_warning_level - they don't exist in the Product model
                    // Skip offer_price - only offer_discount exists
                    if (draft.offer_discount !== null && draft.offer_discount !== undefined) {
                        setFieldValue('offer_discount', draft.offer_discount);
                    }

                    // Handle checkboxes
                    const setCheckbox = (fieldId, value, defaultValue = false) => {
                        const field = document.getElementById(fieldId);
                        if (field) {
                            field.checked = value !== undefined ? value : defaultValue;
                        } else {
                            console.warn(`Checkbox not found: ${fieldId}`);
                        }
                    };

                    setCheckbox('in_collective', draft.in_collective, false);
                    setCheckbox('in_inventory', draft.in_inventory, true);
                    setCheckbox('in_reseller', draft.in_reseller, false);
                    setCheckbox('free_shipping', draft.free_shipping, false);
                    setCheckbox('buy_now', draft.buy_now, true);
                    setCheckbox('show_vat', draft.show_vat, true);
                    setCheckbox('local_pickup', draft.local_pickup, false);
                    setCheckbox('available_for_shipment', draft.available_for_shipment, true);
                    setCheckbox('is_stocked_item', draft.is_stocked_item, false);

                    // Handle media fields
                    setFieldValue('video_url', draft.video_url);
                    setFieldValue('external_link', draft.external_link);

                    // Handle images
                    selectedImages = [];
                    let hasDropboxImages = false;
                    let hasLocalImages = false;
                    let hasUrlImages = false;

                    if (draft.primary_image) {
                        const isDropbox = draft.primary_image.includes('dropbox');
                        const isDataUrl = draft.primary_image.startsWith('data:');

                        if (isDropbox) hasDropboxImages = true;
                        else if (isDataUrl) hasLocalImages = true;
                        else hasUrlImages = true;

                        selectedImages.push({
                            url: draft.primary_image,
                            name: 'Primary Image',
                            source: isDropbox ? 'dropbox' : (isDataUrl ? 'file' : 'url')
                        });
                    }
                    if (draft.additional_images && draft.additional_images.length > 0) {
                        draft.additional_images.forEach((url, index) => {
                            const isDropbox = url.includes('dropbox');
                            const isDataUrl = url.startsWith('data:');

                            if (isDropbox) hasDropboxImages = true;
                            else if (isDataUrl) hasLocalImages = true;
                            else hasUrlImages = true;

                            selectedImages.push({
                                url: url,
                                name: `Additional Image ${index + 1}`,
                                source: isDropbox ? 'dropbox' : (isDataUrl ? 'file' : 'url')
                            });
                        });
                    }
                    updateImagePreview();
                    updateHiddenInputs();
                    updateImageCount();

                    // Switch to appropriate tab based on image sources
                    if (hasDropboxImages) {
                        document.getElementById('tab-dropbox')?.click();
                    } else if (hasLocalImages) {
                        document.getElementById('tab-upload')?.click();
                    } else if (hasUrlImages) {
                        document.getElementById('tab-url')?.click();
                    }

                    // Handle platform data if available
                    if (draft.platform_data) {
                        const pd = draft.platform_data;

                        // Set sync options
                        if (pd.sync_all) {
                            const syncAllYes = document.getElementById('sync_all_yes');
                            if (syncAllYes) syncAllYes.checked = true;
                        } else {
                            const syncAllNo = document.getElementById('sync_all_no');
                            if (syncAllNo) syncAllNo.checked = true;
                            // Set individual platform checkboxes
                            document.querySelectorAll('input[name="sync_platforms"]').forEach(cb => {
                                cb.checked = pd.sync_platforms && pd.sync_platforms.includes(cb.value);
                            });
                        }

                        // Set platform-specific fields
                        // eBay
                        if (pd.ebay) {
                            if (pd.ebay.category) {
                                // Wait for categories to load if needed
                                if (!window.categoriesLoaded.ebay) {
                                    window.pendingCategorySelections.ebay = pd.ebay.category;
                                } else {
                                    setFieldValue('ebay_category_id', pd.ebay.category);
                                }
                            }
                            if (pd.ebay.category_name) setFieldValue('ebay_category_name', pd.ebay.category_name);
                            if (pd.ebay.price) {
                                setFieldValue('ebay_price', pd.ebay.price);
                                setFieldValue('ebay_price_display', pd.ebay.price);
                                // Trigger input event to sync hidden field
                                const ebayPriceDisplay = document.getElementById('ebay_price_display');
                                if (ebayPriceDisplay) {
                                    ebayPriceDisplay.dispatchEvent(new Event('input'));
                                }
                            }
                            if (pd.ebay.payment_policy) setFieldValue('ebay_payment_policy', pd.ebay.payment_policy);
                            if (pd.ebay.return_policy) setFieldValue('ebay_return_policy', pd.ebay.return_policy);
                            if (pd.ebay.shipping_policy) setFieldValue('ebay_shipping_policy', pd.ebay.shipping_policy);
                            if (pd.ebay.location) setFieldValue('ebay_location', pd.ebay.location);
                            if (pd.ebay.country) setFieldValue('ebay_country', pd.ebay.country);
                            if (pd.ebay.postal_code) setFieldValue('ebay_postal_code', pd.ebay.postal_code);
                        }

                        // Reverb
                        if (pd.reverb) {
                            if (pd.reverb.product_type) setFieldValue('reverb_product_type', pd.reverb.product_type);
                            if (pd.reverb.primary_category) setFieldValue('reverb_primary_category', pd.reverb.primary_category);
                            if (pd.reverb.price) {
                                setFieldValue('reverb_price', pd.reverb.price);
                                setFieldValue('reverb_price_display', pd.reverb.price);
                                // Trigger input event to sync hidden field
                                const reverbPriceDisplay = document.getElementById('reverb_price_display');
                                if (reverbPriceDisplay) {
                                    reverbPriceDisplay.dispatchEvent(new Event('input'));
                                }
                            }
                            if (pd.reverb.shipping_profile) {
                                setFieldValue('shipping_profile', pd.reverb.shipping_profile);
                                // Trigger change event to populate shipping fields
                                const shippingSelect = document.getElementById('shipping_profile');
                                if (shippingSelect) {
                                    shippingSelect.dispatchEvent(new Event('change'));
                                }
                            }
                        }

                        // V&R
                        if (pd.vr) {
                            // V&R uses a combined category field in format "category_id/subcategory_id/sub_subcategory_id"
                            if (pd.vr.category_id || pd.vr.subcategory_id || pd.vr.sub_subcategory_id) {
                                const vrCategoryValue = [
                                    pd.vr.category_id,
                                    pd.vr.subcategory_id,
                                    pd.vr.sub_subcategory_id,
                                    pd.vr.sub_sub_subcategory_id
                                ].filter(Boolean).join('/');

                                // Wait for categories to load if needed
                                if (!window.categoriesLoaded.vr) {
                                    window.pendingCategorySelections.vr = vrCategoryValue;
                                } else {
                                    setFieldValue('vr_category', vrCategoryValue);
                                }
                            }
                            if (pd.vr.price) {
                                setFieldValue('vr_price', pd.vr.price);
                                setFieldValue('vr_price_display', pd.vr.price);
                                // Trigger input event to sync hidden field
                                const vrPriceDisplay = document.getElementById('vr_price_display');
                                if (vrPriceDisplay) {
                                    vrPriceDisplay.dispatchEvent(new Event('input'));
                                }
                            }
                        }

                        // Shopify
                        if (pd.shopify) {
                            if (pd.shopify.category_gid) {
                                // Wait for categories to load if needed
                                if (!window.categoriesLoaded.shopify) {
                                    window.pendingCategorySelections.shopify = pd.shopify.category_gid;
                                } else {
                                    setFieldValue('shopify_category', pd.shopify.category_gid);
                                }
                            }
                            // If a specific price was saved, use it; otherwise it will use the calculated value
                            if (pd.shopify.price !== null && pd.shopify.price !== undefined) {
                                console.log('Loading saved Shopify price:', pd.shopify.price);
                                setFieldValue('shopify_price', pd.shopify.price);
                                setFieldValue('shopify_price_display', pd.shopify.price);
                                // Trigger input event to sync hidden field
                                const shopifyPriceDisplay = document.getElementById('shopify_price_display');
                                if (shopifyPriceDisplay) {
                                    shopifyPriceDisplay.dispatchEvent(new Event('input'));
                                }
                            }
                            if (pd.shopify.product_type) setFieldValue('shopify_product_type', pd.shopify.product_type);

                            // Additional Shopify fields that might have been saved
                            console.log('Shopify SEO keywords from draft:', pd.shopify.seo_keywords);
                            if (pd.shopify.seo_keywords) {
                                console.log('Setting SEO keywords to:', pd.shopify.seo_keywords);
                                setFieldValue('shopify_seo_keywords', pd.shopify.seo_keywords);

                                // Double-check the value was set
                                const seoField = document.getElementById('shopify_seo_keywords');
                                console.log('SEO field after setting:', seoField?.value);
                            }
                        }
                    }

                    // Store draft ID for updating when saving
                    form.dataset.draftId = draftId;

                    // Show success notification
                    const notification = document.createElement('div');
                    notification.className = 'fixed bottom-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50';
                    notification.innerHTML = `
                        <span class="block sm:inline">Draft loaded successfully</span>
                    `;
                    document.body.appendChild(notification);

                    setTimeout(() => {
                        notification.remove();
                    }, 3000);

                } catch (error) {
                    console.error('Error loading draft:', error);
                    console.error('Error stack:', error.stack);
                    console.error('Error message:', error.message);
                    alert('Error loading draft: ' + error.message);
                }
            });

        } catch (error) {
            console.error('Error loading drafts:', error);
        }
    }

    // =========== SAVE DRAFT FUNCTIONALITY ===========
    const saveDraftBtn = document.getElementById('saveDraftBtn');
    if (saveDraftBtn) {
        saveDraftBtn.addEventListener('click', async function() {
            // Sync TinyMCE content back to textarea before collecting form data
            if (typeof tinymce !== 'undefined' && tinymce.get('description')) {
                tinymce.get('description').save();
                console.log('TinyMCE content synced to textarea');
            }

            // Ensure auto-generated fields like title are populated before collecting form data
            if (typeof generateTitle === 'function') {
                const titleField = document.getElementById('title');
                if (titleField && !titleField.value.trim()) {
                    generateTitle();
                    titleField.dataset.autoGenerated = 'true';
                }
            }

            // Collect form data just like for normal submission
            const formData = new FormData(form);

            // Debug: Check if description is in formData
            const descriptionValue = formData.get('description');
            console.log('Description field value:', descriptionValue);
            console.log('Description length:', descriptionValue ? descriptionValue.length : 0);

            // Remove large base64 images and file uploads to avoid exceeding size limits
            // We only need the URLs, not the actual file data for drafts
            const keysToRemove = [];
            for (let [key, value] of formData.entries()) {
                // Only remove base64 image strings, keep File objects
                if (typeof value === 'string' && value.startsWith('data:image/')) {
                    keysToRemove.push(key);
                    console.log(`Removing base64 image string from ${key} for draft save`);
                }
            }

            // Actually remove the keys
            keysToRemove.forEach(key => formData.delete(key));

            // Also clean the hidden inputs that might contain base64 data
            // Only keep non-base64 URLs in the additional_images_urls field
            const additionalImagesInput = formData.get('additional_images_urls');
            if (additionalImagesInput) {
                let urls = [];
                try {
                    // Try parsing as JSON first (new format)
                    urls = JSON.parse(additionalImagesInput);
                } catch {
                    // Fall back to newline-separated format
                    urls = additionalImagesInput.split('\n').filter(url => url.trim());
                }

                // Filter out base64 images
                const cleanUrls = urls.filter(url => url && !url.startsWith('data:image/'));
                formData.set('additional_images_urls', JSON.stringify(cleanUrls));

                console.log(`Filtered additional images: ${urls.length} -> ${cleanUrls.length}`);
            }

            // Clean primary image URL if it's base64
            const primaryImageUrlValue = formData.get('primary_image_url');
            if (primaryImageUrlValue && primaryImageUrlValue.startsWith('data:image/')) {
                formData.delete('primary_image_url');
                console.log('Removed base64 primary image URL');
            }

            // Also check and clean the hidden image inputs
            const hiddenImageFields = ['primary_image_url', 'additional_images_urls',
                                     'primary-image-input', 'additional-images-input'];

            hiddenImageFields.forEach(fieldName => {
                const fieldValue = formData.get(fieldName);
                if (fieldValue && typeof fieldValue === 'string') {
                    // Check if it contains base64 data
                    if (fieldValue.includes('data:image/') || fieldValue.length > 100000) {
                        console.log(`Cleaning hidden field ${fieldName} (size: ${(fieldValue.length / 1024).toFixed(2)}KB)`);

                        // For additional images, try to parse and clean
                        if (fieldName.includes('additional')) {
                            try {
                                let urls = [];
                                try {
                                    urls = JSON.parse(fieldValue);
                                } catch {
                                    urls = fieldValue.split('\n').filter(url => url.trim());
                                }
                                const cleanUrls = urls.filter(url => url && !url.startsWith('data:image/') && url.length < 1000);
                                formData.set(fieldName, JSON.stringify(cleanUrls));
                                console.log(`Cleaned ${fieldName}: ${urls.length} -> ${cleanUrls.length} URLs`);
                            } catch (e) {
                                formData.delete(fieldName);
                                console.log(`Deleted problematic field ${fieldName}`);
                            }
                        } else {
                            // For primary image, just delete if it's base64
                            formData.delete(fieldName);
                        }
                    }
                }
            });

            // Debug: Log the size of remaining form data
            let totalSize = 0;
            const largeFields = [];
            const allFields = [];

            for (let [key, value] of formData.entries()) {
                let size = 0;
                let valuePreview = '';

                if (value instanceof File) {
                    size = value.size;
                    valuePreview = `File: ${value.name} (${value.type})`;
                } else {
                    size = new Blob([value]).size;
                    // Show preview of value - truncate if too long
                    valuePreview = String(value);
                    if (valuePreview.length > 100) {
                        valuePreview = valuePreview.substring(0, 100) + '...';
                    }
                }

                totalSize += size;
                allFields.push({
                    key,
                    size: size,
                    sizeKB: (size / 1024).toFixed(2) + 'KB',
                    preview: valuePreview
                });

                if (size > 10000) { // Log fields larger than 10KB
                    largeFields.push({
                        key,
                        size: (size / 1024).toFixed(2) + 'KB',
                        preview: valuePreview
                    });
                }
            }

            console.log(`Total FormData size: ${(totalSize / 1024).toFixed(2)}KB`);
            console.log('Total fields:', allFields.length);

            if (largeFields.length > 0) {
                console.log('Large fields (>10KB):', largeFields);
            }

            // Sort all fields by size and show top 10
            allFields.sort((a, b) => b.size - a.size);
            console.log('Top 10 largest fields:', allFields.slice(0, 10));

            // Check for any remaining image data or large text fields
            const MAX_FIELD_SIZE = 500000; // 500KB max per field for drafts
            const DESCRIPTION_MAX_SIZE = 100000; // 100KB for description (should be plenty)

            for (let [key, value] of formData.entries()) {
                if (typeof value === 'string') {
                    // Check for base64 patterns we might have missed
                    if (value.includes('base64') || value.includes('data:') || value.match(/^[A-Za-z0-9+/]{1000,}/)) {
                        console.warn(`WARNING: Field ${key} might contain encoded data (length: ${value.length})`);
                    }

                    // Special handling for description - NEVER truncate it
                    if (key === 'description') {
                        console.log(`Found description field, length: ${value.length} characters (${(value.length / 1024).toFixed(2)}KB)`);
                        // Do NOT truncate description at all
                        continue;
                    } else if (value.length > MAX_FIELD_SIZE) {
                        // For other fields, be more aggressive with truncation
                        const truncated = value.substring(0, MAX_FIELD_SIZE);
                        formData.set(key, truncated);
                        console.log(`Truncated oversized field: ${key} from ${(value.length / 1024).toFixed(2)}KB to ${(MAX_FIELD_SIZE / 1024).toFixed(2)}KB`);
                    }
                }
            }

            // Clean up empty numeric fields
            const numericFields = ['base_price', 'offer_discount', 'platform_data__ebay__price',
                                 'platform_data__reverb__price', 'platform_data__vr__price',
                                 'platform_data__shopify__price'];

            numericFields.forEach(field => {
                if (formData.has(field) && formData.get(field) === '') {
                    formData.delete(field);
                }
            });

            // Clean up integer fields that should be null if empty
            const integerFields = ['year', 'decade', 'quantity'];
            integerFields.forEach(field => {
                const value = formData.get(field);
                if (value === '' || value === null) {
                    formData.delete(field);
                    console.log(`Removed empty integer field: ${field}`);
                }
            });

            // Ensure required fields have values
            if (!formData.has('base_price') || formData.get('base_price') === '') {
                const displayValue = document.getElementById('base_price_display')?.value;
                if (displayValue && displayValue !== '') {
                    formData.set('base_price', displayValue);
                } else {
                    formData.set('base_price', '0');
                }
                console.log(`Set base_price to: ${formData.get('base_price')}`);
            }

            // Ensure quantity has a default if not set
            if (!formData.has('quantity')) {
                formData.set('quantity', '1');
            }

            // Map platform fields from their form names to what the endpoint expects
            // The form uses platform_data__ prefix but the endpoint expects direct field names

            // Get values directly from elements since FormData might not have all fields

            // eBay fields
            formData.append('ebay_category', document.getElementById('ebay_category_id')?.value || '');

            // Only append price if it has a value
            const ebayPrice = document.getElementById('ebay_price')?.value;
            if (ebayPrice && ebayPrice !== '') {
                formData.append('ebay_price', ebayPrice);
            }

            formData.append('ebay_payment_policy', document.getElementById('ebay_payment_policy')?.value || '');
            formData.append('ebay_return_policy', document.getElementById('ebay_return_policy')?.value || '');
            formData.append('ebay_shipping_policy', document.getElementById('ebay_shipping_policy')?.value || '');
            formData.append('ebay_location', document.getElementById('ebay_location')?.value || '');
            formData.append('ebay_country', document.getElementById('ebay_country')?.value || 'GB');
            formData.append('ebay_postal_code', document.getElementById('ebay_postal_code')?.value || '');

            // Reverb fields
            const reverbPrice = document.getElementById('reverb_price')?.value;
            if (reverbPrice && reverbPrice !== '') {
                formData.append('reverb_price', reverbPrice);
            }

            formData.append('reverb_product_type', document.getElementById('reverb_product_type')?.value || '');

            // For the legacy field, send UUID if available, otherwise send category name
            const reverbUuid = document.getElementById('reverb_category_uuid')?.value;
            const reverbCategoryName = document.getElementById('reverb_primary_category')?.value;
            console.log('Legacy form - UUID:', reverbUuid, 'Category Name:', reverbCategoryName);
            formData.append('reverb_primary_category', reverbUuid || reverbCategoryName || '');

            formData.append('shipping_profile', document.getElementById('shipping_profile')?.value || '');

            // V&R fields
            const vrCategory = document.getElementById('vr_category')?.value || '';
            if (vrCategory) {
                const vrParts = vrCategory.split('/');
                formData.append('vr_category_id', vrParts[0] || '');
                if (vrParts[1]) formData.append('vr_subcategory_id', vrParts[1]);
                if (vrParts[2]) formData.append('vr_sub_subcategory_id', vrParts[2]);
                if (vrParts[3]) formData.append('vr_sub_sub_subcategory_id', vrParts[3]);
            }

            const vrPrice = document.getElementById('vr_price')?.value;
            if (vrPrice && vrPrice !== '') {
                formData.append('vr_price', vrPrice);
            }

            // Shopify fields
            const shopifyCategory = document.getElementById('shopify_category');
            formData.append('shopify_category_gid', shopifyCategory?.value || '');

            const shopifyPrice = document.getElementById('shopify_price')?.value;
            if (shopifyPrice && shopifyPrice !== '') {
                formData.append('shopify_price', shopifyPrice);
            }

            // Extract product type from category option
            if (shopifyCategory && shopifyCategory.selectedOptions[0]) {
                const fullText = shopifyCategory.selectedOptions[0].text;
                const productType = fullText.replace(/\s*\(gid:.*\)$/, '').trim();
                formData.append('shopify_product_type', productType);
            }

            // Get SEO keywords directly
            const seoKeywordsElement = document.getElementById('shopify_seo_keywords');
            console.log('SEO keywords element:', seoKeywordsElement);
            const seoKeywords = seoKeywordsElement?.value || '';
            console.log('Shopify SEO keywords value:', seoKeywords);
            formData.append('shopify_seo_keywords', seoKeywords);

            // Debug: Check all form data entries
            console.log('All FormData entries:');
            for (let [key, value] of formData.entries()) {
                if (key.includes('shopify') || key.includes('seo')) {
                    console.log(`${key}: ${value}`);
                }
            }

            // Add selected images - handle both file uploads and URLs
            console.log('Processing selectedImages for draft:', selectedImages.length, 'images');

            // Separate file and URL images
            const fileImages = selectedImages.filter(img => img.source === 'file' && img.file);
            const urlImages = selectedImages.filter(img => img.source !== 'file');

            console.log(`Found ${fileImages.length} file images and ${urlImages.length} URL images`);

            // Process file uploads - these will be uploaded to server
            if (fileImages.length > 0) {
                if (fileImages[0]) {
                    console.log(`Preparing primary image file: ${fileImages[0].name}`);
                }
                if (fileImages.length > 1) {
                    fileImages.slice(1).forEach(img => {
                        if (img?.name) {
                            console.log(`Preparing additional image file: ${img.name}`);
                        }
                    });
                }

                await appendImageFilesToFormData(formData, fileImages);
            }

            // Process URL images (Dropbox, external URLs)
            if (urlImages.length > 0) {
                // If no file primary, use first URL as primary
                if (!fileImages.length && urlImages[0]) {
                    formData.append('primary_image_url', urlImages[0].url);
                    console.log('Added primary image URL:', urlImages[0].url);
                }

                // Additional URL images
                const additionalUrls = fileImages.length > 0
                    ? urlImages.map(img => img.url)  // All URLs are additional if we have file primary
                    : urlImages.slice(1).map(img => img.url);  // Skip first URL if it's primary

                if (additionalUrls.length > 0) {
                    formData.append('additional_images_urls', JSON.stringify(additionalUrls));
                    console.log('Added additional image URLs:', additionalUrls.length);
                }
            }

            // Final size check and cleanup
            let finalSize = 0;
            const finalFields = [];
            for (let [key, value] of formData.entries()) {
                let size = 0;
                if (value instanceof File) {
                    // Include file size in total
                    size = value.size;
                    console.log(`File field ${key}: ${value.name} (${(size / 1024).toFixed(2)}KB)`);
                } else {
                    size = new Blob([value]).size;
                }
                finalSize += size;
                finalFields.push({ key, size });
            }

            console.log(`FINAL FormData size: ${(finalSize / 1024).toFixed(2)}KB`);
            if (finalSize > 900000) { // 900KB warning threshold
                console.error('FormData is too large! Fields by size:',
                    finalFields.sort((a, b) => b.size - a.size).slice(0, 5));
            }

            // Final check: Make sure description is still there
            const finalDescription = formData.get('description');
            console.log('FINAL description check:', {
                exists: formData.has('description'),
                value: finalDescription ? finalDescription.substring(0, 100) + '...' : 'null',
                length: finalDescription ? finalDescription.length : 0
            });

            // Add draft ID if updating existing draft
            if (form.dataset.draftId) {
                formData.append('draft_id', form.dataset.draftId);
            }

            // Show loading state
            saveDraftBtn.disabled = true;
            saveDraftBtn.textContent = 'Saving Draft...';

            try {
                const response = await fetch('/inventory/save-draft', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Save draft error response:', errorText);
                    throw new Error(`Server error: ${response.status}`);
                }

                const result = await response.json();

                if (result.status === 'success') {
                    // Show success message
                    const notification = document.createElement('div');
                    notification.className = 'fixed bottom-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50';
                    notification.innerHTML = `
                        <span class="block sm:inline">${result.message}</span>
                    `;
                    document.body.appendChild(notification);

                    // Remove notification after 3 seconds
                    setTimeout(() => {
                        notification.remove();
                        // Redirect to inventory page
                        window.location.href = result.redirect_url;
                    }, 2000);
                } else {
                    alert('Error saving draft: ' + result.message);
                }
            } catch (error) {
                console.error('Error saving draft:', error);
                alert('Error saving draft. Check console for details.');
            } finally {
                // Reset button state
                saveDraftBtn.disabled = false;
                saveDraftBtn.textContent = 'Save as Draft';
            }
        });
    }


    // =========== DROPBOX INTEGRATION ===========
    // Tab switching functionality for image upload methods
    const tabs = ['upload', 'url', 'dropbox'];
    currentPath = '';
    tabs.forEach(tab => {
        const tabButton = document.getElementById(`tab-${tab}`);
        if (tabButton) {
            tabButton.addEventListener('click', function() {
                // Hide all content panels
                tabs.forEach(t => {
                    const contentEl = document.getElementById(`content-${t}`);
                    if (contentEl) {
                        contentEl.classList.add('hidden');
                    }
                    const tabEl = document.getElementById(`tab-${t}`);
                    if (tabEl) {
                        tabEl.classList.remove('bg-blue-50', 'border-blue-500', 'text-blue-600');
                    }
                });
                
                // Show the selected content panel
                const contentEl = document.getElementById(`content-${tab}`);
                if (contentEl) {
                    contentEl.classList.remove('hidden');
                }
                tabButton.classList.add('bg-blue-50', 'border-blue-500', 'text-blue-600');
                
                // Don't auto-load when switching tabs
            });
        }
    });
    
    // Dropbox functionality
    let navigationHistory = [];
    let selectedImages = [];

    async function appendImageFilesToFormData(formData, fileImages) {
        if (!fileImages || fileImages.length === 0) {
            return;
        }

        // Remove any stale file inputs so we only send the cloned blobs
        formData.delete('primary_image_file');
        formData.delete('additional_images_files');
        formData.delete('image_files');

        const clonedFiles = await Promise.all(
            fileImages.map(async (image) => {
                try {
                    const buffer = await image.file.arrayBuffer();
                    const fileName = image.file.name || 'image.jpg';
                    const fileType = image.file.type || 'application/octet-stream';
                    const lastModified = image.file.lastModified || Date.now();
                    return new File([buffer], fileName, { type: fileType, lastModified });
                } catch (error) {
                    console.error('Failed to clone image before upload', image, error);
                    throw error;
                }
            })
        );

        const [primaryFile, ...additionalFiles] = clonedFiles;
        if (primaryFile) {
            formData.append('primary_image_file', primaryFile);
        }

        additionalFiles.forEach((file) => {
            formData.append('additional_images_files', file);
        });
    }
    
    const dropboxElements = {
        browser: document.getElementById('dropbox-browser'),
        items: document.getElementById('dropbox-items'),
        loading: document.getElementById('dropbox-loading'),
        empty: document.getElementById('dropbox-empty'),
        error: document.getElementById('dropbox-error'),
        currentPath: document.getElementById('dropbox-current-path'),
        backButton: document.getElementById('dropbox-back'),
        refreshButton: document.getElementById('dropbox-refresh'),
        selectedImages: document.getElementById('dropbox-selected-images'),
        noSelection: document.getElementById('dropbox-no-selection'),
        primaryImage: document.getElementById('dropbox-primary-image'),
        additionalImages: document.getElementById('dropbox-additional-images')
    };
    
    // Initialize dropbox elements
    if (dropboxElements.backButton) {
        dropboxElements.backButton.addEventListener('click', function() {
            if (navigationHistory.length > 0) {
                currentPath = navigationHistory.pop();
                loadDropboxFolders(currentPath);
                dropboxElements.backButton.disabled = navigationHistory.length === 0;
            }
        });
    }
    
    if (dropboxElements.refreshButton) {
        dropboxElements.refreshButton.addEventListener('click', function() {
            loadDropboxFolders(currentPath);
        });
    }

    // Manual Dropbox sync button
    const dropboxSyncButton = document.getElementById('dropbox-sync-now');
    if (dropboxSyncButton) {
        dropboxSyncButton.addEventListener('click', async function() {
            const originalContent = this.innerHTML;
            
            // Show syncing state
            this.disabled = true;
            this.innerHTML = `
                <svg class="animate-spin h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Syncing...
            `;
            
            try {
                const response = await fetch('/inventory/api/dropbox/sync-now', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Sync response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Sync result:', result);
                
                if (result.status === 'success' || result.status === 'started') {
                    // Show success state briefly
                    const message = result.status === 'started' ? 'Sync Started!' : 'Synced!';
                    this.innerHTML = `
                        <svg class="h-3 w-3 mr-1 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        ${message}
                    `;
                    
                    // Reload the current folder to show new images after a delay
                    // For background sync, wait a bit longer before refreshing
                    const delay = result.status === 'started' ? 5000 : 2000;
                    setTimeout(() => {
                        loadDropboxFolders(currentPath);
                        this.innerHTML = originalContent;
                        this.disabled = false;
                    }, delay);
                    
                } else if (result.status === 'already_running') {
                    // Show already running message
                    this.innerHTML = `
                        <svg class="h-3 w-3 mr-1 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        Already syncing...
                    `;
                    setTimeout(() => {
                        this.innerHTML = originalContent;
                        this.disabled = false;
                    }, 3000);
                    
                } else if (result.status === 'too_soon') {
                    // Show too soon message
                    this.innerHTML = `
                        <svg class="h-3 w-3 mr-1 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                        </svg>
                        Wait a moment...
                    `;
                    setTimeout(() => {
                        this.innerHTML = originalContent;
                        this.disabled = false;
                    }, 3000);
                    
                } else {
                    // Show error
                    this.innerHTML = `
                        <svg class="h-3 w-3 mr-1 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                        Error
                    `;
                    console.error('Sync error:', result.message);
                    setTimeout(() => {
                        this.innerHTML = originalContent;
                        this.disabled = false;
                    }, 3000);
                }
                
            } catch (error) {
                console.error('Error syncing Dropbox:', error);
                console.error('Error details:', error.message);
                
                // Try to get more info about the error
                let errorMessage = 'Error';
                if (error.message.includes('404')) {
                    errorMessage = 'Not Found';
                } else if (error.message.includes('500')) {
                    errorMessage = 'Server Error';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Network Error';
                }
                
                this.innerHTML = `
                    <svg class="h-3 w-3 mr-1 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                    ${errorMessage}
                `;
                setTimeout(() => {
                    this.innerHTML = originalContent;
                    this.disabled = false;
                }, 3000);
            }
        });
    }

    // ADD THE CODE HERE - after the refreshButton event listener
    // Initialize the regenerate links button
    if (document.getElementById('regenerate-links-button')) {
        document.getElementById('regenerate-links-button').addEventListener('click', function() {
            console.log("Regenerate links button clicked for path:", currentPath);
            if (currentPath) {
                generateFolderLinks(currentPath);
            } else {
                console.log("No current path available");
                if (dropboxElements.error) {
                    dropboxElements.error.textContent = 'Please navigate to a folder first';
                    dropboxElements.error.classList.remove('hidden');
                }
            }
        });
    }
    
    // Function to load Dropbox folders
    function loadDropboxFolders(path = '') {
        // Update current path (make sure this line exists)
        currentPath = path;
        
        // Mark that Dropbox has been loaded
        window.dropboxLoaded = true;
        
        // Hide initial state if showing
        const initialEl = document.getElementById('dropbox-initial');
        if (initialEl) initialEl.classList.add('hidden');
        
        // Show loading state
        dropboxElements.items.classList.add('hidden');
        if (dropboxElements.empty) dropboxElements.empty.classList.add('hidden');
        if (dropboxElements.error) dropboxElements.error.classList.add('hidden');
        dropboxElements.loading.classList.remove('hidden');
        
        // Update loading with a helpful message
        dropboxElements.loading.innerHTML = `
            <svg class="animate-spin h-6 w-6 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-sm font-medium">Loading Dropbox folders...</p>
        `;
    
        // Update current path display
        if (dropboxElements.currentPath) {
            dropboxElements.currentPath.textContent = path || '/';
        }
    
        // Make API request
        fetch(`/inventory/api/dropbox/folders?path=${encodeURIComponent(path)}`)
            .then(async response => {
                let data = {};
                try {
                    data = await response.json();
                } catch (jsonError) {
                    console.warn('Unable to parse Dropbox folders response as JSON', jsonError);
                }
                return {
                    status: response.status,
                    ok: response.ok,
                    data
                };
            })
            .then(({ status, ok, data }) => {
                if (status === 202) {
                    console.log("Received 202 status - operation in progress", data);

                    dropboxElements.loading.innerHTML = `
                        <svg class="animate-spin h-6 w-6 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="text-sm font-medium">${data?.message || 'Processing Dropbox request...'}</p>
                        <p class="text-xs text-gray-500 mt-1">Please wait, this may take a moment...</p>
                        <button id="dropbox-retry" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            Check Again
                        </button>
                    `;

                    const retryButton = document.getElementById('dropbox-retry');
                    if (retryButton) {
                        retryButton.addEventListener('click', function() {
                            loadDropboxFolders(path);
                        });
                    }

                    return;
                }

                if (!ok && status !== 503) {
                    throw new Error(`HTTP error! Status: ${status}`);
                }

                dropboxElements.loading.classList.add('hidden');

                if (!ok && status === 503) {
                    if (dropboxElements.error) {
                        dropboxElements.error.textContent = data?.message || 'Dropbox credentials are not configured.';
                        dropboxElements.error.classList.remove('hidden');
                    }
                    return;
                }

                if (data.error) {
                    if (dropboxElements.error) {
                        dropboxElements.error.textContent = data.error;
                        dropboxElements.error.classList.remove('hidden');
                    }
                    return;
                }

                console.log("Dropbox folder data:", data);

                // Clear items container
                dropboxElements.items.innerHTML = '';
    
                // Handle folder list
                const folders = data.folders || data.items || [];
                if (folders.length > 0) {
                    // Display folders
                    folders.forEach(folder => {
                        if (!folder.is_folder && !/\.(jpe?g|png|gif)$/i.test(folder.name)) {
                            return; // Skip non-image files
                        }
                        
                        const itemElement = document.createElement('div');
                        
                        if (!folder.is_folder && folder.is_folder !== false) {
                            folder.is_folder = true; // Default to folder for backward compatibility
                        }
                        
                        if (folder.is_folder) {
                            // Render folder as square tile
                            itemElement.className = 'aspect-square border rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-gray-50 hover:shadow-md transition-all bg-gray-50';
                            itemElement.innerHTML = `
                                <svg class="h-8 w-8 mb-1 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                                </svg>
                                <span class="text-xs text-center px-1 font-medium">${folder.name}</span>
                            `;
                            
                            itemElement.addEventListener('click', function() {
                                navigationHistory.push(currentPath);
                                currentPath = folder.path;
                                loadDropboxFolders(folder.path);
                                if (dropboxElements.backButton) {
                                    dropboxElements.backButton.disabled = false;
                                }
                            });
                        } else {
                            // Render image file - JUST THE IMAGE, BIG
                            itemElement.className = 'cursor-pointer hover:opacity-80 transition-opacity';
                            itemElement.style = 'padding: 0; margin: 0; border: none;';
                            
                            // If we have a temp link, show thumbnail
                            if (folder.temp_link) {
                                itemElement.innerHTML = `
                                    <img src="${folder.temp_link}" alt="${folder.name}" style="width: 100%; height: 200px; object-fit: cover; display: block; margin: 0; padding: 0;">
                                `;
                                
                                // Add click handler to select image
                                itemElement.addEventListener('click', function() {
                                    const imageData = {
                                        url: folder.temp_link,
                                        name: folder.name,
                                        path: folder.path
                                    };
                                    
                                    toggleImageSelection(imageData);
                                });
                            } else {
                                itemElement.innerHTML = `
                                    <div class="relative aspect-square flex items-center justify-center bg-gray-100">
                                        <svg class="h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white p-1">
                                        <p class="text-xs truncate">${folder.name}</p>
                                    </div>
                                `;
                                
                                // Add click handler to load images
                                itemElement.addEventListener('click', function() {
                                    // Load images from the current folder
                                    loadDropboxImages(folder.path);
                                });
                            }
                        }
                        
                        dropboxElements.items.appendChild(itemElement);
                    });
                    
                    dropboxElements.items.classList.remove('hidden');
                } else {
                    // Show empty state
                    if (dropboxElements.empty) {
                        dropboxElements.empty.classList.remove('hidden');
                    }
                    
                    // No folders found, try to load images instead
                    console.log("No folders found, trying to load images for path:", path);
                    
                    // Check if it might be an image folder and try to load images
                    loadDropboxImages(path);
                }
            })
            .catch(error => {
                if (error && error.message === 'PENDING') {
                    return;
                }

                console.error('Error loading Dropbox folders:', error);
                dropboxElements.loading.classList.add('hidden');
                if (dropboxElements.error) {
                    dropboxElements.error.textContent = 'Error loading Dropbox content';
                    dropboxElements.error.classList.remove('hidden');
                }
            });
    }

    
    // Function to load Dropbox images from a folder
    function loadDropboxImages(folderPath) {
        if (!dropboxElements.items || !dropboxElements.loading) {
            console.error('Dropbox UI elements not found');
            return;
        }
        
        console.log(`Loading Dropbox images from folder: ${folderPath}`);
        
        // Show loading state
        dropboxElements.items.classList.add('hidden');
        if (dropboxElements.empty) dropboxElements.empty.classList.add('hidden');
        if (dropboxElements.error) dropboxElements.error.classList.add('hidden');
        dropboxElements.loading.classList.remove('hidden');
        
        dropboxElements.loading.innerHTML = `
            <svg class="animate-spin h-6 w-6 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-sm font-medium">Loading images from folder...</p>
        `;
        
        // Make API request to get images
        fetch(`/inventory/api/dropbox/images?folder_path=${encodeURIComponent(folderPath)}`)
            .then(response => response.json())
            .then(data => {
                console.log(`Received ${data.images ? data.images.length : 0} images from folder ${folderPath}`);
                
                if (data.images && data.images.length > 0) {
                    // We have images, display them
                    dropboxElements.loading.classList.add('hidden');
                    displayImages(data.images);
                } else {
                    // No images found, try generating the links automatically
                    console.log("No images found, generating links automatically");
                    dropboxElements.loading.innerHTML = `
                        <svg class="animate-spin h-6 w-6 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="text-sm font-medium">Generating thumbnails automatically...</p>
                    `;
                    
                    // Generate links automatically
                    fetch(`/inventory/api/dropbox/generate-links?folder_path=${encodeURIComponent(folderPath)}`)
                        .then(response => response.json())
                        .then(linkData => {
                            dropboxElements.loading.classList.add('hidden');
                            
                            if (linkData.status === 'success' && linkData.images && linkData.images.length > 0) {
                                // Display the newly generated images
                                displayImages(linkData.images);
                            } else {
                                // Still no images, show empty state
                                if (dropboxElements.empty) {
                                    dropboxElements.empty.textContent = 'No images found in this folder';
                                    dropboxElements.empty.classList.remove('hidden');
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error generating links:', error);
                            dropboxElements.loading.classList.add('hidden');
                            if (dropboxElements.error) {
                                dropboxElements.error.textContent = 'Error generating thumbnails';
                                dropboxElements.error.classList.remove('hidden');
                            }
                        });
                }
            })
            .catch(error => {
                console.error('Error loading Dropbox images:', error);
                dropboxElements.loading.classList.add('hidden');
                if (dropboxElements.error) {
                    dropboxElements.error.textContent = 'Error loading images';
                    dropboxElements.error.classList.remove('hidden');
                }
            });
    }


    // Function to generate temporary links for the current folder
    function generateFolderLinks(folderPath) {
        console.log("Generating temporary links for folder:", folderPath);
        console.log("generateFolderLinks called with path:", folderPath);
        
        // Show loading state
        dropboxElements.loading.classList.remove('hidden');
        dropboxElements.items.classList.add('hidden');
        if (dropboxElements.empty) dropboxElements.empty.classList.add('hidden');
        if (dropboxElements.error) dropboxElements.error.classList.add('hidden');
        
        dropboxElements.loading.innerHTML = `
            <svg class="animate-spin h-6 w-6 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-sm font-medium">Generating temporary links for folder...</p>
        `;
        
        // Make API request
        fetch(`/inventory/api/dropbox/generate-links?folder_path=${encodeURIComponent(folderPath)}`)
            .then(response => response.json())
            .then(data => {
                console.log("Generate links API response:", data);
                
                // Hide loading state
                dropboxElements.loading.classList.add('hidden');
                
                if (data.status === 'success') {
                    // Refresh the view to show the new links
                    if (data.images && data.images.length > 0) {
                        // Update the UI directly with the returned images
                        displayImages(data.images);
                    } else {
                        // If no images returned but operation was successful, reload the folder
                        loadDropboxImages(folderPath);
                    }
                } else {
                    // Show error message
                    if (dropboxElements.error) {
                        dropboxElements.error.textContent = data.message || 'Error generating links';
                        dropboxElements.error.classList.remove('hidden');
                    }
                }
            })
            .catch(error => {
                console.error('Error generating links:', error);
                dropboxElements.loading.classList.add('hidden');
                if (dropboxElements.error) {
                    dropboxElements.error.textContent = 'Error generating temporary links';
                    dropboxElements.error.classList.remove('hidden');
                }
            });
    }

    function displayImages(images) {
        console.log("Displaying images:", images.length);
        // Clear items container and ensure it uses full width
        dropboxElements.items.innerHTML = '';
        dropboxElements.items.style.cssText = 'width: 100% !important; max-width: 100% !important;';
        dropboxElements.items.classList.remove('grid'); // Remove any leftover grid class
        
        if (images.length > 0) {
            // Show Select All button and update its text
            const selectAllButton = document.getElementById('select-all-images');
            if (selectAllButton) {
                selectAllButton.classList.remove('hidden');
                selectAllButton.textContent = `Select All Images (${images.length})`;
                
                // Remove any existing event listeners and replace with new one
                selectAllButton.replaceWith(selectAllButton.cloneNode(true));
                
                // Get the fresh reference and add event listener
                document.getElementById('select-all-images').addEventListener('click', function() {
                    // Add all currently displayed images to selection
                    images.forEach(image => {
                        // Only add if not already selected
                        if (!selectedImages.some(selected => selected.url === image.url)) {
                            selectedImages.push(image);
                        }
                    });
                    
                    // Update the image preview directly
                    updateImagePreview();
                    updateHiddenInputs();
                    updateImageCount();
                    
                    // Show a confirmation message
                    const notification = document.createElement('div');
                    notification.className = 'fixed bottom-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50';
                    notification.innerHTML = `
                        <span class="block sm:inline">${images.length} images selected</span>
                    `;
                    document.body.appendChild(notification);
                    
                    // Remove the notification after 3 seconds
                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                });
            }
            
            // PINTEREST STYLE - NATURAL ASPECT RATIO
            const imageGrid = document.createElement('div');
            imageGrid.className = 'grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 w-full auto-rows-auto';
            imageGrid.style = 'width: 100%;';
            dropboxElements.items.appendChild(imageGrid);
            
            // Make sure the items container uses full width
            dropboxElements.items.style.width = '100%';
            
            // Add images to the grid - NATURAL ASPECT RATIO
            images.forEach(image => {
                // Check if image is already selected (for visual feedback)
                const isSelected = selectedImages.some(selected => selected.url === image.url);
                
                const imageItem = document.createElement('div');
                imageItem.className = `cursor-pointer hover:opacity-80 relative ${isSelected ? 'ring-2 ring-green-500' : ''}`;
                imageItem.dataset.imageUrl = image.full_url || image.url;  // Store full URL for selection
                imageItem.style = 'padding: 0; margin: 0; border: none; position: relative;';

                imageItem.innerHTML = `
                    <img src="${image.thumbnail_url || image.url}" alt="${image.name}"
                         style="width: 100%; height: auto; display: block;">
                    ${isSelected ? `
                    <div style="position: absolute; top: 4px; right: 4px;">
                        <span style="background: green; color: white; border-radius: 50%; padding: 2px; display: flex; align-items: center; justify-content: center; width: 24px; height: 24px;">
                            <svg xmlns="http://www.w3.org/2000/svg" style="width: 16px; height: 16px;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </span>
                    </div>
                    ` : ''}
                `;
                
                // Add click handler to select image
                imageItem.addEventListener('click', function() {
                    toggleImageSelection(image);
                    
                    // Update visual selection state immediately
                    const isNowSelected = selectedImages.some(selected => selected.url === image.url);
                    if (isNowSelected) {
                        this.classList.add('ring-2', 'ring-green-500');
                        if (!this.querySelector('.absolute.top-2.right-2')) {
                            const checkmark = document.createElement('div');
                            checkmark.className = 'absolute top-2 right-2';
                            checkmark.innerHTML = `
                                <span class="bg-green-500 text-white rounded-full p-1 flex items-center justify-center w-6 h-6">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                </span>
                            `;
                            this.appendChild(checkmark);
                        }
                    } else {
                        this.classList.remove('ring-2', 'ring-green-500');
                        const checkmark = this.querySelector('.absolute.top-2.right-2');
                        if (checkmark) checkmark.remove();
                    }
                });
                
                imageGrid.appendChild(imageItem);
            });
            
            dropboxElements.items.classList.remove('hidden');
        } else {
            // Hide the Select All button
            const selectAllButton = document.getElementById('select-all-images');
            if (selectAllButton) {
                selectAllButton.classList.add('hidden');
            }
            
            // Show empty state
            if (dropboxElements.empty) {
                dropboxElements.empty.textContent = 'No images found in this folder';
                dropboxElements.empty.classList.remove('hidden');
            }
        }
    }


    function updatePositionLabels() {
        const imagePreview = document.getElementById('imagePreview');
        if (!imagePreview) return;
        
        const items = imagePreview.querySelectorAll('[data-index]');
        items.forEach((item, index) => {
            const label = item.querySelector('.position-label');
            if (label) {
                label.textContent = index === 0 ? 'Primary' : `Additional ${index}`;
            }
            
            // Update the ring for primary image
            const img = item.querySelector('img');
            if (img) {
                if (index === 0) {
                    img.classList.add('ring-2', 'ring-blue-500');
                } else {
                    img.classList.remove('ring-2', 'ring-blue-500');
                }
            }
        });
    }
    
    function updateImageCount() {
        // Update section header count
        const countElement = document.getElementById('images-count');
        if (countElement) {
            if (selectedImages.length > 0) {
                countElement.textContent = `(${selectedImages.length})`;
            } else {
                countElement.textContent = '';
            }
        }

        // Update the image count badge
        const imageCountBadge = document.getElementById('imageCount');
        if (imageCountBadge) {
            imageCountBadge.textContent = `${selectedImages.length} image${selectedImages.length !== 1 ? 's' : ''}`;
        }

        // Update file count next to Upload Images label
        const fileCountElement = document.getElementById('file-count');
        if (fileCountElement) {
            const fileImages = selectedImages.filter(img => img.source === 'file' || (img.source === 'url' && img.url.startsWith('data:')));
            if (fileImages.length > 0) {
                fileCountElement.textContent = `(${fileImages.length} file${fileImages.length > 1 ? 's' : ''} selected)`;
            } else {
                fileCountElement.textContent = '';
            }
        }

        // Hide/show the placeholder
        const placeholder = document.getElementById('noImagesPlaceholder');
        if (placeholder) {
            if (selectedImages.length > 0) {
                placeholder.style.display = 'none';
            } else {
                placeholder.style.display = 'flex';
            }
        }
    }
    
    function toggleImageSelection(image) {
        console.log('Toggling image selection:', image);
        // Use full URL for selection
        const fullUrl = image.full_url || image.url;
        const existingIndex = selectedImages.findIndex(img => (img.full_url || img.url) === fullUrl);

        if (existingIndex >= 0) {
            // Remove from selection
            selectedImages.splice(existingIndex, 1);
            console.log('Removed image, now have', selectedImages.length);
        } else {
            // Add to selection with full URL
            selectedImages.push({
                ...image,
                url: fullUrl,  // Ensure URL is the full resolution
                source: 'dropbox'
            });
            console.log('Added image, now have', selectedImages.length);
        }
        
        // Update the main image preview
        updateImagePreview();
        
        // Update hidden inputs
        updateHiddenInputs();
        
        // Update image count in section header
        updateImageCount();
    }

   
    function updateHiddenInputs() {
        // Separate images by source
        const urlImages = selectedImages.filter(img => img.source === 'url' || img.source === 'dropbox');
        const fileImages = selectedImages.filter(img => img.source === 'file');

        // Update URL inputs - only for URL/Dropbox images
        const primaryImageInput = document.getElementById('primary-image-input');
        const additionalImagesInput = document.getElementById('additional-images-input');

        // Find first URL image for primary
        const firstUrlImage = urlImages[0];
        if (primaryImageInput) {
            primaryImageInput.value = firstUrlImage ? firstUrlImage.url : '';
        }

        // Remaining URL images for additional
        if (additionalImagesInput) {
            const additionalUrls = urlImages.slice(1).map(img => img.url).join('\n');
            additionalImagesInput.value = additionalUrls;
        }

        // File images will be handled by the file inputs directly
        // They should NOT go in the URL fields
    }
    
    // Declare a variable to store the sortable instance
    let dropboxSortableInstance = null;
    

    function updateSelectedImagesDisplay() {
        if (!dropboxElements.selectedImages || !dropboxElements.noSelection) {
            console.error('Dropbox selection elements not found');
            return;
        }
        
        // Destroy the existing sortable instance if it exists
        if (dropboxSortableInstance) {
            dropboxSortableInstance.destroy();
            dropboxSortableInstance = null;
        }
        
        // Clear existing content except the "no selection" message
        const children = Array.from(dropboxElements.selectedImages.children);
        children.forEach(child => {
            if (child !== dropboxElements.noSelection) {
                child.remove();
            }
        });
        
        if (selectedImages.length > 0) {
            // Hide the "no selection" message
            dropboxElements.noSelection.classList.add('hidden');
            
            // Create a container for the image grid
            const imageGrid = document.createElement('div');
            imageGrid.id = "sortable-dropbox-images";
            imageGrid.className = "grid grid-cols-2 md:grid-cols-4 gap-2 w-full";
            dropboxElements.selectedImages.appendChild(imageGrid);
            
            // Display selected images
            selectedImages.forEach((image, index) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'relative border rounded overflow-hidden group';
                imageItem.dataset.index = index; // Store the index for sorting
                imageItem.style.height = '150px'; // Set explicit height
                
                // First image is primary
                const isPrimary = index === 0;
                const borderClass = isPrimary ? 'border-blue-500 ring-2 ring-blue-300' : 'border-gray-300';
                
                imageItem.innerHTML = `
                    <div class="aspect-w-1 aspect-h-1 ${borderClass}">
                        <img src="${image.url}" alt="${image.name || 'Image'}" class="object-cover w-full h-full">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 flex items-center justify-center">
                            <button type="button" class="remove-btn hidden group-hover:block bg-red-500 text-white rounded-full p-1">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white p-1 flex justify-between items-center">
                        <span class="text-xs truncate">${isPrimary ? 'Primary' : `Additional ${index}`}</span>
                    </div>
                `;
                
                // Add remove button functionality
                const removeBtn = imageItem.querySelector('.remove-btn');
                removeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectedImages.splice(index, 1); // Remove this image
                    updateSelectedImagesDisplay(); // Refresh the display
                });
                
                imageGrid.appendChild(imageItem);
            });
            
            // Update hidden inputs for form submission
            if (selectedImages.length > 0) {
                // Update primary image input
                const primaryImageInput = document.getElementById('primary-image-input');
                if (primaryImageInput) {
                    primaryImageInput.value = selectedImages[0].url;
                }
                
                // Update additional images input
                const additionalImagesInput = document.getElementById('additional-images-input');
                if (additionalImagesInput && selectedImages.length > 1) {
                    const additionalUrls = selectedImages.slice(1).map(img => img.url).join('\n');
                    additionalImagesInput.value = additionalUrls;
                } else if (additionalImagesInput) {
                    additionalImagesInput.value = '';
                }
            }
            
            // Initialize Sortable on the grid container
            const sortableContainer = document.getElementById('sortable-dropbox-images');
            if (sortableContainer) {
                dropboxSortableInstance = new Sortable(sortableContainer, {
                    animation: 150,
                    ghostClass: 'bg-blue-100',
                    handle: '.aspect-w-1', // Use the image container as handle
                    filter: '.remove-btn', // Prevent dragging when clicking remove button
                    onEnd: function() {
                        // Get the new order of images
                        const newOrder = [];
                        const items = sortableContainer.querySelectorAll('[data-index]');
                        
                        // Build new array based on the DOM order
                        items.forEach(item => {
                            const oldIndex = parseInt(item.dataset.index);
                            if (!isNaN(oldIndex) && oldIndex >= 0 && oldIndex < selectedImages.length) {
                                newOrder.push(selectedImages[oldIndex]);
                            }
                        });
                        
                        // Only update if we have the right number of items
                        if (newOrder.length === selectedImages.length) {
                            selectedImages = newOrder;
                            
                            // Update the hidden inputs without rebuilding UI
                            if (selectedImages.length > 0) {
                                // Update primary image input
                                const primaryImageInput = document.getElementById('primary-image-input');
                                if (primaryImageInput) {
                                    primaryImageInput.value = selectedImages[0].url;
                                }
                                
                                // Update additional images input
                                const additionalImagesInput = document.getElementById('additional-images-input');
                                if (additionalImagesInput && selectedImages.length > 1) {
                                    const additionalUrls = selectedImages.slice(1).map(img => img.url).join('\n');
                                    additionalImagesInput.value = additionalUrls;
                                }
                                
                                // Update visual indicators (primary vs additional)
                                const imageItems = sortableContainer.querySelectorAll('[data-index]');
                                imageItems.forEach((item, idx) => {
                                    // Update data-index attributes
                                    item.dataset.index = idx;
                                    
                                    // Update primary/additional status
                                    const isPrimary = idx === 0;
                                    const imageContainer = item.querySelector('.aspect-w-1');
                                    if (imageContainer) {
                                        if (isPrimary) {
                                            imageContainer.classList.add('border-blue-500', 'ring-2', 'ring-blue-300');
                                            imageContainer.classList.remove('border-gray-300');
                                        } else {
                                            imageContainer.classList.remove('border-blue-500', 'ring-2', 'ring-blue-300');
                                            imageContainer.classList.add('border-gray-300');
                                        }
                                    }
                                    
                                    // Update status text
                                    const statusText = item.querySelector('.absolute.bottom-0 span');
                                    if (statusText) {
                                        statusText.textContent = isPrimary ? 'Primary' : `Additional ${idx}`;
                                    }
                                });
                            }
                        }
                    }
                });
            }
        } else {
            // No selected images, show the message
            dropboxElements.noSelection.classList.remove('hidden');
            
            // Clear hidden inputs
            const primaryImageInput = document.getElementById('primary-image-input');
            if (primaryImageInput) primaryImageInput.value = '';
            
            const additionalImagesInput = document.getElementById('additional-images-input');
            if (additionalImagesInput) additionalImagesInput.value = '';
        }
    }

    // New helper function to update the visual state in the Dropbox browser
    function updateDropboxBrowserSelectionState() {
        // Only run if we're actually in the Dropbox tab
        const dropboxItems = document.getElementById('dropbox-items');
        if (!dropboxItems || dropboxItems.classList.contains('hidden')) {
            return; // Don't update if Dropbox browser isn't visible
        }
        
        // Get all the image items in the Dropbox browser
        const dropboxImages = document.querySelectorAll('#dropbox-items [data-image-url]');
        
        dropboxImages.forEach(imageItem => {
            const imageUrl = imageItem.dataset.imageUrl;
            const isSelected = selectedImages.some(img => img.url === imageUrl);
            
            // Update the visual state
            if (isSelected) {
                imageItem.classList.add('ring-2', 'ring-green-500');
                
                // Add checkmark if it doesn't exist and item is positioned relative
                if (!imageItem.querySelector('[style*="position: absolute"]')) {
                    const checkmark = document.createElement('div');
                    checkmark.style = 'position: absolute; top: 4px; right: 4px;';
                    checkmark.innerHTML = `
                        <span style="background: green; color: white; border-radius: 50%; padding: 2px; display: flex; align-items: center; justify-content: center; width: 24px; height: 24px;">
                            <svg xmlns="http://www.w3.org/2000/svg" style="width: 16px; height: 16px;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </span>
                    `;
                    imageItem.appendChild(checkmark);
                }
            } else {
                imageItem.classList.remove('ring-2', 'ring-green-500');
                const checkmark = imageItem.querySelector('[style*="position: absolute"]');
                if (checkmark && checkmark.innerHTML.includes('svg')) {
                    checkmark.remove();
                }
            }
        });
    }

    function updateImagePreview() {
        const imagePreview = document.getElementById('imagePreview');
        if (!imagePreview) {
            console.error('imagePreview element not found');
            return;
        }
        
        console.log('Updating image preview with', selectedImages.length, 'images');
        
        // Clear all existing previews (whether Dropbox or file uploads)
        imagePreview.innerHTML = '';
        
        if (selectedImages.length === 0) {
            // If no images selected, show a placeholder message
            const placeholder = document.createElement('div');
            placeholder.className = 'col-span-full text-center py-6 text-gray-500 border border-dashed rounded-lg';
            placeholder.textContent = 'No images selected. Please upload files, enter URLs, or select from Dropbox.';
            imagePreview.appendChild(placeholder);
            // ADDED: Update the visual state in the Dropbox browser
            updateDropboxBrowserSelectionState();
            return;
        }
        
        // Add all selected images to the preview
        selectedImages.forEach((image, index) => {
            const isPrimary = index === 0;
            const preview = document.createElement('div');
            preview.className = 'relative aspect-square image-preview';
            preview.setAttribute('data-source', image.source || 'url');
            preview.setAttribute('data-index', index);
            
            preview.innerHTML = `
                <img src="${image.url}" 
                    class="w-full h-full object-cover rounded-lg shadow-sm ${isPrimary ? 'ring-2 ring-blue-500' : ''}"
                    alt="${isPrimary ? 'Primary' : 'Additional'} Image">
                <div class="absolute top-1 right-1">
                    <button type="button" class="remove-image bg-red-500 text-white rounded-full p-1 hover:bg-red-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="absolute bottom-1 left-1 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded position-label">
                    ${isPrimary ? 'Primary' : `Additional ${index}`}
                </div>
            `;
            
            // Add event listener to remove button
            preview.querySelector('.remove-image').addEventListener('click', function() {
                // If this is a file source and it's the last file image, clear the file input
                if (image.source === 'file') {
                    const remainingFileImages = selectedImages.filter((img, i) => i !== index && img.source === 'file');
                    if (remainingFileImages.length === 0) {
                        // Clear the file input
                        const fileInput = document.getElementById('imageFiles');
                        if (fileInput) fileInput.value = '';
                    }
                }

                selectedImages.splice(index, 1);
                updateImagePreview();
                updateHiddenInputs();
                updateImageCount();
            });
                
            imagePreview.appendChild(preview);
            console.log('Added preview for image', index, preview);
        });
        
        console.log('Total children in imagePreview:', imagePreview.children.length);
        
        // Update the visual state in Dropbox browser
        updateDropboxBrowserSelectionState();
        
        // Initialize Sortable on the main image preview container
        if (window.Sortable) {
            if (imagePreview._sortable) {
                console.log('[updateImagePreview] Destroying existing Sortable instance #2');
                imagePreview._sortable.destroy();
            }
            
            console.log('[updateImagePreview] Creating Sortable instance #2');
            imagePreview._sortable = new Sortable(imagePreview, {
                animation: 150,
                ghostClass: 'bg-blue-100',
                onStart: function(evt) {
                    console.log('[updateImagePreview] Drag STARTED from instance #2');
                },
                onEnd: function() {
                    console.log('[updateImagePreview] Drag ENDED in instance #2, updating selectedImages');
                    // Get new order from DOM
                    const newOrder = [];
                    const items = imagePreview.querySelectorAll('[data-index]');
                    
                    items.forEach(item => {
                        const oldIndex = parseInt(item.dataset.index);
                        if (!isNaN(oldIndex) && oldIndex >= 0 && oldIndex < selectedImages.length) {
                            newOrder.push(selectedImages[oldIndex]);
                        }
                    });
                    
                    // Only update if we have the right number of items
                    if (newOrder.length === selectedImages.length) {
                        console.log('[updateImagePreview] Updating selectedImages array and calling updateImagePreview recursively');
                        selectedImages = newOrder;
                        updateImagePreview();
                        updateHiddenInputs();
                    } else {
                        console.log('[updateImagePreview] WARNING: newOrder length mismatch');
                    }
                    console.log('[updateImagePreview] Instance #2 onEnd complete');
                }
            });
        }
    }


    function initializeDropboxWithFallback() {
    // Try to load Dropbox folders
    fetch('/inventory/api/dropbox/folders?path=')
        .then(response => {
            if (!response.ok && response.status !== 202) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // If there's an error message, show it
            if (data.error || data.status === 'error') {
                throw new Error(data.message || 'Error loading Dropbox');
            }
        })
        .catch(error => {
            if (error && error.message === 'PENDING') {
                return;
            }
            console.error('Dropbox initialisation error:', error);
        });
}


    // Call this function on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Dropbox with fallback
        initializeDropboxWithFallback();
    });

    // Initialize tabs if they exist
    if (document.getElementById('tab-upload') && !document.getElementById('content-dropbox')) {
        console.warn('Dropbox content tab not found. Make sure to add the HTML.');
    }

    function setupDropboxTabs() {
        const dropboxTab = document.getElementById('tab-dropbox');
        const uploadTab = document.getElementById('tab-upload');
        const urlTab = document.getElementById('tab-url');
    
        // Exit if tabs not found
        if (!uploadTab || !urlTab || !dropboxTab) {
            console.warn('Tab elements not found');
            return;
        }
    
        const contentUpload = document.getElementById('content-upload');
        const contentUrl = document.getElementById('content-url');
        const contentDropbox = document.getElementById('content-dropbox');
    
        // Exit if content not found
        if (!contentUpload || !contentUrl || !contentDropbox) {
            console.warn('Content elements not found');
            return;
        }
    
    // Show upload tab by default
    uploadTab.classList.add('active-tab');
    contentUpload.classList.remove('hidden');
    contentDropbox.classList.add('hidden');
    contentUrl.classList.add('hidden');
    
    // Don't auto-load Dropbox folders - wait for user action
    
    // Dropbox tab click handler
    dropboxTab.addEventListener('click', function() {
        dropboxTab.classList.add('active-tab');
        uploadTab.classList.remove('active-tab');
        urlTab.classList.remove('active-tab');
        
        contentDropbox.classList.remove('hidden');
        contentUpload.classList.add('hidden');
        contentUrl.classList.add('hidden');
        
        // Don't auto-refresh when switching tabs - folders stay loaded
    });
    
    // Upload tab click handler
    uploadTab.addEventListener('click', function() {
        uploadTab.classList.add('active-tab');
        urlTab.classList.remove('active-tab');
        dropboxTab.classList.remove('active-tab');
        
        contentUpload.classList.remove('hidden');
        contentUrl.classList.add('hidden');
        contentDropbox.classList.add('hidden');
    });
    
    // URL tab click handler
    urlTab.addEventListener('click', function() {
        uploadTab.classList.remove('active-tab');
        urlTab.classList.add('active-tab');
        dropboxTab.classList.remove('active-tab');
        
        contentUpload.classList.add('hidden');
        contentUrl.classList.remove('hidden');
        contentDropbox.classList.add('hidden');
    });
}

    // When DOM is loaded, setup the tab functionality - this is a redundant check that's helpful
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setupDropboxTabs();
    } 
    else {
        document.addEventListener('DOMContentLoaded', setupDropboxTabs);
    }

   
});

// SECTION: Form Controls
// =====================================================

// Handle sync radio buttons
const syncAllYes = document.getElementById('sync_all_yes');
const syncAllNo = document.getElementById('sync_all_no');
const platformSelection = document.getElementById('platform-selection');

if (syncAllYes && syncAllNo && platformSelection) {
    syncAllYes.addEventListener('change', function() {
        if (this.checked) {
            platformSelection.classList.add('hidden');
        }
    });
    
    syncAllNo.addEventListener('change', function() {
        if (this.checked) {
            platformSelection.classList.remove('hidden');
        }
    });
}

// Make sure form submission includes the selected platforms
document.getElementById('addProductForm').addEventListener('submit', function(e) {

    // Previously we had logic to handle null values here for pricing but now handling in schemas.product.py in ProductCreate as this is better.

    const shippingSelect = document.getElementById('shipping_profile');
    const shippingError = document.getElementById('shippingProfileError');
    const submitBtn = document.getElementById('createProductBtn');

    if (shippingSelect && (!shippingSelect.value || !shippingSelect.value.trim())) {
        if (shippingError) {
            shippingError.classList.remove('hidden');
        }
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            submitBtn.classList.remove('hover:bg-blue-700');
        }
        shippingSelect.classList.add('border-red-500');
        shippingSelect.focus();
        e.preventDefault();
        return;
    }

    if (document.getElementById('sync_all_no') && document.getElementById('sync_all_no').checked) {
        const selectedPlatforms = Array.from(
            document.querySelectorAll('input[name="sync_platforms"]:checked')
        ).map(cb => cb.value);

        if (selectedPlatforms.length === 0) {
            e.preventDefault();
            alert('Please select at least one platform to sync with, or choose "Sync All Platforms"');
        }
    }
});

// SECTION: Price Handling
// =====================================================

// Price formatting and calculation functions
function formatPrice(price) {
    // Format a number as currency with comma separators
    return new Intl.NumberFormat('en-GB', { 
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(price);
}

function parsePrice(formattedPrice) {
    // Parse a formatted price back to a number
    if (!formattedPrice) return 0;
    return parseFloat(formattedPrice.replace(/[^0-9.-]+/g, ""));
}

function calculateEbayPrice(basePrice) {
    // 5% higher than base price
    return Math.round(basePrice * 1.05);
}

function calculateReverbPrice(basePrice) {
    // Add 5%, then round to banner price (£xx9)
    const withMargin = basePrice * 1.05;
    
    // Round up to the nearest 100
    let roundedUp = Math.ceil(withMargin / 100) * 100;
    
    // Subtract 1 to get banner price
    return roundedUp - 1;
}

function calculateVRPrice(basePrice) {
    // 5% higher than base price
    return Math.round(basePrice * 1.05);
}

function calculateShopifyPrice(basePrice) {
    // Same as base price
    return basePrice;
}

// Initialize and update prices
const basePriceDisplay = document.getElementById('base_price_display');
const basePrice = document.getElementById('base_price');

if (basePriceDisplay && basePrice) {
    // Format the initial value
    if (basePrice.value) {
        basePriceDisplay.value = formatPrice(parseFloat(basePrice.value));
    }
    
    // Update when price changes
    basePriceDisplay.addEventListener('input', function() {
        const numericValue = parsePrice(this.value);
        basePrice.value = numericValue;
        
        // Update platform prices
        updatePlatformPrices(numericValue);
    });
    
    // Also trigger on blur to ensure formatting
    basePriceDisplay.addEventListener('blur', function() {
        const numericValue = parsePrice(this.value);
        if (numericValue > 0) {
            this.value = formatPrice(numericValue);
        }
        basePrice.value = numericValue;
    });
    
    // Initial calculation of platform prices
    updatePlatformPrices(parsePrice(basePriceDisplay.value));
}

// Category mapping functionality
async function fetchCategoryMappings(reverbCategory) {
    try {
        // Get the SKU if available
        const skuField = document.getElementById('sku');
        let url = `/inventory/category-mappings/${encodeURIComponent(reverbCategory)}`;
        
        // If we have a SKU that starts with REV-, include it as a query parameter
        if (skuField && skuField.value && skuField.value.toUpperCase().startsWith('REV-')) {
            url += `?sku=${encodeURIComponent(skuField.value)}`;
            console.log(`Fetching category mappings with SKU: ${skuField.value}`);
        }
        
        const response = await fetch(url, {
            credentials: 'include',
            headers: {
                'Accept': 'application/json'
            }
        });
        if (!response.ok) {
            if (response.status === 404) {
                console.warn(`No category mappings found for: ${reverbCategory}`);
            } else {
                console.error('Failed to fetch category mappings:', response.status);
            }
            return null;
        }
        return await response.json();
    } catch (error) {
        console.error('Error fetching category mappings:', error);
        return null;
    }
}

async function updatePlatformCategories(reverbCategory) {
    // First, update the Reverb category field
    const reverbCategoryField = document.getElementById('reverb_primary_category');
    if (reverbCategoryField) {
        reverbCategoryField.value = reverbCategory;
    }
    
    // Wait for categories to be loaded if not already
    if (!window.categoriesLoaded.shopify || !window.categoriesLoaded.ebay || !window.categoriesLoaded.vr) {
        console.log('Waiting for categories to load...');
        await window.categoriesLoadPromise;
        console.log('Categories loaded!');
    }
    
    // Then fetch and update other platform mappings
    fetchCategoryMappings(reverbCategory).then(response => {
        if (!response) return;

        // Extract mappings from response
        const mappings = response.mappings || response;
        console.log('Category mappings:', mappings);

        // Update Reverb category UUID
        const reverbUuidField = document.getElementById('reverb_category_uuid');
        console.log('Looking for reverb_category_uuid field:', reverbUuidField);

        if (mappings.reverb_uuid) {
            if (reverbUuidField) {
                console.log('Setting UUID from:', reverbUuidField.value, 'to:', mappings.reverb_uuid);
                reverbUuidField.value = mappings.reverb_uuid;
                reverbUuidField.setAttribute('value', mappings.reverb_uuid); // Force attribute update
                console.log('Set Reverb category UUID:', mappings.reverb_uuid);
                console.log('Verify UUID field value:', reverbUuidField.value);
            } else {
                console.error('Could not find reverb_category_uuid field!');
            }
        } else {
            console.warn('No reverb_uuid in mappings:', mappings);
        }
        
        // Update eBay category
        if (mappings.ebay) {
            const ebayCategory = document.getElementById('ebay_category_id');
            console.log('eBay category field:', ebayCategory);
            if (ebayCategory) {
                // For select elements, we need to ensure the option exists
                let optionExists = false;
                for (let i = 0; i < ebayCategory.options.length; i++) {
                    if (ebayCategory.options[i].value === mappings.ebay.id) {
                        optionExists = true;
                        break;
                    }
                }
                
                if (optionExists) {
                    ebayCategory.value = mappings.ebay.id;
                    console.log('Set eBay category to:', mappings.ebay.id);
                } else if (!window.categoriesLoaded.ebay) {
                    // Categories haven't loaded yet, store for later
                    console.log('eBay categories not loaded yet, storing selection for later:', mappings.ebay.id);
                    window.pendingCategorySelections.ebay = mappings.ebay.id;
                } else {
                    console.warn('eBay category option not found:', mappings.ebay.id);
                    // Add the option if it doesn't exist
                    const option = document.createElement('option');
                    option.value = mappings.ebay.id;
                    option.textContent = `${mappings.ebay.name || 'Unknown Category'} (${mappings.ebay.id})`;
                    ebayCategory.appendChild(option);
                    ebayCategory.value = mappings.ebay.id;
                }
                // Force a change event to ensure any listeners are triggered
                ebayCategory.dispatchEvent(new Event('change', { bubbles: true }));
            } else {
                console.error('eBay category field not found!');
            }
        } else {
            console.log('No eBay mapping found');
        }
        
        // Update Shopify category with GID
        if (mappings.shopify && mappings.shopify.gid) {
            const shopifyCategory = document.getElementById('shopify_category');
            console.log('Shopify mapping data:', mappings.shopify);
            console.log('Shopify category field:', shopifyCategory);
            console.log('Shopify dropdown options count:', shopifyCategory ? shopifyCategory.options.length : 'N/A');
            console.log('Categories loaded status:', window.categoriesLoaded.shopify);
            
            if (shopifyCategory) {
                // For select elements, we need to ensure the option exists
                let optionExists = false;
                for (let i = 0; i < shopifyCategory.options.length; i++) {
                    if (shopifyCategory.options[i].value === mappings.shopify.gid) {
                        optionExists = true;
                        console.log(`Found matching option at index ${i}`);
                        break;
                    }
                }
                
                if (optionExists) {
                    console.log('Option exists, attempting to set value...');
                    shopifyCategory.value = mappings.shopify.gid;
                    
                    // Verify it was set
                    if (shopifyCategory.value === mappings.shopify.gid) {
                        console.log('✅ Successfully set Shopify category to:', mappings.shopify.gid);
                    } else {
                        console.log('❌ Failed to set Shopify value. Trying by index...');
                        // Try setting by index
                        for (let i = 0; i < shopifyCategory.options.length; i++) {
                            if (shopifyCategory.options[i].value === mappings.shopify.gid) {
                                shopifyCategory.selectedIndex = i;
                                console.log('✅ Set Shopify by index:', i, 'Value:', shopifyCategory.value);
                                break;
                            }
                        }
                    }
                } else if (!window.categoriesLoaded.shopify) {
                    // Categories haven't loaded yet, store for later
                    console.log('Shopify categories not loaded yet, storing selection for later:', mappings.shopify.gid);
                    window.pendingCategorySelections.shopify = mappings.shopify.gid;
                } else {
                    console.warn('Shopify category option not found:', mappings.shopify.gid);
                    // Add the option if it doesn't exist
                    const option = document.createElement('option');
                    option.value = mappings.shopify.gid;
                    // Format: "Merchant Type (GID)"
                    const displayName = mappings.shopify.name || 'Unknown Category';
                    option.textContent = `${displayName} (${mappings.shopify.gid})`;
                    option.title = mappings.shopify.name || ''; // Tooltip
                    shopifyCategory.appendChild(option);
                    shopifyCategory.value = mappings.shopify.gid;
                }
                shopifyCategory.dispatchEvent(new Event('change', { bubbles: true }));
            } else {
                console.error('Shopify category field not found!');
            }
        } else {
            console.log('No Shopify mapping found');
        }
        
        // Update V&R category
        if (mappings.vr && mappings.vr.id) {
            const vrCategory = document.getElementById('vr_category');
            console.log('V&R category field:', vrCategory);
            console.log('V&R mapping data:', mappings.vr);
            if (vrCategory) {
                // For select elements, we need to ensure the option exists
                let optionExists = false;
                for (let i = 0; i < vrCategory.options.length; i++) {
                    if (vrCategory.options[i].value === mappings.vr.id) {
                        optionExists = true;
                        break;
                    }
                }
                
                if (optionExists) {
                    vrCategory.value = mappings.vr.id;
                    console.log('Set V&R category to:', mappings.vr.id);
                } else if (!window.categoriesLoaded.vr) {
                    // Categories haven't loaded yet, store for later
                    console.log('V&R categories not loaded yet, storing selection for later:', mappings.vr.id);
                    window.pendingCategorySelections.vr = mappings.vr.id;
                } else {
                    console.warn('V&R category option not found:', mappings.vr.id);
                    // Add the option if it doesn't exist
                    const option = document.createElement('option');
                    option.value = mappings.vr.id;
                    option.textContent = mappings.vr.name || `Category ${mappings.vr.id}`;
                    vrCategory.appendChild(option);
                    vrCategory.value = mappings.vr.id;
                }
                // Also show the hierarchy in the console for debugging
                if (mappings.vr.subcategory_id) {
                    console.log('  Category:', mappings.vr.category_id);
                    console.log('  Subcategory:', mappings.vr.subcategory_id);
                    if (mappings.vr.sub_subcategory_id) {
                        console.log('  Sub-subcategory:', mappings.vr.sub_subcategory_id);
                    }
                }
                vrCategory.dispatchEvent(new Event('change', { bubbles: true }));
            } else {
                console.error('V&R category field not found!');
            }
        } else {
            console.log('No V&R mapping found');
        }
    });
}

function updatePlatformPrices(basePrice) {
    if (!basePrice || isNaN(basePrice) || basePrice <= 0) {
        return;
    }
    
    // eBay price
    const ebayPrice = calculateEbayPrice(basePrice);
    document.getElementById('ebay_price').value = ebayPrice;
    document.getElementById('ebay_price_display').value = formatPrice(ebayPrice);
    
    // Reverb price
    const reverbPrice = calculateReverbPrice(basePrice);
    document.getElementById('reverb_price').value = reverbPrice;
    document.getElementById('reverb_price_display').value = formatPrice(reverbPrice);
    
    // V&R price
    const vrPrice = calculateVRPrice(basePrice);
    document.getElementById('vr_price').value = vrPrice;
    document.getElementById('vr_price_display').value = formatPrice(vrPrice);
    
    // Shopify price (same as base)
    document.getElementById('shopify_price').value = basePrice;
    document.getElementById('shopify_price_display').value = formatPrice(basePrice);
}

// Make platform price fields updatable but also format them on blur
['ebay_price_display', 'reverb_price_display', 'vr_price_display', 'shopify_price_display'].forEach(id => {
    const displayField = document.getElementById(id);
    const valueField = document.getElementById(id.replace('_display', ''));
    
    if (displayField && valueField) {
        displayField.addEventListener('input', function() {
            valueField.value = parsePrice(this.value);
        });
        
        displayField.addEventListener('blur', function() {
            const numericValue = parsePrice(this.value);
            if (numericValue > 0) {
                this.value = formatPrice(numericValue);
            }
            valueField.value = numericValue;
        });
    }
});

document.addEventListener('DOMContentLoaded', function() {
    // Create a sticky header for the top section
    const headerElement = document.querySelector('.bg-gray-50.border-b');
    const contentContainer = document.querySelector('.container');
    
    if (headerElement) {
        // Get initial offset position of the header
        const headerOffsetTop = headerElement.offsetTop;
        
        // Function to handle scroll event
        function handleScroll() {
            if (window.pageYOffset > headerOffsetTop) {
                // Add sticky class when scrolled past the header position
                headerElement.classList.add('sticky', 'top-0', 'z-50', 'shadow-md', 'w-full');
                
                // Add padding to container to prevent content jump
                if (!headerElement.classList.contains('is-sticky')) {
                    headerElement.classList.add('is-sticky');
                    contentContainer.style.paddingTop = `${headerElement.offsetHeight}px`;
                }
            } else {
                // Remove sticky class when scrolled back up
                headerElement.classList.remove('sticky', 'top-0', 'z-50', 'shadow-md', 'is-sticky');
                contentContainer.style.paddingTop = '0';
            }
        }
        
        // Attach scroll event listener
        window.addEventListener('scroll', handleScroll);
    }
});

// Fix for the Dropbox integration with fallback
function initializeDropboxWithFallback() {
    // Try to load Dropbox folders
    fetch('/inventory/api/dropbox/folders?path=')
        .then(response => {
            if (!response.ok && response.status !== 202) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // If there's an error message, show it
            if (data.error || data.status === 'error') {
                throw new Error(data.message || 'Error loading Dropbox');
            }
        })
        .catch(error => {
            console.error('Dropbox error:', error);
        });
}

document.addEventListener('DOMContentLoaded', function() {
    // You might already have a DOMContentLoaded handler
    // In that case, add the function call inside your existing handler
    initializeDropboxWithFallback();
});

// SECTION: Shipping
// =====================================================

// Shipping Profile Management
document.addEventListener('DOMContentLoaded', function() {
    const shippingProfileSelect = document.getElementById('shipping_profile');
    const lengthInput = document.getElementById('length');
    const widthInput = document.getElementById('width');
    const heightInput = document.getElementById('height');
    const weightInput = document.getElementById('weight');
    const carriersCheckboxes = document.querySelectorAll('input[name="carriers"]');
    const manageProfilesBtn = document.getElementById('manage-profiles');

    // loadShippingProfiles() is already called at the top of DOMContentLoaded
    
    // Manage profiles button
    if (manageProfilesBtn) {
        manageProfilesBtn.addEventListener('click', function() {
            // In a real implementation, this would open a modal to manage profiles
            alert('Profile management would open here. This would be connected to a database of shipping profiles.');
        });
    }

    // DUPLICATE FUNCTION - Commented out to prevent overriding the main one
    // The real loadShippingProfiles() is defined earlier in the file
    /*
    async function loadShippingProfiles_DUPLICATE() {
        if (!shippingProfileSelect) return;
        
        console.log("Loading shipping profiles from API...");
        
        try {
            const response = await fetch('/inventory/shipping-profiles');
            console.log("API response status:", response.status);
            
            if (!response.ok) throw new Error('Failed to load shipping profiles');
            
            const profiles = await response.json();
            console.log("Profiles loaded:", profiles.length);
            
            // Clear existing options except the first one
            while (shippingProfileSelect.options.length > 1) {
                shippingProfileSelect.options.remove(1);
            }
            
            // Add profiles from API
            profiles.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.id;
                option.textContent = profile.display_name || profile.name;
                
                // Store profile data in the option's dataset
                option.dataset.profile = JSON.stringify({
                    dimensions: profile.dimensions,
                    weight: profile.weight,
                    carriers: profile.carriers,
                    options: profile.options,
                    rates: profile.rates
                });
                
                shippingProfileSelect.appendChild(option);
            });
            
            console.log(`Added ${profiles.length} shipping profiles to dropdown`);
        } catch (error) {
            console.error('Error loading shipping profiles:', error);
        }
    }
    */

    // When a profile is selected, apply its values
    if (shippingProfileSelect) {
        shippingProfileSelect.addEventListener('change', function() {
            console.log("Profile selected:", this.value);
            const selectedOption = this.options[this.selectedIndex];
            if (!selectedOption || !selectedOption.dataset.profile) return;
            
            try {
                const profile = JSON.parse(selectedOption.dataset.profile);
                
                // Apply dimensions - using the JSONB structure from database
                if (profile.dimensions) {
                    if (lengthInput) lengthInput.value = profile.dimensions.length || '';
                    if (widthInput) widthInput.value = profile.dimensions.width || '';
                    if (heightInput) heightInput.value = profile.dimensions.height || '';
                }
                
                // Apply weight
                if (weightInput) weightInput.value = profile.weight || '';
                
                // Apply carrier (now a single radio button)
                if (profile.carriers && profile.carriers.length > 0) {
                    const carrierRadio = document.querySelector(`input[name="carrier"][value="${profile.carriers[0]}"]`);
                    if (carrierRadio) carrierRadio.checked = true;
                }
                
                // Apply options (from JSONB options object)
                if (profile.options) {
                    const reqSigCheckbox = document.getElementById('require_signature');
                    const insuranceCheckbox = document.getElementById('insurance');
                    const fragileCheckbox = document.getElementById('fragile');
                    
                    if (reqSigCheckbox) reqSigCheckbox.checked = !!profile.options.require_signature;
                    if (insuranceCheckbox) insuranceCheckbox.checked = !!profile.options.insurance;
                    if (fragileCheckbox) fragileCheckbox.checked = !!profile.options.fragile;
                }
                
                // Apply rates (from JSONB rates object)
                if (profile.rates) {
                    const ukRateInput = document.querySelector('input[name="uk_rate"]');
                    const europeRateInput = document.querySelector('input[name="europe_rate"]');
                    const usaRateInput = document.querySelector('input[name="usa_rate"]');
                    const rowRateInput = document.querySelector('input[name="row_rate"]');
                    
                    if (ukRateInput) ukRateInput.value = profile.rates.uk || '';
                    if (europeRateInput) europeRateInput.value = profile.rates.europe || '';
                    if (usaRateInput) usaRateInput.value = profile.rates.usa || '';
                    if (rowRateInput) rowRateInput.value = profile.rates.row || '';
                }
                
            } catch (error) {
                console.error('Error applying profile data:', error);
            }
        });
    }
});

//     // Define shipping profiles
//     const shippingProfiles = {

//         'standard': {
//             dimensions: { length: '', width: '', height: '' },
//             weight: '',
//             carriers: ['dhl', 'fedex', 'ups'],
//             options: { require_signature: false, insurance: false, fragile: false },
//             rates: { uk: '10.00', europe: '20.00', usa: '35.00', row: '45.00' }
//         },
//         'guitars_large': {
//             dimensions: { length: '130', width: '40', height: '15' },
//             weight: '7',
//             carriers: ['dhl', 'fedex'],
//             options: { require_signature: true, insurance: true, fragile: true },
//             rates: { uk: '25.00', europe: '50.00', usa: '75.00', row: '90.00' }
//         },
//         'guitars_small': {
//             dimensions: { length: '110', width: '35', height: '12' },
//             weight: '5',
//             carriers: ['dhl', 'ups'],
//             options: { require_signature: true, insurance: true, fragile: true },
//             rates: { uk: '20.00', europe: '40.00', usa: '60.00', row: '75.00' }
//         },
//         'fragile': {
//             dimensions: { length: '', width: '', height: '' },
//             weight: '',
//             carriers: ['dhl'],
//             options: { require_signature: true, insurance: true, fragile: true },
//             rates: { uk: '15.00', europe: '30.00', usa: '45.00', row: '60.00' }
//         },
//         'international': {
//             dimensions: { length: '', width: '', height: '' },
//             weight: '',
//             carriers: ['dhl', 'fedex'],
//             options: { require_signature: true, insurance: true, fragile: false },
//             rates: { uk: '12.00', europe: '25.00', usa: '40.00', row: '50.00' }
//         }
//     };
    
//     // Package type presets
//     const packagePresets = {
//         'guitar_case': { length: '120', width: '40', height: '15', weight: '6' },
//         'pedal_small': { length: '15', width: '10', height: '5', weight: '0.5' },
//         'pedal_medium': { length: '25', width: '15', height: '10', weight: '1' },
//         'amp_head': { length: '60', width: '30', height: '25', weight: '10' },
//         'amp_combo': { length: '70', width: '50', height: '30', weight: '15' }
//     };
    
//     // Apply shipping profile
//     if (shippingProfileSelect) {
//         shippingProfileSelect.addEventListener('change', function() {
//             const profileName = this.value;
//             if (profileName && shippingProfiles[profileName]) {
//                 applyShippingProfile(shippingProfiles[profileName]);
//             }
//         });
//     }
    
//     // Apply package preset
//     if (packageTypeSelect) {
//         packageTypeSelect.addEventListener('change', function() {
//             const packageType = this.value;
//             if (packageType && packagePresets[packageType]) {
//                 applyPackagePreset(packagePresets[packageType]);
//             }
//         });
//     }
    
//     function applyShippingProfile(profile) {
//         // Apply dimensions if provided
//         if (profile.dimensions) {
//             if (lengthInput && profile.dimensions.length) lengthInput.value = profile.dimensions.length;
//             if (widthInput && profile.dimensions.width) widthInput.value = profile.dimensions.width;
//             if (heightInput && profile.dimensions.height) heightInput.value = profile.dimensions.height;
//         }
        
//         // Apply weight if provided
//         if (weightInput && profile.weight) weightInput.value = profile.weight;
        
//         // Check/uncheck carriers
//         carriersCheckboxes.forEach(checkbox => {
//             checkbox.checked = profile.carriers.includes(checkbox.value);
//         });
        
//         // Set shipping options
//         if (profile.options) {
//             Object.keys(profile.options).forEach(option => {
//                 const checkbox = document.getElementById(option);
//                 if (checkbox) checkbox.checked = profile.options[option];
//             });
//         }
        
//         // Set regional rates
//         if (profile.rates) {
//             Object.keys(profile.rates).forEach(region => {
//                 const input = document.querySelector(`input[name="${region}_rate"]`);
//                 if (input) input.value = profile.rates[region];
//             });
//         }
//     }
    
//     function applyPackagePreset(preset) {
//         if (lengthInput) lengthInput.value = preset.length;
//         if (widthInput) widthInput.value = preset.width;
//         if (heightInput) heightInput.value = preset.height;
//         if (weightInput) weightInput.value = preset.weight;
//     }
    
//     // Load shipping profiles from API
//     async function loadShippingProfiles() {
//         const profileSelect = document.getElementById('shipping_profile');
//         if (!profileSelect) return;
        
//         try {
//             const response = await fetch('/inventory/shipping-profiles');
//             if (!response.ok) throw new Error('Failed to load shipping profiles');
            
//             const profiles = await response.json();
            
//             // Clear existing options except the first one
//             while (profileSelect.options.length > 1) {
//                 profileSelect.options.remove(1);
//             }
            
//             // Add profiles from API
//             profiles.forEach(profile => {
//                 const option = document.createElement('option');
//                 option.value = profile.id;
//                 option.textContent = profile.name;
                
//                 // Store profile data in the option's dataset
//                 // This now correctly handles the JSONB structure from the database
//                 option.dataset.profile = JSON.stringify({
//                     dimensions: profile.dimensions, // Already a JSON object from the database
//                     weight: profile.weight,
//                     carriers: profile.carriers,
//                     options: profile.options,
//                     rates: profile.rates
//                 });
                
//                 profileSelect.appendChild(option);
//             });
            
//             console.log(`Loaded ${profiles.length} shipping profiles`);
//         } catch (error) {
//             console.error('Error loading shipping profiles:', error);
//         }
//     }

//     // When a profile is selected, apply its values
//     document.getElementById('shipping_profile')?.addEventListener('change', function() {
//         const selectedOption = this.options[this.selectedIndex];
//         if (!selectedOption || !selectedOption.dataset.profile) return;
        
//         try {
//             const profile = JSON.parse(selectedOption.dataset.profile);
            
//             // Apply dimensions - using the JSONB structure from database
//             if (profile.dimensions) {
//                 document.getElementById('length').value = profile.dimensions.length || '';
//                 document.getElementById('width').value = profile.dimensions.width || '';
//                 document.getElementById('height').value = profile.dimensions.height || '';
//             }
            
//             // Apply weight
//             document.getElementById('weight').value = profile.weight || '';
            
//             // Apply carriers (as array in JSONB)
//             document.querySelectorAll('input[name="carriers"]').forEach(checkbox => {
//                 checkbox.checked = profile.carriers && profile.carriers.includes(checkbox.value);
//             });
            
//             // Apply options (from JSONB options object)
//             if (profile.options) {
//                 document.getElementById('require_signature').checked = !!profile.options.require_signature;
//                 document.getElementById('insurance').checked = !!profile.options.insurance;
//                 document.getElementById('fragile').checked = !!profile.options.fragile;
//             }
            
//             // Apply rates (from JSONB rates object)
//             if (profile.rates) {
//                 document.querySelector('input[name="uk_rate"]').value = profile.rates.uk || '';
//                 document.querySelector('input[name="europe_rate"]').value = profile.rates.europe || '';
//                 document.querySelector('input[name="usa_rate"]').value = profile.rates.usa || '';
//                 document.querySelector('input[name="row_rate"]').value = profile.rates.row || '';
//             }
            
//         } catch (error) {
//             console.error('Error applying profile data:', error);
//         }
//     });

//     // Initialize when document is ready
//     document.addEventListener('DOMContentLoaded', function() {
//         loadShippingProfiles();
//     }); 

//     // Manage profiles button
//     const manageProfilesBtn = document.getElementById('manage-profiles');
//     if (manageProfilesBtn) {
//         manageProfilesBtn.addEventListener('click', function() {
//             // In a real implementation, this would open a modal to manage profiles
//             alert('Profile management would open here. This would be connected to a database of shipping profiles.');
//         });
//     }
// });


</script>

<style>
    /* Modern Professional Form Styling */
    .transition-transform {
        transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Platform Tab Styling */
    .platform-tab.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: transparent;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }
    
    /* Form Section Styling */
    .form-section {
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
    }
    
    .form-section:hover {
        transform: translateY(-2px);
    }
    
    .form-section:last-child {
        margin-bottom: 0;
    }
    
    /* Form Section Animation */
    .form-section-content {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .form-section-header:hover .form-section-icon {
        transform: translateX(3px);
    }
    
    /* Tab Pane Styling */
    .tab-pane {
        display: none;
        animation: fadeIn 0.3s ease-in;
    }
    
    .tab-pane.active {
        display: block;
    }
    
    /* Tab Button Enhanced */
    .tab-button {
        min-width: 120px;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        transition: all 0.3s ease;
    }
    
    .tab-button.active-tab {
        background: white !important;
        color: rgb(79, 70, 229) !important;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }
    
    .tab-button:not(.active-tab):hover {
        background: rgba(255, 255, 255, 0.5);
    }
    
    /* Professional Input Focus Effects */
    input:focus, select:focus, textarea:focus {
        transform: translateY(-1px);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    /* Valid Input Indication */
    input:not(:focus):not(:placeholder-shown):valid {
        border-color: #10b981;
        background-color: rgba(16, 185, 129, 0.05);
    }
    
    /* Sticky Header Animation */
    .sticky {
        position: fixed;
        animation: slideDown 0.3s;
        width: 100%;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        z-index: 1000;
    }

    @keyframes slideDown {
        from {
            transform: translateY(-100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Button Hover Effects */
    button {
        transition: all 0.2s ease;
    }
    
    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.15);
    }
    
    button:active {
        transform: translateY(0);
        box-shadow: 0 5px 10px -5px rgba(0, 0, 0, 0.15);
    }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    
    ::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
        transition: background 0.3s ease;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
    
    /* Loading Spinner Enhancement */
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .animate-spin {
        animation: spin 1s linear infinite;
    }
    
    /* Success Animation */
    @keyframes success-bounce {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
    
    /* Model Suggestion Hover */
    .model-suggestion:hover {
        background: linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 100%);
        padding-left: 20px;
        transition: all 0.2s ease;
    }
    
    /* Dropbox Image Hover Effect */
    #dropbox-items > div:hover {
        transform: scale(1.05);
        transition: transform 0.2s ease;
        z-index: 10;
    }

    /* Ensure status boxes are not greyed out by default */
    #shopify-status-box,
    #reverb-status-box,
    #vr-status-box,
    #ebay-status-box {
        opacity: 1 !important;
    }
    
    /* Only grey out when explicitly set */
    #shopify-status-box.opacity-40,
    #reverb-status-box.opacity-40,
    #vr-status-box.opacity-40,
    #ebay-status-box.opacity-40 {
        opacity: 0.4 !important;
    }
</style>
{% endblock %}
