{% extends "base.html" %}

{% block title %}Add Product - Realtime Inventory Forms Flow{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-white rounded-lg shadow-lg overflow-hidden max-w-4xl mx-auto">
        <div class="px-6 py-4 bg-gray-50 border-b">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-900">Add New Product</h1>
                <a href="/inventory" class="text-blue-600 hover:text-blue-800">Back to List</a>
            </div>
        </div>

        <!-- Error Messages (if any) -->
        {% if error %}
        <div class="p-4">
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                <span class="block sm:inline">{{ error }}</span>
            </div>
        </div>
        {% endif %}

        <form 
            method="POST" 
            action="/inventory/add"
            enctype="multipart/form-data" 
            class="p-6 space-y-6"
            id="addProductForm"
            >

            <!-- Basic Info Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Brand</label>
                    <input type="text" name="brand" required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Model</label>
                    <input type="text" name="model" required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">SKU</label>
                    <input type="text" name="sku" required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Year</label>
                    <input type="number" name="year"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
            </div>

            <!-- Category and Condition -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Category</label>
                    <input type="text" name="category" required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Condition</label>
                    <select name="condition" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="NEW">NEW</option>
                        <option value="EXCELLENT">EXCELLENT</option>
                        <option value="VERYGOOD">VERY GOOD</option>
                        <option value="GOOD">GOOD</option>
                        <option value="FAIR">FAIR</option>
                        <option value="POOR">POOR</option>
                    </select>
                </div>
            </div>

            <!-- Pricing -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Base Price</label>
                    <input type="number" name="base_price" step="0.01" required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Cost Price</label>
                    <input type="number" name="cost_price" step="0.01"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
            </div>

            <!-- Description -->
            <div>
                <label class="block text-sm font-medium text-gray-700">Description</label>
                <textarea name="description" rows="4"
                          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
            </div>

            <!-- Status -->
            <div>
                <label class="block text-sm font-medium text-gray-700">Status</label>
                <select name="status" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="DRAFT">Draft</option>
                    <option value="ACTIVE">Active</option>
                    <option value="ARCHIVED">Archived</option>
                </select>
            </div>

            <!-- Images -->
            <div class="space-y-4">
                <!-- Collapsible Header -->
                <button type="button" 
                        onclick="toggleImageSection()"
                        class="flex justify-between items-center w-full py-2 px-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                    <span class="text-lg font-medium">Images</span>
                    <svg id="imageToggleIcon" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>

                <!-- Collapsible Content -->
                <div id="imageSection" class="hidden space-y-4 p-4 border rounded-lg">
                    <!-- Primary Image -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">Primary Image</label>

                        <!-- File Upload -->
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-700">Upload File</label>
                            <input type="file" 
                                name="primary_image_file" 
                                accept="image/*"
                                class="block w-full text-sm text-gray-500
                                        file:mr-4 file:py-2 file:px-4
                                        file:rounded-md file:border-0
                                        file:text-sm file:font-semibold
                                        file:bg-blue-50 file:text-blue-700
                                        hover:file:bg-blue-100">
                        </div>

                        <!-- URL Input -->
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-700">Or Enter URL</label>
                            <input type="url" 
                                name="primary_image_url"
                                placeholder="https://"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    </div>

                    <!-- Additional Images -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">Additional Images</label>

                        <!-- File Upload -->
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-700">Upload Files</label>
                            <input type="file" 
                                name="additional_images_files" 
                                accept="image/*"
                                multiple
                                class="block w-full text-sm text-gray-500
                                        file:mr-4 file:py-2 file:px-4
                                        file:rounded-md file:border-0
                                        file:text-sm file:font-semibold
                                        file:bg-blue-50 file:text-blue-700
                                        hover:file:bg-blue-100">
                        </div>

                        <!-- URL Input -->
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-700">Or Enter URLs (one per line)</label>
                            <textarea name="additional_images_urls"
                                    rows="3"
                                    placeholder="https://&#10;https://&#10;https://"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                        </div>

                        <!-- Image Preview Section -->
                        <div id="imagePreview" class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">
                            <!-- Preview images will be inserted here by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="flex justify-end">
                <button type="submit"
                        onclick="console.log('Submit button clicked')"
                        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Add Product
                </button>
            </div>
        </form>
        <!-- Platform Status Section -->
        <div class="px-6 pb-6">
            <h3 class="text-lg font-semibold mb-4">Platform Status</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <!-- eBay Status -->
                <div class="border rounded p-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full {% if ebay_status == 'success' %}bg-green-500{% elif ebay_status == 'pending' %}bg-yellow-500{% else %}bg-red-500{% endif %}"></div>
                        <span>eBay</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">{{ ebay_message or 'Waiting for sync' }}</p>
                </div>

                <!-- Reverb Status -->
                <div class="border rounded p-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full {% if reverb_status == 'success' %}bg-green-500{% elif reverb_status == 'pending' %}bg-yellow-500{% else %}bg-red-500{% endif %}"></div>
                        <span>Reverb</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">{{ reverb_message or 'Waiting for sync' }}</p>
                </div>

                <!-- V&R Status -->
                <div class="border rounded p-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full {% if vr_status == 'success' %}bg-green-500{% elif vr_status == 'pending' %}bg-yellow-500{% else %}bg-red-500{% endif %}"></div>
                        <span>Vintage & Rare</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">{{ vr_message or 'Waiting for sync' }}</p>
                </div>

                <!-- Website Status -->
                <div class="border rounded p-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full {% if website_status == 'success' %}bg-green-500{% elif website_status == 'pending' %}bg-yellow-500{% else %}bg-red-500{% endif %}"></div>
                        <span>Website</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">{{ website_message or 'Waiting for sync' }}</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Single consolidated script -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Image preview functionality
        function toggleImageSection() {
            const section = document.getElementById('imageSection');
            const icon = document.getElementById('imageToggleIcon');
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                section.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        }
    
        // Image preview for file uploads
        const fileInputs = document.querySelectorAll('input[type="file"]');
        const previewContainer = document.getElementById('imagePreview');
    
        fileInputs.forEach(input => {
            input.addEventListener('change', function(e) {
                // Clear previous previews if this is the primary image
                if (this.name === 'primary_image_file') {
                    previewContainer.innerHTML = '';
                }
    
                if (this.files) {
                    Array.from(this.files).forEach(file => {
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const preview = document.createElement('div');
                                preview.className = 'relative aspect-square';
                                preview.innerHTML = `
                                    <img src="${e.target.result}" 
                                         class="w-full h-full object-cover rounded-lg shadow-sm"
                                         alt="Preview">
                                `;
                                previewContainer.appendChild(preview);
                            };
                            reader.readAsDataURL(file);
                        } else {
                            alert('Please select only image files.');
                            this.value = ''; // Clear the input
                        }
                    });
                }
            });
        });
    
        // Form submission handling
        const form = document.getElementById('addProductForm');
        console.log('Form found:', form);
        
        form.addEventListener('submit', function(e) {
            // Stop the default submission temporarily for debugging
            e.preventDefault();
            
            console.log('Form submission started');
            const formData = new FormData(form);
            
            // Log all form values
            for (let [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
            }
            
            // Now actually submit the form
            console.log('Submitting form to:', form.action);
            form.submit();
        });
    
        // Make toggleImageSection available globally
        window.toggleImageSection = toggleImageSection;
    });
</script>

<style>
    .transition-transform {
        transition: transform 0.2s ease-in-out;
    }
</style>
{% endblock %}