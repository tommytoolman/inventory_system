{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <!-- Product Header -->
        <div class="px-6 py-4 bg-gray-50 border-b">
            <div class="flex justify-between items-center">
                <div class="flex items-center flex-1">
                    <div class="h-16 w-16 rounded-full overflow-hidden mr-4">
                        {% if product.primary_image %}
                            <img src="{{ product.primary_image }}" alt="{{ product.brand }} {{ product.model }}" class="h-full w-full object-cover">
                        {% else %}
                            <div class="h-full w-full bg-gray-200 flex items-center justify-center">
                                <svg class="h-6 w-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </div>
                        {% endif %}
                    </div>
                    <div class="flex-1">
                        <h1 class="text-2xl font-bold text-gray-900">
                            {{ product.brand|title }} {{ product.model }}
                        </h1>
                    </div>
                    
                    <!-- Status badges moved next to title -->
                    <div class="flex items-center space-x-3 mr-4">
                        <!-- Product Status -->
                        {% set status_val = product.status.value|upper if product.status else '' %}
                        {% if status_val == 'SOLD' %}
                            <span class="px-3 py-1 text-sm rounded-full bg-red-100 text-red-800">
                                Sold
                            </span>
                        {% elif status_val == 'DRAFT' %}
                            <span class="px-3 py-1 text-sm rounded-full bg-yellow-100 text-yellow-800">
                                Draft
                            </span>
                        {% elif status_val == 'ARCHIVED' %}
                            <span class="px-3 py-1 text-sm rounded-full bg-purple-100 text-purple-800">
                                Archived
                            </span>
                        {% else %}
                            <span class="px-3 py-1 text-sm rounded-full bg-green-100 text-green-800">
                                {{ status_val|title }}
                            </span>
                        {% endif %}

                        <!-- End All Listings button - only show if there are active listings -->
                        {% set active_platforms = [] %}
                        {% for platform_entry in all_platforms_status %}
                            {% if platform_entry.is_listed and platform_entry.details %}
                                {% set platform_status = platform_entry.details.status|upper if platform_entry.details.status else 'UNKNOWN' %}
                                {% if platform_status in ['ACTIVE', 'LIVE'] %}
                                    {% set _ = active_platforms.append(platform_entry) %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}

                        {% if active_platforms|length > 0 %}
                            <button onclick="endAllListings()"
                                class="px-3 py-1 text-sm rounded-full bg-red-100 text-red-700 hover:bg-red-200 focus:outline-none focus:ring-1 focus:ring-red-300">
                                End All Listings
                            </button>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Back button stays on far right -->
                <div class="ml-4">
                    <a href="/inventory" class="text-blue-600 hover:text-blue-800 font-medium">
                        ‚Üê Back to List
                    </a>
                </div>
            </div>
        </div>

        <!-- Platform Status Messages from Add Product -->
        {% if show_status and platform_messages %}
            <div class="px-6 py-4 bg-gray-50 border-b">
                <div class="space-y-2">
                    {% for msg in platform_messages %}
                        <div id="platform-status-{{ msg.platform }}"
                             class="flex items-center p-3 rounded-lg
                                    {% if msg.status == 'success' %}bg-green-50 border border-green-200{% endif %}
                                    {% if msg.status == 'error' %}bg-red-50 border border-red-200{% endif %}
                                    {% if msg.status == 'info' %}bg-blue-50 border border-blue-200{% endif %}">

                            <!-- Platform Icon -->
                            <div class="flex-shrink-0 mr-3">
                                {% if msg.status == 'success' %}
                                    <svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                {% elif msg.status == 'error' %}
                                    <svg class="h-5 w-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                {% else %}
                                    <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                {% endif %}
                            </div>

                            <!-- Message Content -->
                            <div class="flex-1">
                                <span class="font-semibold
                                           {% if msg.status == 'success' %}text-green-800{% endif %}
                                           {% if msg.status == 'error' %}text-red-800{% endif %}
                                           {% if msg.status == 'info' %}text-blue-800{% endif %}">
                                    {{ msg.platform }}:
                                </span>
                                <span class="ml-1
                                           {% if msg.status == 'success' %}text-green-700{% endif %}
                                           {% if msg.status == 'error' %}text-red-700{% endif %}
                                           {% if msg.status == 'info' %}text-blue-700{% endif %}">
                                    {{ msg.message }}
                                </span>
                            </div>

                            <!-- Close button -->
                            <button onclick="document.getElementById('platform-status-{{ msg.platform }}').remove()"
                                    class="ml-3 flex-shrink-0
                                           {% if msg.status == 'success' %}text-green-400 hover:text-green-600{% endif %}
                                           {% if msg.status == 'error' %}text-red-400 hover:text-red-600{% endif %}
                                           {% if msg.status == 'info' %}text-blue-400 hover:text-blue-600{% endif %}">
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <script>
                // Auto-hide success messages after 10 seconds
                setTimeout(function() {
                    {% for msg in platform_messages %}
                        {% if msg.status == 'success' %}
                            var elem = document.getElementById('platform-status-{{ msg.platform }}');
                            if (elem) {
                                elem.style.transition = 'opacity 0.5s';
                                elem.style.opacity = '0';
                                setTimeout(function() { elem.remove(); }, 500);
                            }
                        {% endif %}
                    {% endfor %}
                }, 10000);
            </script>
        {% endif %}

        <!-- Product Details -->
        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 items-stretch">
            <!-- Basic Info -->
            <div>
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold">Product Information</h2>
                    <a href="/inventory/products/{{ product.id }}/edit" 
                       class="inline-flex items-center justify-center w-8 h-8 bg-gray-200 hover:bg-gray-300 rounded-full text-gray-600 hover:text-gray-800 transition-colors"
                       title="Edit Product">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                        </svg>
                    </a>
                </div>
                <div class="border rounded p-4">
                    <dl class="space-y-2">
                        <div class="flex justify-between">
                            <dt class="text-gray-600">Category</dt>
                            <dd class="text-right">{{ product.category or 'N/A' }}</dd>
                        </div>
                        
                        <div class="flex justify-between">
                            <dt class="text-gray-600">Brand</dt>
                            <dd class="text-right">{{ product.brand|title or 'N/A' }}</dd>
                        </div>
                        
                        <div class="flex justify-between">
                            <dt class="text-gray-600">Model</dt>
                            <dd class="text-right">{{ product.model or 'N/A' }}</dd>
                        </div>
                        
                        <div class="flex justify-between">
                            <dt class="text-gray-600">Finish</dt>
                            <dd class="text-right">{{ product.finish or 'N/A' }}</dd>
                        </div>
                        
                        <div class="flex justify-between">
                            <dt class="text-gray-600">Year</dt>
                            <dd class="text-right">
                                {% if product.year %}
                                    {{ product.year }}
                                {% elif product.decade %}
                                    {{ product.decade }}s
                                {% else %}
                                    N/A
                                {% endif %}
                            </dd>
                        </div>
                        
                        <div class="flex justify-between">
                            <dt class="text-gray-600">Condition</dt>
                            <dd class="text-right">{{ product.condition.value|title if product.condition else 'N/A' }}</dd>
                        </div>
                        
                        <div class="flex justify-between">
                            <dt class="text-gray-600">Base Price</dt>
                            <dd class="text-right">
                                {% if product.base_price and product.base_price > 0 %}
                                    ¬£{{ "{:,.0f}".format(product.base_price) }}
                                {% else %}
                                    <span class="text-gray-500">-</span>
                                {% endif %}
                            </dd>
                        </div>
                        
                        <div class="flex justify-between">
                            <dt class="text-gray-600">SKU</dt>
                            <dd class="text-right">{{ product.sku or 'N/A' }}</dd>
                        </div>
                        
                        <div class="flex justify-between">
                            <dt class="text-gray-600">Quantity Available</dt>
                            <dd class="text-right">
                                {% if product.is_stocked_item %}
                                    {{ product.quantity or 0 }}
                                {% else %}
                                    1
                                {% endif %}
                            </dd>
                        </div>
                    </dl>
                </div>
            </div>

            <!-- Platform Listings -->
            <div>
                <h2 class="text-lg font-semibold mb-4">Platform Listings</h2>
                <div class="border rounded p-4 pb-3 h-full">
                    <div class="space-y-3">
                    {% if all_platforms_status %}
                        {% for platform_entry in all_platforms_status %}
                        <div class="border rounded p-3 bg-gray-50">
                            <!-- üîç DEBUG: Show all available data -->
                            <!-- <div class="text-xs text-red-500 mb-2 p-2 bg-red-50 border border-red-200 rounded">
                                <strong>DEBUG DATA:</strong><br>
                                Platform: {{ platform_entry.name }}<br>
                                Is Listed: {{ platform_entry.is_listed }}<br>
                                Has Details: {{ platform_entry.details is not none }}<br>
                                {% if platform_entry.details %}
                                    External ID: "{{ platform_entry.details.external_id or 'NONE' }}"<br>
                                    Listing URL: "{{ platform_entry.details.listing_url or 'NONE' }}"<br>
                                    Sync Status: "{{ platform_entry.details.sync_status or 'NONE' }}"<br>
                                    Last Sync: "{{ platform_entry.details.last_sync or 'NONE' }}"<br>
                                    Details Keys: {{ platform_entry.details.keys() if platform_entry.details is mapping else 'Not a dict' }}
                                {% endif %}
                            </div> -->

                            {% if platform_entry.is_listed and platform_entry.details %}
                                <!-- Listed state -->
                                <!-- Line 1: Platform Name + Status -->
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-medium">
                                        {% if platform_entry.name|lower == 'vr' %}
                                            Vintage & Rare
                                        {% else %}
                                            {{ platform_entry.name|title }}
                                        {% endif %}
                                    </span>
                                    {% set platform_status = platform_entry.details.status|upper if platform_entry.details.status else 'UNKNOWN' %}
                                    {% if platform_status in ['SOLD', 'ENDED', 'SOLD_OUT'] %}
                                        <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">
                                            Sold
                                        </span>
                                    {% elif platform_status in ['DRAFT'] %}
                                        <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">
                                            Draft
                                        </span>
                                    {% elif platform_status in ['ARCHIVED'] %}
                                        <span class="px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-800">
                                            Archived
                                        </span>
                                    {% elif platform_status in ['ACTIVE', 'LIVE'] %}
                                        <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">
                                            Active
                                        </span>
                                    {% else %}
                                        <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">
                                            {{ platform_status|title }}
                                        </span>
                                    {% endif %}
                                </div>
                                
                                <!-- Line 2: ID + Show Listing button + End Listing button -->
                                <div class="flex justify-between items-center text-sm text-gray-600 mb-1">
                                    <span>ID: {{ platform_entry.details.external_id or 'N/A' }}</span>
                                    <div class="flex gap-2">
                                        {% if platform_entry.details.listing_url %}
                                            <a href="{{ platform_entry.details.listing_url }}" target="_blank"
                                            class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-700 hover:bg-blue-200 focus:outline-none focus:ring-1 focus:ring-blue-300">
                                                Show Listing
                                            </a>
                                        {% endif %}

                                        <!-- End Listing button - only show for active listings -->
                                        {% set platform_status = platform_entry.details.status|upper if platform_entry.details.status else 'UNKNOWN' %}
                                        {% if platform_status in ['ACTIVE', 'LIVE'] and platform_entry.details.external_id %}
                                            <button onclick="endListing('{{ platform_entry.name|lower }}', '{{ platform_entry.details.external_id }}', {{ product.id }})"
                                                class="px-2 py-1 text-xs rounded bg-red-100 text-red-700 hover:bg-red-200 focus:outline-none focus:ring-1 focus:ring-red-300"
                                                data-platform-active="true"
                                                data-platform="{{ platform_entry.name|lower }}"
                                                data-external-id="{{ platform_entry.details.external_id }}">
                                                End Listing
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Line 3: Last Sync -->
                                <div class="text-sm text-gray-600">
                                    Last Sync: {{ platform_entry.details.last_sync.strftime('%Y-%m-%d %H:%M') if platform_entry.details.last_sync else 'Never' }}
                                </div>
                            {% else %}
                                <!-- Not Listed state -->
                                <!-- Line 1: Platform Name + Status -->
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-medium">
                                        {% if platform_entry.name|lower == 'vr' %}
                                            Vintage & Rare
                                        {% else %}
                                            {{ platform_entry.name|title }}
                                        {% endif %}
                                    </span>
                                    <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">
                                        Not Listed
                                    </span>
                                </div>
                                
                                <!-- Line 2: List Item button -->
                                <div class="flex justify-end">
                                    {% set product_status = product.status.value|upper if product.status else '' %}
                                    {% if product_status not in ['SOLD', 'ARCHIVED'] %}
                                        <form action="{{ url_for('create_platform_listing_from_detail', product_id=product.id, platform_slug=platform_entry.slug) }}" method="POST" class="inline">
                                            <button type="submit" class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-700 hover:bg-blue-200 focus:outline-none focus:ring-1 focus:ring-blue-300">
                                                List Item
                                            </button>
                                        </form>
                                    {% else %}
                                        <button disabled class="px-2 py-1 text-xs rounded bg-gray-200 text-gray-400 cursor-not-allowed">
                                            List Item
                                        </button>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-gray-500 italic">
                            No platform information available or platforms not configured.
                        </div>
                    {% endif %}
                    </div>
                </div>
            </div>

            <!-- Description -->
            <div class="md:col-span-2">
                <h2 class="text-lg font-semibold mb-4">Description</h2>
                <div class="prose max-w-none">
                    {{ product.description|safe or 'No description available.' }}
                </div>
            </div>

            <!-- Media Section -->
            {% if product.primary_image or product.additional_images %}
            <div class="md:col-span-2">
                <h2 class="text-lg font-semibold mb-4">Images</h2>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
                    {% if product.primary_image %}
                    <div class="aspect-w-4 aspect-h-3">
                        <img src="{{ product.primary_image }}" 
                            alt="Primary image" 
                            class="product-image clickable-image primary-image" 
                            data-full-url="{{ product.primary_image }}"
                            title="Primary image - Click to view full size">
                    </div>
                    {% endif %}
                    {% for image in product.additional_images %}
                    <div class="aspect-w-4 aspect-h-3">
                        <img src="{{ image }}" 
                            alt="Additional image" 
                            class="product-image clickable-image"
                            data-full-url="{{ image }}"
                            title="Click to view full size">
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}


        </div>
    </div>
</div>

<style>
    .product-image {
        max-width: 250px;
        max-height: 250px;
        object-fit: contain;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .clickable-image {
        cursor: pointer;
        transition: opacity 0.2s ease;
    }
    
    .clickable-image:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    /* ‚ú® Primary image styling */
    .primary-image {
        border: 3px solid #fbbf24; /* Golden border */
        box-shadow: 0 0 15px rgba(251, 191, 36, 0.4); /* Golden glow */
        position: relative;
    }
    
    .primary-image:hover {
        border-color: #f59e0b; /* Darker gold on hover */
        box-shadow: 0 0 20px rgba(245, 158, 11, 0.6);
        transform: scale(1.08); /* Slightly bigger hover effect */
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Check URL parameters for brand validation feedback
        
        // Add click handlers for images
        const clickableImages = document.querySelectorAll('.clickable-image');
        clickableImages.forEach(image => {
            image.addEventListener('click', function() {
                const fullUrl = this.getAttribute('data-full-url');
                if (fullUrl) {
                    // Open in new tab
                    window.open(fullUrl, '_blank');
                }
            });
        });
        
        const urlParams = new URLSearchParams(window.location.search);
        const message = urlParams.get('message');
        const messageType = urlParams.get('message_type');
        const fallbackUrl = urlParams.get('fallback_url');
        
        // Display message if present
        if (message) {
            displayMessage(message, messageType);
        }
        
        // Handle fallback brand confirmation
        if (fallbackUrl && messageType === 'warning') {
            // Show confirmation dialog for brand fallback
            const confirmed = confirm(
                `${message}\n\n` +
                `Click OK to proceed with 'Justin' as the brand, or Cancel to go back.`
            );
            
            if (confirmed) {
                // User confirmed - redirect to fallback URL
                window.location.href = fallbackUrl;
            } else {
                // User cancelled - clear the URL parameters to remove the message
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
        
        function displayMessage(message, type) {
            // Create message element
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert alert-${type || 'info'} mb-4 p-4 rounded-md`;

            // Set colors based on message type
            if (type === 'error') {
                messageDiv.className += ' bg-red-100 border border-red-400 text-red-700';
            } else if (type === 'warning') {
                messageDiv.className += ' bg-yellow-100 border border-yellow-400 text-yellow-700';
            } else if (type === 'success') {
                messageDiv.className += ' bg-green-100 border border-green-400 text-green-700';
            } else {
                messageDiv.className += ' bg-blue-100 border border-blue-400 text-blue-700';
            }

            messageDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <span>${message.replace(/\+/g, ' ')}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-lg">&times;</button>
                </div>
            `;

            // Insert at the top of the container
            const container = document.querySelector('.container');
            container.insertBefore(messageDiv, container.firstChild);

            // Auto-remove success/info messages after 5 seconds
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    if (messageDiv.parentElement) {
                        messageDiv.remove();
                    }
                }, 5000);
            }
        }

        // Alias showMessage to displayMessage
        function showMessage(type, message) {
            displayMessage(message, type);
        }

        // Make endListing globally accessible
        window.endListing = async function(platform, externalId, productId) {
            let action = 'end';  // default action

            // For V&R, offer choice between end and delete
            if (platform === 'vr') {
                const vrAction = confirm(
                    'For Vintage & Rare listings, you can either:\n\n' +
                    'Click OK to END the listing (mark as sold)\n' +
                    'Click Cancel to DELETE the listing permanently\n\n' +
                    'Which would you like to do?'
                );
                action = vrAction ? 'end' : 'delete';

                // Confirm the chosen action
                const confirmMessage = action === 'end'
                    ? 'Are you sure you want to END this V&R listing (mark as sold)?'
                    : 'Are you sure you want to DELETE this V&R listing permanently?';

                if (!confirm(confirmMessage)) {
                    return;
                }
            } else {
                // For other platforms, just confirm ending
                if (!confirm(`Are you sure you want to end this ${platform} listing?`)) {
                    return;
                }
            }

            showMessage('info', `${action === 'delete' ? 'Deleting' : 'Ending'} ${platform} listing...`);

            try {
                let endpoint;
                let method = 'POST';
                let body = {};

                // Platform-specific endpoints
                switch(platform) {
                    case 'reverb':
                        endpoint = `/api/reverb/listings/${externalId}/end`;
                        body = { reason: 'not_sold' };
                        break;
                    case 'ebay':
                        endpoint = `/api/ebay/listings/${externalId}/end`;
                        body = { reason: 'NotAvailable' };
                        break;
                    case 'shopify':
                        endpoint = `/api/shopify/products/${externalId}/archive`;
                        break;
                    case 'vr':
                        // For V&R, we need to handle end vs delete differently
                        if (action === 'delete') {
                            endpoint = `/api/vr/listings/${externalId}/delete`;
                        } else {
                            endpoint = `/api/vr/listings/${externalId}/end`;
                        }
                        break;
                    default:
                        throw new Error(`Unsupported platform: ${platform}`);
                }

                const response = await fetch(endpoint, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || `Failed to ${action} ${platform} listing`);
                }

                showMessage('success', `Successfully ${action === 'delete' ? 'deleted' : 'ended'} ${platform} listing`);

                // Reload page after 2 seconds to show updated status
                setTimeout(() => {
                    window.location.reload();
                }, 2000);

            } catch (error) {
                console.error(`Error ${action}ing listing:`, error);
                showMessage('error', `Failed to ${action} listing: ${error.message}`);
            }
        }

        // Make endAllListings globally accessible
        window.endAllListings = async function() {
            // Get all active platforms
            const activePlatforms = [];
            const platformElements = document.querySelectorAll('[data-platform-active="true"]');

            platformElements.forEach(elem => {
                const platform = elem.getAttribute('data-platform');
                const externalId = elem.getAttribute('data-external-id');
                if (platform && externalId) {
                    activePlatforms.push({ platform, externalId });
                }
            });

            if (activePlatforms.length === 0) {
                showMessage('warning', 'No active listings to end');
                return;
            }

            // Check if V&R is among the platforms
            const hasVR = activePlatforms.some(p => p.platform === 'vr');
            let vrAction = 'end';

            if (hasVR) {
                const vrChoice = confirm(
                    'You have a Vintage & Rare listing. Would you like to:\n\n' +
                    'Click OK to END all listings (mark as sold)\n' +
                    'Click Cancel to DELETE the V&R listing (and end others)\n\n' +
                    'Which would you like to do?'
                );
                vrAction = vrChoice ? 'end' : 'delete';
            }

            // Build confirmation message
            let confirmMessage = `Are you sure you want to end listings on the following platforms?\n\n`;
            activePlatforms.forEach(p => {
                if (p.platform === 'vr' && vrAction === 'delete') {
                    confirmMessage += `‚Ä¢ ${p.platform.toUpperCase()}: DELETE permanently\n`;
                } else {
                    confirmMessage += `‚Ä¢ ${p.platform.toUpperCase()}: End listing\n`;
                }
            });

            if (!confirm(confirmMessage)) {
                return;
            }

            showMessage('info', 'Processing end requests for all platforms...');

            // Process each platform
            const productId = {{ product.id }};
            let successCount = 0;
            let errorCount = 0;

            for (const { platform, externalId } of activePlatforms) {
                try {
                    const action = (platform === 'vr' && vrAction === 'delete') ? 'delete' : 'end';
                    let endpoint;
                    let method = 'POST';
                    let body = {};

                    // Platform-specific endpoints
                    switch(platform) {
                        case 'reverb':
                            endpoint = `/api/reverb/listings/${externalId}/end`;
                            body = { reason: 'not_sold' };
                            break;
                        case 'ebay':
                            endpoint = `/api/ebay/listings/${externalId}/end`;
                            body = { reason: 'NotAvailable' };
                            break;
                        case 'shopify':
                            endpoint = `/api/shopify/products/${externalId}/archive`;
                            break;
                        case 'vr':
                            // For V&R, we need to handle end vs delete differently
                            if (action === 'delete') {
                                endpoint = `/api/vr/listings/${externalId}/delete`;
                            } else {
                                endpoint = `/api/vr/listings/${externalId}/end`;
                            }
                            break;
                        default:
                            console.error(`Unsupported platform: ${platform}`);
                            errorCount++;
                            continue;
                    }

                    const response = await fetch(endpoint, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(body)
                    });

                    if (response.ok) {
                        successCount++;
                    } else {
                        errorCount++;
                        const errorText = await response.text();
                        console.error(`Failed to ${action} ${platform} listing:`, errorText);
                    }
                } catch (error) {
                    console.error(`Error ending ${platform} listing:`, error);
                    errorCount++;
                }
            }

            if (successCount > 0 && errorCount === 0) {
                showMessage('success', `Successfully ended all ${successCount} listings`);
            } else if (successCount > 0 && errorCount > 0) {
                showMessage('warning', `Ended ${successCount} listings, but ${errorCount} failed`);
            } else {
                showMessage('error', `Failed to end listings`);
            }

            // Reload page after 2 seconds
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }
    });
</script>

{% endblock %}