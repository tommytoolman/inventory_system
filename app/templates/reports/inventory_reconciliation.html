{% extends "base.html" %}

{% block title %}Inventory Reconciliation - RIFF{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Inventory Reconciliation</h1>
                <p class="text-gray-600">Reconcile quantities for stocked items across all platforms.</p>
            </div>
            <a href="/reports" class="text-blue-600 hover:text-blue-800">← Back to Reports</a>
        </div>
    </div>

    <!-- Summary Cards (compact) -->
    <div class="flex flex-wrap gap-3 mb-6">
        <div class="bg-white rounded-lg shadow px-4 py-2 flex items-center gap-2">
            <span class="text-xs text-gray-500 uppercase">Total</span>
            <span class="text-lg font-bold text-gray-900">{{ total_count }}</span>
        </div>
        <div class="bg-white rounded-lg shadow px-4 py-2 flex items-center gap-2">
            <span class="text-xs text-gray-500 uppercase">In Sync</span>
            <span class="text-lg font-bold text-green-600">{{ total_count - out_of_sync_count }}</span>
        </div>
        <div class="bg-white rounded-lg shadow px-4 py-2 flex items-center gap-2">
            <span class="text-xs text-gray-500 uppercase">Out of Sync</span>
            <span class="text-lg font-bold {% if out_of_sync_count > 0 %}text-amber-600{% else %}text-gray-400{% endif %}">{{ out_of_sync_count }}</span>
        </div>
    </div>

    <!-- Filter -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="flex items-center gap-4">
            <label class="flex items-center gap-2 text-sm">
                <input type="checkbox" id="show-out-of-sync-only" class="rounded border-gray-300">
                <span>Show out of sync only</span>
            </label>
        </div>
    </div>

    <!-- Items Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100" onclick="sortTable('product')">
                        Product<span class="sort-icon text-gray-600 text-[10px] ml-0.5" data-col="product">⇅</span>
                    </th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100" onclick="sortTable('riff')">
                        <img src="/static/images/riff_logo.png" alt="RIFF" class="w-4 h-4 inline mr-1">RIFF<span class="sort-icon text-gray-600 text-[10px] ml-0.5" data-col="riff">⇅</span>
                    </th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100" onclick="sortTable('reverb')">
                        <img src="https://reverb.com/favicon.ico" alt="Reverb" class="w-4 h-4 inline mr-1">Reverb<span class="sort-icon text-gray-600 text-[10px] ml-0.5" data-col="reverb">⇅</span>
                    </th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100" onclick="sortTable('ebay')">
                        <img src="https://www.ebay.com/favicon.ico" alt="eBay" class="w-4 h-4 inline mr-1">eBay<span class="sort-icon text-gray-600 text-[10px] ml-0.5" data-col="ebay">⇅</span>
                    </th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100" onclick="sortTable('shopify')">
                        <img src="https://www.shopify.com/favicon.ico" alt="Shopify" class="w-4 h-4 inline mr-1">Shopify<span class="sort-icon text-gray-600 text-[10px] ml-0.5" data-col="shopify">⇅</span>
                    </th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">
                        <img src="https://www.vintageandrare.com/favicon.ico" alt="V&R" class="w-4 h-4 inline mr-1">V&R
                    </th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">New Qty</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Action</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for item in items %}
                <tr class="hover:bg-gray-50 {% if not item.is_synced %}bg-amber-50{% endif %}"
                    data-synced="{{ 'true' if item.is_synced else 'false' }}"
                    data-product-id="{{ item.id }}"
                    data-riff-qty="{{ item.riff_qty }}"
                    data-reverb-qty="{{ item.reverb_qty if item.reverb_qty is not none else -1 }}"
                    data-ebay-qty="{{ item.ebay_qty if item.ebay_qty is not none else -1 }}"
                    data-shopify-qty="{{ item.shopify_qty if item.shopify_qty is not none else -1 }}">
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-3">
                            {% if item.primary_image %}
                            <img src="{{ item.primary_image }}" alt="{{ item.title }}" class="w-10 h-10 object-cover rounded">
                            {% else %}
                            <div class="w-10 h-10 bg-gray-200 rounded flex items-center justify-center">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            {% endif %}
                            <div>
                                <a href="/inventory/product/{{ item.id }}" class="text-sm font-medium text-gray-900 hover:text-blue-600">
                                    {{ item.title[:50] }}{% if item.title|length > 50 %}...{% endif %}
                                </a>
                                <div class="text-xs text-gray-500">{{ item.sku }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="text-gray-900">{{ item.riff_qty }}</span>
                        <a href="/inventory/product/{{ item.id }}" target="_blank" class="ml-1 text-gray-400 hover:text-blue-600">
                            <svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                            </svg>
                        </a>
                    </td>
                    <td class="px-4 py-3 text-center">
                        {% if item.reverb_qty is not none %}
                            <span class="{% if item.reverb_qty != item.riff_qty %}text-red-600 font-semibold{% else %}text-green-600{% endif %}">
                                {{ item.reverb_qty }}
                            </span>
                            {% if item.reverb_listing_id %}
                            <a href="https://reverb.com/item/{{ item.reverb_listing_id }}" target="_blank" class="ml-1 text-gray-400 hover:text-blue-600">
                                <svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                </svg>
                            </a>
                            {% endif %}
                        {% else %}
                            <span class="text-gray-400">-</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-center">
                        {% if item.ebay_qty is not none %}
                            <span class="{% if item.ebay_qty != item.riff_qty %}text-red-600 font-semibold{% else %}text-green-600{% endif %}">
                                {{ item.ebay_qty }}
                            </span>
                            {% if item.ebay_item_id %}
                            <a href="https://www.ebay.co.uk/itm/{{ item.ebay_item_id }}" target="_blank" class="ml-1 text-gray-400 hover:text-blue-600">
                                <svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                </svg>
                            </a>
                            {% endif %}
                        {% else %}
                            <span class="text-gray-400">-</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-center">
                        {% if item.shopify_qty is not none %}
                            <span class="{% if item.shopify_qty != item.riff_qty %}text-red-600 font-semibold{% else %}text-green-600{% endif %}">
                                {{ item.shopify_qty }}
                            </span>
                            {% if item.shopify_handle %}
                            <a href="https://londonvintageguitars.myshopify.com/products/{{ item.shopify_handle }}" target="_blank" class="ml-1 text-gray-400 hover:text-blue-600">
                                <svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                </svg>
                            </a>
                            {% endif %}
                        {% elif item.shopify_listed %}
                            <span class="text-green-600">Listed</span>
                        {% else %}
                            <span class="text-gray-400">-</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-center">
                        {% if item.vr_listed %}
                            <span class="text-green-600">Listed</span>
                            {% if item.vr_listing_id %}
                            <a href="https://www.vintageandrare.com/product/{{ item.vr_listing_id }}" target="_blank" class="ml-1 text-gray-400 hover:text-blue-600">
                                <svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                </svg>
                            </a>
                            {% endif %}
                        {% else %}
                            <span class="text-gray-400">-</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-center">
                        <input type="number"
                               id="qty-{{ item.id }}"
                               value="{{ item.riff_qty }}"
                               min="0"
                               class="w-20 px-2 py-1 text-center border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                               data-original="{{ item.riff_qty }}">
                    </td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="reconcileQuantity({{ item.id }}, this)"
                                class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                id="btn-{{ item.id }}">
                            Reconcile
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                        No stocked items found.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
let sortState = { column: null, direction: 'asc' };

document.addEventListener('DOMContentLoaded', function() {
    // Filter toggle
    const filterCheckbox = document.getElementById('show-out-of-sync-only');
    filterCheckbox.addEventListener('change', function() {
        const rows = document.querySelectorAll('tbody tr[data-synced]');
        rows.forEach(row => {
            if (this.checked && row.dataset.synced === 'true') {
                row.style.display = 'none';
            } else {
                row.style.display = '';
            }
        });
    });
});

function sortTable(column) {
    const tbody = document.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr[data-synced]'));

    // Toggle direction if clicking same column
    if (sortState.column === column) {
        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
    } else {
        sortState.column = column;
        sortState.direction = 'asc';
    }

    // Update sort icons
    document.querySelectorAll('.sort-icon').forEach(icon => {
        if (icon.dataset.col === column) {
            icon.textContent = sortState.direction === 'asc' ? '▲' : '▼';
        } else {
            icon.textContent = '⇅';
        }
    });

    rows.sort((a, b) => {
        let aVal, bVal;

        switch (column) {
            case 'product':
                aVal = parseInt(a.dataset.productId);
                bVal = parseInt(b.dataset.productId);
                break;
            case 'riff':
                aVal = parseInt(a.dataset.riffQty);
                bVal = parseInt(b.dataset.riffQty);
                break;
            case 'reverb':
                aVal = parseInt(a.dataset.reverbQty);
                bVal = parseInt(b.dataset.reverbQty);
                break;
            case 'ebay':
                aVal = parseInt(a.dataset.ebayQty);
                bVal = parseInt(b.dataset.ebayQty);
                break;
            case 'shopify':
                aVal = parseInt(a.dataset.shopifyQty);
                bVal = parseInt(b.dataset.shopifyQty);
                break;
            default:
                return 0;
        }

        if (sortState.direction === 'asc') {
            return aVal - bVal;
        } else {
            return bVal - aVal;
        }
    });

    // Re-append rows in sorted order
    rows.forEach(row => tbody.appendChild(row));
}

async function reconcileQuantity(productId, buttonEl) {
    const input = document.getElementById(`qty-${productId}`);
    const newQty = parseInt(input.value, 10);
    const originalQty = parseInt(input.dataset.original, 10);

    if (isNaN(newQty) || newQty < 0) {
        alert('Please enter a valid quantity');
        return;
    }

    // Build list of what's out of sync
    const row = buttonEl.closest('tr');
    const outOfSync = [];

    const reverbQty = parseInt(row.dataset.reverbQty);
    const ebayQty = parseInt(row.dataset.ebayQty);
    const shopifyQty = parseInt(row.dataset.shopifyQty);

    if (reverbQty >= 0 && reverbQty !== newQty) outOfSync.push(`Reverb (${reverbQty})`);
    if (ebayQty >= 0 && ebayQty !== newQty) outOfSync.push(`eBay (${ebayQty})`);
    if (shopifyQty >= 0 && shopifyQty !== newQty) outOfSync.push(`Shopify (${shopifyQty})`);

    // Confirm action with specific details
    if (outOfSync.length === 0 && newQty === originalQty) {
        alert('All platforms already in sync with RIFF.');
        return;
    }

    let confirmMsg = '';
    if (newQty !== originalQty) {
        confirmMsg = `Update RIFF qty from ${originalQty} to ${newQty}`;
        if (outOfSync.length > 0) {
            confirmMsg += ` and sync to: ${outOfSync.join(', ')}`;
        }
    } else if (outOfSync.length > 0) {
        confirmMsg = `Sync qty ${newQty} to: ${outOfSync.join(', ')}`;
    }
    confirmMsg += '?';

    if (!confirm(confirmMsg)) {
        return;
    }

    buttonEl.disabled = true;
    buttonEl.innerHTML = '<svg class="animate-spin h-4 w-4 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

    try {
        const response = await fetch(`/reports/inventory-reconciliation/reconcile/${productId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ quantity: newQty }),
        });

        const result = await response.json();

        if (result.status === 'success') {
            buttonEl.innerHTML = 'Done!';
            buttonEl.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            buttonEl.classList.add('bg-green-600');

            // Reload the page after a brief delay to show updated data
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            alert(`Error: ${result.message}`);
            buttonEl.innerHTML = 'Reconcile';
            buttonEl.disabled = false;
        }
    } catch (error) {
        alert(`Failed to reconcile: ${error.message}`);
        buttonEl.innerHTML = 'Reconcile';
        buttonEl.disabled = false;
    }
}
</script>
{% endblock %}
