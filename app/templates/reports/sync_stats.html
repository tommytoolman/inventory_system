{% extends "base.html" %}

{% block title %}Sync Statistics - RIFF{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Sync Statistics</h1>
        <p class="text-gray-600">Comprehensive platform synchronization performance metrics</p>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <form method="get" class="flex flex-wrap gap-4 items-end">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Platform</label>
                <select name="platform" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    <option value="">All Platforms</option>
                    <option value="reverb" {% if platform_filter == "reverb" %}selected{% endif %}>Reverb</option>
                    <option value="ebay" {% if platform_filter == "ebay" %}selected{% endif %}>eBay</option>
                    <option value="shopify" {% if platform_filter == "shopify" %}selected{% endif %}>Shopify</option>
                    <option value="vr" {% if platform_filter == "vr" %}selected{% endif %}>V&R</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Time Period</label>
                <select name="days" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    <option value="7" {% if days_filter == 7 %}selected{% endif %}>Last 7 days</option>
                    <option value="30" {% if days_filter == 30 %}selected{% endif %}>Last 30 days</option>
                    <option value="90" {% if days_filter == 90 %}selected{% endif %}>Last 90 days</option>
                    <option value="365" {% if days_filter == 365 %}selected{% endif %}>Last year</option>
                </select>
            </div>
            
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                Update
            </button>
        </form>
    </div>

    <!-- Cumulative Statistics -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="px-6 py-4 border-b">
            <h2 class="text-xl font-semibold">Cumulative Statistics</h2>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 p-6">
            <div class="text-center">
                <div class="text-3xl font-bold text-gray-900">{{ "{:,}".format(cumulative_stats.total_events_processed) }}</div>
                <div class="text-sm text-gray-500">Total Events</div>
            </div>
            <div class="text-center">
                <div class="text-3xl font-bold text-green-600">{{ "{:,}".format(cumulative_stats.total_sales) }}</div>
                <div class="text-sm text-gray-500">Total Sales</div>
            </div>
            <div class="text-center">
                <div class="text-3xl font-bold text-blue-600">{{ "{:,}".format(cumulative_stats.total_listings_created) }}</div>
                <div class="text-sm text-gray-500">Listings Created</div>
            </div>
            <div class="text-center">
                <div class="text-3xl font-bold text-red-600">{{ "{:,}".format(cumulative_stats.total_errors) }}</div>
                <div class="text-sm text-gray-500">Total Errors</div>
            </div>
        </div>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 px-6 pb-6">
            <div class="text-center">
                <div class="text-2xl font-semibold text-gray-700">{{ "{:,}".format(cumulative_stats.total_listings_updated) }}</div>
                <div class="text-sm text-gray-500">Updated</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-semibold text-gray-700">{{ "{:,}".format(cumulative_stats.total_listings_removed) }}</div>
                <div class="text-sm text-gray-500">Removed</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-semibold text-green-700">{{ "{:,}".format(cumulative_stats.total_successful_syncs) }}</div>
                <div class="text-sm text-gray-500">Successful Syncs</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-semibold text-orange-700">{{ "{:,}".format(cumulative_stats.total_partial_syncs) }}</div>
                <div class="text-sm text-gray-500">Partial Syncs</div>
            </div>
        </div>
    </div>

    <!-- Daily Trend Chart -->
    {% if daily_stats %}
    <div class="bg-white rounded-lg shadow mb-6 p-6">
        <h2 class="text-xl font-semibold mb-4">Daily Sync Activity</h2>
        <div style="height: 300px;">
            <canvas id="dailyChart"></canvas>
        </div>
    </div>
    {% endif %}

    <!-- Platform Breakdown -->
    {% if platform_breakdown %}
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="px-6 py-4 border-b">
            <h2 class="text-xl font-semibold">Platform Breakdown</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Platform</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Sync Count</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total Events</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total Errors</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Error Rate</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Avg Duration</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for platform in platform_breakdown %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            {{ platform.platform|upper }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">
                            {{ "{:,}".format(platform.sync_count) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">
                            {{ "{:,}".format(platform.total_events or 0) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">
                            {{ "{:,}".format(platform.total_errors or 0) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right">
                            {% set error_rate = (platform.total_errors / platform.total_events * 100) if platform.total_events > 0 else 0 %}
                            <span class="{% if error_rate > 5 %}text-red-600{% elif error_rate > 2 %}text-orange-600{% else %}text-green-600{% endif %}">
                                {{ "{:.1f}%".format(error_rate) }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">
                            {{ "{:.1f}s".format(platform.avg_duration or 0) }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Recent Sync Runs -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b">
            <h2 class="text-xl font-semibold">Recent Sync Runs</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date/Time</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sync Run ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Platform</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Events</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Sales</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Errors</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for run in recent_runs %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ run.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-xs font-mono text-gray-600">
                            {{ (run.sync_run_id[:16] + '...') if run.sync_run_id|length > 16 else run.sync_run_id }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ run.platform|upper if run.platform else 'All' }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">
                            {{ run.run_events_processed }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">
                            {% if run.run_sales > 0 %}
                                <span class="text-green-600 font-semibold">{{ run.run_sales }}</span>
                            {% else %}
                                {{ run.run_sales }}
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">
                            {{ run.run_listings_created }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right">
                            {% if run.run_errors > 0 %}
                                <span class="text-red-600 font-semibold">{{ run.run_errors }}</span>
                            {% else %}
                                <span class="text-green-600">0</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">
                            {{ run.run_duration_seconds }}s
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% if daily_stats %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('dailyChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [{% for stat in daily_stats %}'{{ stat.date }}'{% if not loop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: 'Events',
                data: [{% for stat in daily_stats %}{{ stat.events or 0 }}{% if not loop.last %},{% endif %}{% endfor %}],
                borderColor: 'rgb(59, 130, 246)',
                tension: 0.1
            }, {
                label: 'Sales',
                data: [{% for stat in daily_stats %}{{ stat.sales or 0 }}{% if not loop.last %},{% endif %}{% endfor %}],
                borderColor: 'rgb(34, 197, 94)',
                tension: 0.1
            }, {
                label: 'Errors',
                data: [{% for stat in daily_stats %}{{ stat.errors or 0 }}{% if not loop.last %},{% endif %}{% endfor %}],
                borderColor: 'rgb(239, 68, 68)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
});
</script>
{% endif %}

{% endblock %}