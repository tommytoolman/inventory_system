# Session Handoff ‚Äî 2026-02-14

## What We Achieved

### 1. Shopify DB Consistency Fix
**Files:** `app/services/shopify_service.py`, `app/services/event_processor.py`, `app/routes/inventory.py`

`shopify_service.create_listing_from_product()` was the only platform service that didn't create its own DB rows (`platform_common` + `shopify_listings`). Every caller had to handle this independently, leading to inconsistent state.

**Fix:** Added `_persist_listing_rows()` method to `ShopifyService` (mirrors the VR/eBay/Reverb pattern). All four platforms now guarantee consistent DB state from their service layer. Removed duplicated inline DB creation from `event_processor._create_shopify_listing()` and both `inventory.py` callers. The old `_persist_shopify_listing()` function in `inventory.py` is marked deprecated but retained as reference.

### 2. eBay Ended Items Price Filter
**Files:** `app/services/ebay_service.py`, `app/services/sync_services.py`

Price change detection was creating spurious sync events for ended eBay listings (~54 pending events). The quantity change detection already had an `is_active_listing` filter but price change detection didn't.

**Fix:** Moved the `is_active_listing` check above both price and quantity detection blocks. Also added the same filter to `sync_services.py:_detect_price_changes()`.

### 3. Auto-Processing Sync Events (The Big One)
**Files:** `scripts/run_sync_scheduler.py`, `app/routes/platforms/reverb.py`

Previously, `order_sale` and `status_change` events sat as `pending` in the sync report, requiring manual button clicks to process. Now they auto-process:

#### order_sale events (stocked items)
- In `fetch_reverb_orders()`: after `OrderSaleProcessor` runs, we now also call `create_sync_events_for_stocked_orders()` followed by `process_reconciliation()` to immediately process them
- No double-decrement risk: `create_sync_events_for_stocked_orders` filters on `sale_processed == False`, and `OrderSaleProcessor` sets this to `True` before the events are created

#### status_change events (ended/sold on any platform)
- New shared helper `_auto_process_ended_sold_events()` runs after every platform sync (Reverb, eBay, Shopify, VR)
- Only auto-processes events where `change_data.new` is `ended` or `sold`
- Other status changes (draft‚Üíactive etc.) left for manual review
- Queries ALL pending status_change events (not filtered by sync_run_id) so it catches events from manual UI syncs too
- Also added to `run_reverb_sync_background()` in `app/routes/platforms/reverb.py` so manual syncs from the UI also auto-process

#### What users see now
- Sync events still written to `sync_events` table as audit trail
- Events show as `processed` or `error` instead of `pending`
- Sale alert emails still fire for every sale
- Orders page provides additional visibility
- Filter sync report by `error` status to catch failures

### 4. VR Maintenance Window
**File:** `scripts/run_sync_scheduler.py`

VR sync was failing every night at ~03:00 UTC (V&R site downtime). Added a skip window: VR sync now skips 03:00-05:00 UTC. Next run picks up at 06:00 UTC.

## Commits (in order)
1. `f981f10` ‚Äî Shopify DB consistency + eBay ended items price filter
2. `c5d34b6` ‚Äî Auto-process order_sale and status_change events
3. `d0df4ca` ‚Äî Detailed logging for auto-process flow
4. `6c1cdde` ‚Äî Auto-process from both manual and scheduled syncs + remove sync_run_id filter
5. `63642a8` ‚Äî VR maintenance window skip

## Validated in Production
- Product 577 (Fender Blackguard Telecaster) ended on Reverb ‚Üí auto-processed ‚Üí ended on eBay, Shopify, VR ‚Üí email sent. Full flow working.

## Where to Pick Up Next

### Monitoring (next few days)
- Watch sync events report filtered by `error` status for any auto-processing failures
- Confirm order_sale flow works next time a stocked item sells on Reverb
- Confirm eBay/Shopify/VR status changes also auto-process when items end on those platforms
- Check Railway logs for the `üîç` and `‚ö°` and `‚úÖ` markers to verify auto-processing runs

### User mentioned "Change 3 ‚Äî V&R"
User flagged something about V&R that needs attention ‚Äî they said "V&R if I forget" and that it would jog their memory. Ask about this at the start of next session.

### Remaining high-priority items from todo.md
- Database schema constraints ‚Äî need Alembic migration for NOT NULL on `platform_id` columns
- Shopify-only products image persistence ‚Äî 18 Shopify products without RIFF records creating recurring new_listing events

### Logging cleanup
The detailed `üîç‚ö°‚úÖ‚ùå` logging in `_auto_process_ended_sold_events` and `run_reverb_sync_background` can be toned down once we're confident the flow is stable. Convert to `DEBUG` level or reduce verbosity.
